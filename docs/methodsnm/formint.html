<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.7.0"/>
    <title>methodsnm.formint API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../methodsnm.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;methodsnm</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#FormIntegral">FormIntegral</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#LinearFormIntegral">LinearFormIntegral</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LinearFormIntegral.compute_element_vector">compute_element_vector</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SourceIntegral">SourceIntegral</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SourceIntegral.__init__">SourceIntegral</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceIntegral.coeff">coeff</a>
                        </li>
                        <li>
                                <a class="function" href="#SourceIntegral.compute_element_vector">compute_element_vector</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SUPGSourceIntegral">SUPGSourceIntegral</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SUPGSourceIntegral.__init__">SUPGSourceIntegral</a>
                        </li>
                        <li>
                                <a class="variable" href="#SUPGSourceIntegral.coeff">coeff</a>
                        </li>
                        <li>
                                <a class="variable" href="#SUPGSourceIntegral.wind">wind</a>
                        </li>
                        <li>
                                <a class="function" href="#SUPGSourceIntegral.compute_element_vector">compute_element_vector</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#BilinearFormIntegral">BilinearFormIntegral</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#BilinearFormIntegral.compute_element_matrix">compute_element_matrix</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MassIntegral">MassIntegral</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MassIntegral.__init__">MassIntegral</a>
                        </li>
                        <li>
                                <a class="variable" href="#MassIntegral.coeff">coeff</a>
                        </li>
                        <li>
                                <a class="function" href="#MassIntegral.compute_element_matrix">compute_element_matrix</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LaplaceIntegral">LaplaceIntegral</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LaplaceIntegral.__init__">LaplaceIntegral</a>
                        </li>
                        <li>
                                <a class="variable" href="#LaplaceIntegral.coeff">coeff</a>
                        </li>
                        <li>
                                <a class="function" href="#LaplaceIntegral.compute_element_matrix">compute_element_matrix</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LaplaceIntegral_without_time">LaplaceIntegral_without_time</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LaplaceIntegral_without_time.__init__">LaplaceIntegral_without_time</a>
                        </li>
                        <li>
                                <a class="variable" href="#LaplaceIntegral_without_time.coeff">coeff</a>
                        </li>
                        <li>
                                <a class="function" href="#LaplaceIntegral_without_time.compute_element_matrix">compute_element_matrix</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#TimeIntegral">TimeIntegral</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TimeIntegral.__init__">TimeIntegral</a>
                        </li>
                        <li>
                                <a class="variable" href="#TimeIntegral.coeff">coeff</a>
                        </li>
                        <li>
                                <a class="function" href="#TimeIntegral.compute_element_matrix">compute_element_matrix</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ConvectionIntegral">ConvectionIntegral</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ConvectionIntegral.__init__">ConvectionIntegral</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConvectionIntegral.coeff">coeff</a>
                        </li>
                        <li>
                                <a class="function" href="#ConvectionIntegral.compute_element_matrix">compute_element_matrix</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SUPGIntegral">SUPGIntegral</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SUPGIntegral.__init__">SUPGIntegral</a>
                        </li>
                        <li>
                                <a class="variable" href="#SUPGIntegral.coeff">coeff</a>
                        </li>
                        <li>
                                <a class="function" href="#SUPGIntegral.compute_element_matrix">compute_element_matrix</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DivUQIntegrator">DivUQIntegrator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DivUQIntegrator.__init__">DivUQIntegrator</a>
                        </li>
                        <li>
                                <a class="variable" href="#DivUQIntegrator.coeff">coeff</a>
                        </li>
                        <li>
                                <a class="function" href="#DivUQIntegrator.compute_element_matrix">compute_element_matrix</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DivVPIntegrator">DivVPIntegrator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DivVPIntegrator.__init__">DivVPIntegrator</a>
                        </li>
                        <li>
                                <a class="variable" href="#DivVPIntegrator.coeff">coeff</a>
                        </li>
                        <li>
                                <a class="function" href="#DivVPIntegrator.compute_element_matrix">compute_element_matrix</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#PressureStabilizationIntegral">PressureStabilizationIntegral</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PressureStabilizationIntegral.__init__">PressureStabilizationIntegral</a>
                        </li>
                        <li>
                                <a class="variable" href="#PressureStabilizationIntegral.delta">delta</a>
                        </li>
                        <li>
                                <a class="function" href="#PressureStabilizationIntegral.compute_element_matrix">compute_element_matrix</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../methodsnm.html">methodsnm</a><wbr>.formint    </h1>

                
                        <input id="mod-formint-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-formint-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">sqrt</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span><span class="p">,</span> <span class="n">einsum</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">methodsnm.intrule</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">methodsnm.fe</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numpy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">det</span><span class="p">,</span> <span class="n">inv</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">methodsnm.meshfct</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConstantFunction</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="k">class</span><span class="w"> </span><span class="nc">FormIntegral</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LinearFormIntegral</span><span class="p">(</span><span class="n">FormIntegral</span><span class="p">):</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">):</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the local element vector for a linear form.</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">        Contract: subclasses should implement this method and return the</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">        element load/vector b with components</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">            b_i = \int_K rhs(x) \; \phi_i(x) \; dx</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">        (or a stabilized variant). Implementations may accept an</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">        optional quadrature rule argument (``intrule``) and should</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">        follow the signature used in this module: the finite element</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">        descriptor ``fe`` and a transformation ``trafo`` are passed in</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">        and can be used to evaluate shapes, gradients, and to map</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">        quadrature points to the physical element.</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">        Parameters</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">        ----------</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">        fe : FiniteElement</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">            Finite element descriptor (shape functions, order, etc.).</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">        trafo : object</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">            Transformation object providing Jacobian mapping and mesh</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">            information.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">        Returns</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">        -------</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">        ndarray</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">            Local element vector (length = number of local DOFs).</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SourceIntegral</span><span class="p">(</span><span class="n">LinearFormIntegral</span><span class="p">):</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the element load vector for a source term.</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">            b_i = \int_K f(x) \; \phi_i(x) \; dx</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">        where f(x) is the source coefficient (``self.coeff``) and</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        \phi_i are the test basis functions associated with ``fe``.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">        The method evaluates the shape functions at quadrature points,</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">        evaluates the coefficient at those points (using ``trafo`` to</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">        map to physical coordinates), multiplies by the Jacobian</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">        determinant and quadrature weights, and returns the assembled</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">        local vector.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">        Parameters</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">        ----------</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">        fe : FiniteElement</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">            Finite element descriptor used for the test space.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">        trafo : object</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">            Transformation object providing mapping and Jacobian.</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">            Quadrature rule; if None a rule is chosen based on the</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">            polynomial order.</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">        Returns</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">        -------</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">        ndarray</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">            Local element right-hand-side vector of shape (n_local_dofs,).</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">fe</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="n">shapes</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">*</span><span class="n">c</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">ip</span><span class="p">)))</span> <span class="k">for</span> <span class="n">ip</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span><span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span><span class="n">coeffs</span><span class="p">)]</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">shapes</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>    
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SUPGSourceIntegral</span><span class="p">(</span><span class="n">LinearFormIntegral</span><span class="p">):</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="n">wind</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wind</span> <span class="o">=</span> <span class="n">wind</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the SUPG-stabilized element load vector.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">        This routine computes the streamline-upwind Petrov-Galerkin</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">        stabilization contribution to the right-hand side. The</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">        assembled vector corresponds to the stabilized integral</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">            b_i^{SUPG} = \int_K \gamma_T(x) \, f(x) \, (w(x)\cdot\nabla\phi_i(x)) \; dx</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">        where</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">          - f(x) is the source function (``self.coeff``),</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">          - w(x) is the convective velocity (``self.wind``), and</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">          - \gamma_T is a local stabilization parameter depending on</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">            the element metric and mesh size h.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        Implementation notes:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">          - shape function derivatives are mapped to physical</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">            gradients using the inverse-transpose Jacobian.</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">          - a problem-dimension-dependent mass matrix M is used to</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">            form the tau/gamma_T estimate; the code currently</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">            supports 2D and a 4D hypercube variant.</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">        Parameters</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">        ----------</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">        fe : FiniteElement</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="sd">            Finite element descriptor (must support derivative eval).</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">        trafo : object</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">            Quadrature rule to use; if None a rule is chosen.</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">        Returns</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">        -------</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">        ndarray</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">            Local stabilized element vector of shape (n_local_dofs,).</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">fe</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="k">if</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)]])</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="k">elif</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">**-</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">special_meshsize</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="n">shapes</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="n">cinv</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,jk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="n">expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,nkj-&gt;nik&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">invF</span><span class="p">)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ni,nij,nj-&gt;n&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">wind</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="n">gamma_T</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tau</span> <span class="o">+</span> <span class="p">(</span><span class="n">cinv</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)</span> 
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="n">scale</span> <span class="o">=</span> <span class="n">gamma_T</span> <span class="o">*</span> <span class="n">adetF</span> <span class="o">*</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,n,nj-&gt;j&quot;</span><span class="p">,</span> <span class="n">scale</span> <span class="p">,</span> <span class="n">f</span> <span class="p">,</span> <span class="n">conv</span> <span class="p">)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="k">class</span><span class="w"> </span><span class="nc">BilinearFormIntegral</span><span class="p">(</span><span class="n">FormIntegral</span><span class="p">):</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">):</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MassIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute local mass matrix for an element.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">            M_{ij} = \int_K c(x) \phi_i(x) \phi_j(x) \;dx</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">        where c is the (possibly spatially varying) coefficient,</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="sd">        phi_i are trial basis functions and phi_j are test basis</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a><span class="sd">        functions.</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="sd">        Parameters</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">        ----------</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="sd">        trafo : object</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">            Transformation object providing the Jacobian mapping</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">            reference -&gt; physical element and access to the mesh.</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">            Quadrature rule to use. If None, a rule is selected by</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">            polynomial orders of the elements.</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">        Returns</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">        -------</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">        ndarray</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">            Local element mass matrix of shape (n_test, n_trial).</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ik,i,i,i-&gt;jk&quot;</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LaplaceIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute local stiffness matrix for the Laplace operator.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">            A_{ij} = \int_K c(x) \nabla\phi_i(x) \cdot \nabla\phi_j(x) \;dx</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        This implements mapping of reference gradients to physical</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">        gradients using the element Jacobian and performs quadrature</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">        over the element.</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a><span class="sd">        Parameters</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">        ----------</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        trafo : object</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">            Transformation object providing the Jacobian mapping and</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">            mesh metadata.</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">            Quadrature rule to use. If None, a rule is selected by</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">            polynomial orders of the elements.</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="sd">        Returns</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        -------</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        ndarray</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">            Local element stiffness matrix of shape (n_test, n_trial).</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="n">dshapes_ref_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="n">dshapes_ref_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="n">Jinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="n">grad_test</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_test</span><span class="p">)</span>   <span class="c1"># [n_qp, dim, n_test]</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_trial</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, n_trial]</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="c1">#ret = einsum(&quot;ijk,imn,ijl,iml,i,i,i-&gt;kn&quot;, dshapes_ref_test, dshapes_ref_trial, invF, invF, adetF, coeffs, intrule.weights)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ijl,i,i,i-&gt;kl&quot;</span><span class="p">,</span><span class="n">grad_test</span><span class="p">,</span> <span class="n">grad_trial</span><span class="p">,</span><span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>    
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LaplaceIntegral_without_time</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Laplace-like bilinear form ignoring the last dimension.</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">        This operator is similar to the standard Laplace integral but</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        is constructed to omit the final coordinate (for example to</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        exclude time when assembling spatial diffusion only). The weak</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        form per element K is</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">            A_{ij} = \int_K c(x) \nabla_{x&#39;}\phi_i \cdot \nabla_{x&#39;}\phi_j \;dx</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        where \nabla_{x&#39;} denotes gradient with respect to all but</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">        the last coordinate.</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">        Parameters</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">        ----------</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">        trafo : object</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">        Returns</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">        -------</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">        ndarray</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">            Local element matrix corresponding to the reduced Laplace</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="sd">            bilinear form.</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="n">dshapes_ref_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    <span class="c1"># [n_qp, dim, n_test]</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="n">dshapes_ref_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, n_trial]</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="n">Jinv</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>        <span class="c1"># [n_qp, dim, dim]                              # [n_qp, dim-1, dim]</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>        <span class="n">grad_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_test</span><span class="p">)</span>     <span class="c1"># [n_qp, dim, n_test]</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_trial</span><span class="p">)</span>   <span class="c1"># [n_qp, dim, n_trial]</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>        <span class="n">grad_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">grad_test</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># [n_qp, dim-1, n_test]</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">grad_trial</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># [n_qp, dim-1, n_trial]</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>    <span class="c1"># [n_qp]</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>                <span class="c1"># [n_qp]</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>                                         <span class="c1"># [n_qp]</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ijl,i,i,i-&gt;kl&quot;</span><span class="p">,</span> <span class="n">grad_test</span><span class="p">,</span> <span class="n">grad_trial</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="k">class</span><span class="w"> </span><span class="nc">TimeIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span> <span class="o">=</span> <span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute element matrix for time-derivative coupling.</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="sd">        Implements the bilinear form corresponding to the weak</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="sd">        representation of a time derivative term on the element K:</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="sd">            T_{ij} = \int_K (\partial_t \phi_j) \; \phi_i \; c(x) \;dx</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a><span class="sd">        In the code the trial element shape functions are evaluated</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="sd">        with derivatives and the time-direction derivative is</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="sd">        extracted (typically the last coordinate) then contracted with</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a><span class="sd">        test shapes and quadrature weights.</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a><span class="sd">        Parameters</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a><span class="sd">        ----------</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">        trafo : object</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">            Transformation object providing Jacobian, mesh and mapping</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">            information.</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">        Returns</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="sd">        -------</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">        ndarray</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="sd">            Local element matrix representing the time-derivative</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a><span class="sd">            coupling between trial and test spaces.</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span> 
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        <span class="n">dt_trial</span> <span class="o">=</span> <span class="n">w</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>  
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ik,i,i,i-&gt;kj&quot;</span><span class="p">,</span> <span class="n">dt_trial</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ConvectionIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">))):</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute element matrix for the convection term.</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a><span class="sd">            C_{ij} = \int_K (w(x) \cdot \nabla \phi_j(x)) \; \phi_i(x) \; |\det J| \; dx</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="sd">        where w(x) is the convective velocity provided as `coeff`.</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="sd">        The implementation maps reference gradients to physical</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="sd">        gradients and forms the scalar convective derivative</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">        w \cdot \nabla phi_j which is then multiplied by the test</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="sd">        function and integrated.</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="sd">        Parameters</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">        ----------</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="sd">            Test and trial finite element descriptors.</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">        trafo : object</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">            Transformation providing Jacobians and mesh metadata.</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">        Returns</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="sd">        -------</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">        ndarray</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">            Local convection matrix of shape (n_test, n_trial).</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span> 
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>        <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ik,i,i-&gt;kj&quot;</span><span class="p">,</span> <span class="n">conv</span> <span class="p">,</span> <span class="n">shapes_test</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>   
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SUPGIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">))):</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the SUPG stabilization matrix.</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">        The SUPG (streamline upwind Petrov-Galerkin) stabilization</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">        implemented here computes, per element K, a stabilizing term</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="sd">            S_{ij} = \int_K \gamma_T(x) \; (w\cdot\nabla\phi_i) \; (w\cdot\nabla\phi_j) \; dx</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">        where gamma_T is a stabilization parameter depending on the</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">        local mesh size and the velocity w. The method maps reference</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">        gradients to physical gradients, computes the directional</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        derivatives along w and assembles the weighted inner product.</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">        Parameters</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">        ----------</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">            Test and trial finite element descriptors (both with</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">            derivative evaluations required).</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">        trafo : object</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="sd">            Transformation providing Jacobians and mesh metadata.</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="sd">        Returns</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="sd">        -------</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a><span class="sd">        ndarray</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a><span class="sd">            Local SUPG stabilization matrix of shape (n_test, n_trial).</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="k">if</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)]])</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="k">elif</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">**-</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">special_meshsize</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="n">cinv</span> <span class="o">=</span><span class="mi">1</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,jk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="n">expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,nkj-&gt;nik&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">invF</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ni,nij,nj-&gt;n&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">wind</span><span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="n">gamma_T</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tau</span> <span class="o">+</span> <span class="p">(</span><span class="n">cinv</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="n">grad_u_phys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="n">grad_v_phys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="n">wind_grad_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">grad_u_phys</span><span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="n">wind_grad_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">grad_v_phys</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        <span class="n">scale</span> <span class="o">=</span> <span class="n">gamma_T</span> <span class="o">*</span> <span class="n">adetF</span> <span class="o">*</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>  <span class="c1"># (n,)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,ni,nj-&gt;ij&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">wind_grad_u</span><span class="p">,</span> <span class="n">wind_grad_v</span><span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a><span class="k">class</span><span class="w"> </span><span class="nc">DivUQIntegrator</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble the coupling matrix for div(u) against a scalar test.</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a><span class="sd">            B_{ij} = \int_K q_i(x) \; (\nabla\cdot u_j(x)) \; dx</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a><span class="sd">        Here q_i are scalar (pressure-like) test functions and u_j are</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="sd">        vector-valued trial functions. The implementation computes</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a><span class="sd">        physical gradients, forms the divergence of the vector trial</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a><span class="sd">        basis and integrates against the scalar test basis.</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a><span class="sd">        Parameters</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a><span class="sd">        ----------</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a><span class="sd">        fe_test : FiniteElement</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a><span class="sd">            Scalar test element (q functions).</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a><span class="sd">        fe_trial : FiniteElement</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a><span class="sd">            Vector trial element (u functions) with derivatives.</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a><span class="sd">        trafo : object</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a><span class="sd">        Returns</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">        -------</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a><span class="sd">        ndarray</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">            Local coupling matrix between div(u) and q.</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have same type&quot;</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span><span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>        <span class="n">shapes_q</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>  <span class="c1"># [n_qp, ndof_q]</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>        <span class="n">shapes_u_ref</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, ndof_u]</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>            <span class="c1"># [n_qp, dim, dim]</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="n">grad_u</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_u_ref</span><span class="p">)</span> 
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>        <span class="n">div_u</span> <span class="o">=</span> <span class="n">grad_u</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ik,il,i,i-&gt;kl&quot;</span><span class="p">,</span> <span class="n">shapes_q</span><span class="p">,</span> <span class="n">div_u</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a><span class="k">class</span><span class="w"> </span><span class="nc">DivVPIntegrator</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble coupling matrix for divergence of test velocity with pressure.</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a><span class="sd">            B_{ij} = \int_K (\nabla\cdot v_i(x)) \; p_j(x) \; dx</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a><span class="sd">        This is the transpose-like counterpart to DivUQIntegrator and is</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a><span class="sd">        used when assembling mixed formulations (e.g. velocity-pressure</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a><span class="sd">        coupling in Stokes/NavierStokes). The code computes the</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a><span class="sd">        divergence of (test) vector basis functions and integrates</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a><span class="sd">        against scalar pressure trial basis functions.</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a><span class="sd">        Parameters</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a><span class="sd">        ----------</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a><span class="sd">        fe_test : FiniteElement</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a><span class="sd">            Vector-valued test element (v) with derivative evaluations.</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a><span class="sd">        fe_trial : FiniteElement</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a><span class="sd">            Scalar pressure trial element (p).</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a><span class="sd">        trafo : object</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a><span class="sd">        Returns</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a><span class="sd">        -------</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a><span class="sd">        ndarray</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a><span class="sd">            Local coupling matrix between div(v) and p.</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have same type&quot;</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span><span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>        <span class="n">shapes_v</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span><span class="n">deriv</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [n_qp, ndof_v]</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>        <span class="n">shapes_p</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, ndof_q]</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>            <span class="c1"># [n_qp, dim, dim]</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="n">grad_v</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_v</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, ndof_q]</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>        <span class="n">div_v</span> <span class="o">=</span> <span class="n">grad_v</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [n_qp, ndof_q]</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;il,ik,i,i-&gt;lk&quot;</span><span class="p">,</span>   <span class="n">div_v</span> <span class="p">,</span> <span class="n">shapes_p</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a><span class="k">class</span><span class="w"> </span><span class="nc">PressureStabilizationIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a><span class="sd">    Simple pressure-gradient stabilization:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a><span class="sd">        s(p, q) = delta * (p, q)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>        <span class="c1"># EXACT same structure as LaplaceIntegral_without_time, but with coeff = delta</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>                <span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>                <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>            <span class="p">)</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute pressure stabilization matrix.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a><span class="sd">        Implements s(p,q) = delta * \int_K \nabla p \cdot \nabla q \; dx</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a><span class="sd">        but returns the scaled and (negatively) stabilized version used</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a><span class="sd">        in the code (-h^2 * s(p,q)) where h is the local mesh size.</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a><span class="sd">        Parameters</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a><span class="sd">        ----------</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a><span class="sd">            Scalar finite element descriptors for pressure test and trial.</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a><span class="sd">        trafo : object</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a><span class="sd">            Transformation providing Jacobian and mesh metadata.</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a><span class="sd">        Returns</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a><span class="sd">        -------</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a><span class="sd">        ndarray</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a><span class="sd">            Local stabilization matrix for the pressure space.</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>        <span class="c1"># Values / gradients of basis</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># (n_qp, dim, ndof)</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>        <span class="c1"># Geometry</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="c1"># map reference gradients to physical gradients</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>        <span class="n">grad_test</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">)</span>       <span class="c1"># (n_qp, dim, ndof_test)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span>  
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>        <span class="c1"># contraction:  grad_test  grad_trial * |detJ| * w</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ndk,ndl,n,n-&gt;kl&quot;</span><span class="p">,</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>                                   <span class="n">grad_test</span><span class="p">,</span> <span class="n">grad_trial</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">special_meshsize</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="k">return</span> <span class="o">-</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">ret</span>
</span></pre></div>


            </section>
                <section id="FormIntegral">
                            <input id="FormIntegral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FormIntegral</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="FormIntegral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FormIntegral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FormIntegral-11"><a href="#FormIntegral-11"><span class="linenos">11</span></a><span class="k">class</span><span class="w"> </span><span class="nc">FormIntegral</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="FormIntegral-12"><a href="#FormIntegral-12"><span class="linenos">12</span></a>
</span><span id="FormIntegral-13"><a href="#FormIntegral-13"><span class="linenos">13</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="FormIntegral-14"><a href="#FormIntegral-14"><span class="linenos">14</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="FormIntegral-15"><a href="#FormIntegral-15"><span class="linenos">15</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                </section>
                <section id="LinearFormIntegral">
                            <input id="LinearFormIntegral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LinearFormIntegral</span><wbr>(<span class="base"><a href="#FormIntegral">FormIntegral</a></span>):

                <label class="view-source-button" for="LinearFormIntegral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LinearFormIntegral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LinearFormIntegral-17"><a href="#LinearFormIntegral-17"><span class="linenos">17</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LinearFormIntegral</span><span class="p">(</span><span class="n">FormIntegral</span><span class="p">):</span>
</span><span id="LinearFormIntegral-18"><a href="#LinearFormIntegral-18"><span class="linenos">18</span></a>
</span><span id="LinearFormIntegral-19"><a href="#LinearFormIntegral-19"><span class="linenos">19</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="LinearFormIntegral-20"><a href="#LinearFormIntegral-20"><span class="linenos">20</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LinearFormIntegral-21"><a href="#LinearFormIntegral-21"><span class="linenos">21</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span><span id="LinearFormIntegral-22"><a href="#LinearFormIntegral-22"><span class="linenos">22</span></a>
</span><span id="LinearFormIntegral-23"><a href="#LinearFormIntegral-23"><span class="linenos">23</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">):</span>
</span><span id="LinearFormIntegral-24"><a href="#LinearFormIntegral-24"><span class="linenos">24</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the local element vector for a linear form.</span>
</span><span id="LinearFormIntegral-25"><a href="#LinearFormIntegral-25"><span class="linenos">25</span></a>
</span><span id="LinearFormIntegral-26"><a href="#LinearFormIntegral-26"><span class="linenos">26</span></a><span class="sd">        Contract: subclasses should implement this method and return the</span>
</span><span id="LinearFormIntegral-27"><a href="#LinearFormIntegral-27"><span class="linenos">27</span></a><span class="sd">        element load/vector b with components</span>
</span><span id="LinearFormIntegral-28"><a href="#LinearFormIntegral-28"><span class="linenos">28</span></a><span class="sd">            b_i = \int_K rhs(x) \; \phi_i(x) \; dx</span>
</span><span id="LinearFormIntegral-29"><a href="#LinearFormIntegral-29"><span class="linenos">29</span></a><span class="sd">        (or a stabilized variant). Implementations may accept an</span>
</span><span id="LinearFormIntegral-30"><a href="#LinearFormIntegral-30"><span class="linenos">30</span></a><span class="sd">        optional quadrature rule argument (``intrule``) and should</span>
</span><span id="LinearFormIntegral-31"><a href="#LinearFormIntegral-31"><span class="linenos">31</span></a><span class="sd">        follow the signature used in this module: the finite element</span>
</span><span id="LinearFormIntegral-32"><a href="#LinearFormIntegral-32"><span class="linenos">32</span></a><span class="sd">        descriptor ``fe`` and a transformation ``trafo`` are passed in</span>
</span><span id="LinearFormIntegral-33"><a href="#LinearFormIntegral-33"><span class="linenos">33</span></a><span class="sd">        and can be used to evaluate shapes, gradients, and to map</span>
</span><span id="LinearFormIntegral-34"><a href="#LinearFormIntegral-34"><span class="linenos">34</span></a><span class="sd">        quadrature points to the physical element.</span>
</span><span id="LinearFormIntegral-35"><a href="#LinearFormIntegral-35"><span class="linenos">35</span></a>
</span><span id="LinearFormIntegral-36"><a href="#LinearFormIntegral-36"><span class="linenos">36</span></a><span class="sd">        Parameters</span>
</span><span id="LinearFormIntegral-37"><a href="#LinearFormIntegral-37"><span class="linenos">37</span></a><span class="sd">        ----------</span>
</span><span id="LinearFormIntegral-38"><a href="#LinearFormIntegral-38"><span class="linenos">38</span></a><span class="sd">        fe : FiniteElement</span>
</span><span id="LinearFormIntegral-39"><a href="#LinearFormIntegral-39"><span class="linenos">39</span></a><span class="sd">            Finite element descriptor (shape functions, order, etc.).</span>
</span><span id="LinearFormIntegral-40"><a href="#LinearFormIntegral-40"><span class="linenos">40</span></a><span class="sd">        trafo : object</span>
</span><span id="LinearFormIntegral-41"><a href="#LinearFormIntegral-41"><span class="linenos">41</span></a><span class="sd">            Transformation object providing Jacobian mapping and mesh</span>
</span><span id="LinearFormIntegral-42"><a href="#LinearFormIntegral-42"><span class="linenos">42</span></a><span class="sd">            information.</span>
</span><span id="LinearFormIntegral-43"><a href="#LinearFormIntegral-43"><span class="linenos">43</span></a>
</span><span id="LinearFormIntegral-44"><a href="#LinearFormIntegral-44"><span class="linenos">44</span></a><span class="sd">        Returns</span>
</span><span id="LinearFormIntegral-45"><a href="#LinearFormIntegral-45"><span class="linenos">45</span></a><span class="sd">        -------</span>
</span><span id="LinearFormIntegral-46"><a href="#LinearFormIntegral-46"><span class="linenos">46</span></a><span class="sd">        ndarray</span>
</span><span id="LinearFormIntegral-47"><a href="#LinearFormIntegral-47"><span class="linenos">47</span></a><span class="sd">            Local element vector (length = number of local DOFs).</span>
</span><span id="LinearFormIntegral-48"><a href="#LinearFormIntegral-48"><span class="linenos">48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LinearFormIntegral-49"><a href="#LinearFormIntegral-49"><span class="linenos">49</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="LinearFormIntegral.compute_element_vector" class="classattr">
                                        <input id="LinearFormIntegral.compute_element_vector-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_vector</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe</span>, </span><span class="param"><span class="n">trafo</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LinearFormIntegral.compute_element_vector-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LinearFormIntegral.compute_element_vector"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LinearFormIntegral.compute_element_vector-23"><a href="#LinearFormIntegral.compute_element_vector-23"><span class="linenos">23</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">):</span>
</span><span id="LinearFormIntegral.compute_element_vector-24"><a href="#LinearFormIntegral.compute_element_vector-24"><span class="linenos">24</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the local element vector for a linear form.</span>
</span><span id="LinearFormIntegral.compute_element_vector-25"><a href="#LinearFormIntegral.compute_element_vector-25"><span class="linenos">25</span></a>
</span><span id="LinearFormIntegral.compute_element_vector-26"><a href="#LinearFormIntegral.compute_element_vector-26"><span class="linenos">26</span></a><span class="sd">        Contract: subclasses should implement this method and return the</span>
</span><span id="LinearFormIntegral.compute_element_vector-27"><a href="#LinearFormIntegral.compute_element_vector-27"><span class="linenos">27</span></a><span class="sd">        element load/vector b with components</span>
</span><span id="LinearFormIntegral.compute_element_vector-28"><a href="#LinearFormIntegral.compute_element_vector-28"><span class="linenos">28</span></a><span class="sd">            b_i = \int_K rhs(x) \; \phi_i(x) \; dx</span>
</span><span id="LinearFormIntegral.compute_element_vector-29"><a href="#LinearFormIntegral.compute_element_vector-29"><span class="linenos">29</span></a><span class="sd">        (or a stabilized variant). Implementations may accept an</span>
</span><span id="LinearFormIntegral.compute_element_vector-30"><a href="#LinearFormIntegral.compute_element_vector-30"><span class="linenos">30</span></a><span class="sd">        optional quadrature rule argument (``intrule``) and should</span>
</span><span id="LinearFormIntegral.compute_element_vector-31"><a href="#LinearFormIntegral.compute_element_vector-31"><span class="linenos">31</span></a><span class="sd">        follow the signature used in this module: the finite element</span>
</span><span id="LinearFormIntegral.compute_element_vector-32"><a href="#LinearFormIntegral.compute_element_vector-32"><span class="linenos">32</span></a><span class="sd">        descriptor ``fe`` and a transformation ``trafo`` are passed in</span>
</span><span id="LinearFormIntegral.compute_element_vector-33"><a href="#LinearFormIntegral.compute_element_vector-33"><span class="linenos">33</span></a><span class="sd">        and can be used to evaluate shapes, gradients, and to map</span>
</span><span id="LinearFormIntegral.compute_element_vector-34"><a href="#LinearFormIntegral.compute_element_vector-34"><span class="linenos">34</span></a><span class="sd">        quadrature points to the physical element.</span>
</span><span id="LinearFormIntegral.compute_element_vector-35"><a href="#LinearFormIntegral.compute_element_vector-35"><span class="linenos">35</span></a>
</span><span id="LinearFormIntegral.compute_element_vector-36"><a href="#LinearFormIntegral.compute_element_vector-36"><span class="linenos">36</span></a><span class="sd">        Parameters</span>
</span><span id="LinearFormIntegral.compute_element_vector-37"><a href="#LinearFormIntegral.compute_element_vector-37"><span class="linenos">37</span></a><span class="sd">        ----------</span>
</span><span id="LinearFormIntegral.compute_element_vector-38"><a href="#LinearFormIntegral.compute_element_vector-38"><span class="linenos">38</span></a><span class="sd">        fe : FiniteElement</span>
</span><span id="LinearFormIntegral.compute_element_vector-39"><a href="#LinearFormIntegral.compute_element_vector-39"><span class="linenos">39</span></a><span class="sd">            Finite element descriptor (shape functions, order, etc.).</span>
</span><span id="LinearFormIntegral.compute_element_vector-40"><a href="#LinearFormIntegral.compute_element_vector-40"><span class="linenos">40</span></a><span class="sd">        trafo : object</span>
</span><span id="LinearFormIntegral.compute_element_vector-41"><a href="#LinearFormIntegral.compute_element_vector-41"><span class="linenos">41</span></a><span class="sd">            Transformation object providing Jacobian mapping and mesh</span>
</span><span id="LinearFormIntegral.compute_element_vector-42"><a href="#LinearFormIntegral.compute_element_vector-42"><span class="linenos">42</span></a><span class="sd">            information.</span>
</span><span id="LinearFormIntegral.compute_element_vector-43"><a href="#LinearFormIntegral.compute_element_vector-43"><span class="linenos">43</span></a>
</span><span id="LinearFormIntegral.compute_element_vector-44"><a href="#LinearFormIntegral.compute_element_vector-44"><span class="linenos">44</span></a><span class="sd">        Returns</span>
</span><span id="LinearFormIntegral.compute_element_vector-45"><a href="#LinearFormIntegral.compute_element_vector-45"><span class="linenos">45</span></a><span class="sd">        -------</span>
</span><span id="LinearFormIntegral.compute_element_vector-46"><a href="#LinearFormIntegral.compute_element_vector-46"><span class="linenos">46</span></a><span class="sd">        ndarray</span>
</span><span id="LinearFormIntegral.compute_element_vector-47"><a href="#LinearFormIntegral.compute_element_vector-47"><span class="linenos">47</span></a><span class="sd">            Local element vector (length = number of local DOFs).</span>
</span><span id="LinearFormIntegral.compute_element_vector-48"><a href="#LinearFormIntegral.compute_element_vector-48"><span class="linenos">48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LinearFormIntegral.compute_element_vector-49"><a href="#LinearFormIntegral.compute_element_vector-49"><span class="linenos">49</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute the local element vector for a linear form.</p>

<p>Contract: subclasses should implement this method and return the
element load/vector b with components
    b_i = \int_K rhs(x) \; \phi_i(x) \; dx
(or a stabilized variant). Implementations may accept an
optional quadrature rule argument (<code>intrule</code>) and should
follow the signature used in this module: the finite element
descriptor <code>fe</code> and a transformation <code>trafo</code> are passed in
and can be used to evaluate shapes, gradients, and to map
quadrature points to the physical element.</p>

<h2 id="parameters">Parameters</h2>

<p>fe : FiniteElement
    Finite element descriptor (shape functions, order, etc.).
trafo : object
    Transformation object providing Jacobian mapping and mesh
    information.</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    Local element vector (length = number of local DOFs).</p>
</div>


                            </div>
                </section>
                <section id="SourceIntegral">
                            <input id="SourceIntegral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SourceIntegral</span><wbr>(<span class="base"><a href="#LinearFormIntegral">LinearFormIntegral</a></span>):

                <label class="view-source-button" for="SourceIntegral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SourceIntegral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SourceIntegral-51"><a href="#SourceIntegral-51"><span class="linenos">51</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SourceIntegral</span><span class="p">(</span><span class="n">LinearFormIntegral</span><span class="p">):</span>
</span><span id="SourceIntegral-52"><a href="#SourceIntegral-52"><span class="linenos">52</span></a>
</span><span id="SourceIntegral-53"><a href="#SourceIntegral-53"><span class="linenos">53</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="SourceIntegral-54"><a href="#SourceIntegral-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="SourceIntegral-55"><a href="#SourceIntegral-55"><span class="linenos">55</span></a>
</span><span id="SourceIntegral-56"><a href="#SourceIntegral-56"><span class="linenos">56</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="SourceIntegral-57"><a href="#SourceIntegral-57"><span class="linenos">57</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the element load vector for a source term.</span>
</span><span id="SourceIntegral-58"><a href="#SourceIntegral-58"><span class="linenos">58</span></a>
</span><span id="SourceIntegral-59"><a href="#SourceIntegral-59"><span class="linenos">59</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="SourceIntegral-60"><a href="#SourceIntegral-60"><span class="linenos">60</span></a><span class="sd">            b_i = \int_K f(x) \; \phi_i(x) \; dx</span>
</span><span id="SourceIntegral-61"><a href="#SourceIntegral-61"><span class="linenos">61</span></a>
</span><span id="SourceIntegral-62"><a href="#SourceIntegral-62"><span class="linenos">62</span></a><span class="sd">        where f(x) is the source coefficient (``self.coeff``) and</span>
</span><span id="SourceIntegral-63"><a href="#SourceIntegral-63"><span class="linenos">63</span></a><span class="sd">        \phi_i are the test basis functions associated with ``fe``.</span>
</span><span id="SourceIntegral-64"><a href="#SourceIntegral-64"><span class="linenos">64</span></a><span class="sd">        The method evaluates the shape functions at quadrature points,</span>
</span><span id="SourceIntegral-65"><a href="#SourceIntegral-65"><span class="linenos">65</span></a><span class="sd">        evaluates the coefficient at those points (using ``trafo`` to</span>
</span><span id="SourceIntegral-66"><a href="#SourceIntegral-66"><span class="linenos">66</span></a><span class="sd">        map to physical coordinates), multiplies by the Jacobian</span>
</span><span id="SourceIntegral-67"><a href="#SourceIntegral-67"><span class="linenos">67</span></a><span class="sd">        determinant and quadrature weights, and returns the assembled</span>
</span><span id="SourceIntegral-68"><a href="#SourceIntegral-68"><span class="linenos">68</span></a><span class="sd">        local vector.</span>
</span><span id="SourceIntegral-69"><a href="#SourceIntegral-69"><span class="linenos">69</span></a>
</span><span id="SourceIntegral-70"><a href="#SourceIntegral-70"><span class="linenos">70</span></a><span class="sd">        Parameters</span>
</span><span id="SourceIntegral-71"><a href="#SourceIntegral-71"><span class="linenos">71</span></a><span class="sd">        ----------</span>
</span><span id="SourceIntegral-72"><a href="#SourceIntegral-72"><span class="linenos">72</span></a><span class="sd">        fe : FiniteElement</span>
</span><span id="SourceIntegral-73"><a href="#SourceIntegral-73"><span class="linenos">73</span></a><span class="sd">            Finite element descriptor used for the test space.</span>
</span><span id="SourceIntegral-74"><a href="#SourceIntegral-74"><span class="linenos">74</span></a><span class="sd">        trafo : object</span>
</span><span id="SourceIntegral-75"><a href="#SourceIntegral-75"><span class="linenos">75</span></a><span class="sd">            Transformation object providing mapping and Jacobian.</span>
</span><span id="SourceIntegral-76"><a href="#SourceIntegral-76"><span class="linenos">76</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="SourceIntegral-77"><a href="#SourceIntegral-77"><span class="linenos">77</span></a><span class="sd">            Quadrature rule; if None a rule is chosen based on the</span>
</span><span id="SourceIntegral-78"><a href="#SourceIntegral-78"><span class="linenos">78</span></a><span class="sd">            polynomial order.</span>
</span><span id="SourceIntegral-79"><a href="#SourceIntegral-79"><span class="linenos">79</span></a>
</span><span id="SourceIntegral-80"><a href="#SourceIntegral-80"><span class="linenos">80</span></a><span class="sd">        Returns</span>
</span><span id="SourceIntegral-81"><a href="#SourceIntegral-81"><span class="linenos">81</span></a><span class="sd">        -------</span>
</span><span id="SourceIntegral-82"><a href="#SourceIntegral-82"><span class="linenos">82</span></a><span class="sd">        ndarray</span>
</span><span id="SourceIntegral-83"><a href="#SourceIntegral-83"><span class="linenos">83</span></a><span class="sd">            Local element right-hand-side vector of shape (n_local_dofs,).</span>
</span><span id="SourceIntegral-84"><a href="#SourceIntegral-84"><span class="linenos">84</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SourceIntegral-85"><a href="#SourceIntegral-85"><span class="linenos">85</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SourceIntegral-86"><a href="#SourceIntegral-86"><span class="linenos">86</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">fe</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="SourceIntegral-87"><a href="#SourceIntegral-87"><span class="linenos">87</span></a>        <span class="n">shapes</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="SourceIntegral-88"><a href="#SourceIntegral-88"><span class="linenos">88</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="SourceIntegral-89"><a href="#SourceIntegral-89"><span class="linenos">89</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">*</span><span class="n">c</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">ip</span><span class="p">)))</span> <span class="k">for</span> <span class="n">ip</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span><span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span><span class="n">coeffs</span><span class="p">)]</span>
</span><span id="SourceIntegral-90"><a href="#SourceIntegral-90"><span class="linenos">90</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">shapes</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="SourceIntegral.__init__" class="classattr">
                                        <input id="SourceIntegral.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SourceIntegral</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">coeff</span><span class="o">=&lt;</span><span class="n"><a href="meshfct.html#ConstantFunction">methodsnm.meshfct.ConstantFunction</a></span> <span class="nb">object</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="SourceIntegral.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SourceIntegral.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SourceIntegral.__init__-53"><a href="#SourceIntegral.__init__-53"><span class="linenos">53</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="SourceIntegral.__init__-54"><a href="#SourceIntegral.__init__-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span></pre></div>


    

                            </div>
                            <div id="SourceIntegral.coeff" class="classattr">
                                <div class="attr variable">
            <span class="name">coeff</span>

        
    </div>
    <a class="headerlink" href="#SourceIntegral.coeff"></a>
    
    

                            </div>
                            <div id="SourceIntegral.compute_element_vector" class="classattr">
                                        <input id="SourceIntegral.compute_element_vector-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_vector</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe</span>, </span><span class="param"><span class="n">trafo</span>, </span><span class="param"><span class="n">intrule</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SourceIntegral.compute_element_vector-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SourceIntegral.compute_element_vector"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SourceIntegral.compute_element_vector-56"><a href="#SourceIntegral.compute_element_vector-56"><span class="linenos">56</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="SourceIntegral.compute_element_vector-57"><a href="#SourceIntegral.compute_element_vector-57"><span class="linenos">57</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the element load vector for a source term.</span>
</span><span id="SourceIntegral.compute_element_vector-58"><a href="#SourceIntegral.compute_element_vector-58"><span class="linenos">58</span></a>
</span><span id="SourceIntegral.compute_element_vector-59"><a href="#SourceIntegral.compute_element_vector-59"><span class="linenos">59</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="SourceIntegral.compute_element_vector-60"><a href="#SourceIntegral.compute_element_vector-60"><span class="linenos">60</span></a><span class="sd">            b_i = \int_K f(x) \; \phi_i(x) \; dx</span>
</span><span id="SourceIntegral.compute_element_vector-61"><a href="#SourceIntegral.compute_element_vector-61"><span class="linenos">61</span></a>
</span><span id="SourceIntegral.compute_element_vector-62"><a href="#SourceIntegral.compute_element_vector-62"><span class="linenos">62</span></a><span class="sd">        where f(x) is the source coefficient (``self.coeff``) and</span>
</span><span id="SourceIntegral.compute_element_vector-63"><a href="#SourceIntegral.compute_element_vector-63"><span class="linenos">63</span></a><span class="sd">        \phi_i are the test basis functions associated with ``fe``.</span>
</span><span id="SourceIntegral.compute_element_vector-64"><a href="#SourceIntegral.compute_element_vector-64"><span class="linenos">64</span></a><span class="sd">        The method evaluates the shape functions at quadrature points,</span>
</span><span id="SourceIntegral.compute_element_vector-65"><a href="#SourceIntegral.compute_element_vector-65"><span class="linenos">65</span></a><span class="sd">        evaluates the coefficient at those points (using ``trafo`` to</span>
</span><span id="SourceIntegral.compute_element_vector-66"><a href="#SourceIntegral.compute_element_vector-66"><span class="linenos">66</span></a><span class="sd">        map to physical coordinates), multiplies by the Jacobian</span>
</span><span id="SourceIntegral.compute_element_vector-67"><a href="#SourceIntegral.compute_element_vector-67"><span class="linenos">67</span></a><span class="sd">        determinant and quadrature weights, and returns the assembled</span>
</span><span id="SourceIntegral.compute_element_vector-68"><a href="#SourceIntegral.compute_element_vector-68"><span class="linenos">68</span></a><span class="sd">        local vector.</span>
</span><span id="SourceIntegral.compute_element_vector-69"><a href="#SourceIntegral.compute_element_vector-69"><span class="linenos">69</span></a>
</span><span id="SourceIntegral.compute_element_vector-70"><a href="#SourceIntegral.compute_element_vector-70"><span class="linenos">70</span></a><span class="sd">        Parameters</span>
</span><span id="SourceIntegral.compute_element_vector-71"><a href="#SourceIntegral.compute_element_vector-71"><span class="linenos">71</span></a><span class="sd">        ----------</span>
</span><span id="SourceIntegral.compute_element_vector-72"><a href="#SourceIntegral.compute_element_vector-72"><span class="linenos">72</span></a><span class="sd">        fe : FiniteElement</span>
</span><span id="SourceIntegral.compute_element_vector-73"><a href="#SourceIntegral.compute_element_vector-73"><span class="linenos">73</span></a><span class="sd">            Finite element descriptor used for the test space.</span>
</span><span id="SourceIntegral.compute_element_vector-74"><a href="#SourceIntegral.compute_element_vector-74"><span class="linenos">74</span></a><span class="sd">        trafo : object</span>
</span><span id="SourceIntegral.compute_element_vector-75"><a href="#SourceIntegral.compute_element_vector-75"><span class="linenos">75</span></a><span class="sd">            Transformation object providing mapping and Jacobian.</span>
</span><span id="SourceIntegral.compute_element_vector-76"><a href="#SourceIntegral.compute_element_vector-76"><span class="linenos">76</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="SourceIntegral.compute_element_vector-77"><a href="#SourceIntegral.compute_element_vector-77"><span class="linenos">77</span></a><span class="sd">            Quadrature rule; if None a rule is chosen based on the</span>
</span><span id="SourceIntegral.compute_element_vector-78"><a href="#SourceIntegral.compute_element_vector-78"><span class="linenos">78</span></a><span class="sd">            polynomial order.</span>
</span><span id="SourceIntegral.compute_element_vector-79"><a href="#SourceIntegral.compute_element_vector-79"><span class="linenos">79</span></a>
</span><span id="SourceIntegral.compute_element_vector-80"><a href="#SourceIntegral.compute_element_vector-80"><span class="linenos">80</span></a><span class="sd">        Returns</span>
</span><span id="SourceIntegral.compute_element_vector-81"><a href="#SourceIntegral.compute_element_vector-81"><span class="linenos">81</span></a><span class="sd">        -------</span>
</span><span id="SourceIntegral.compute_element_vector-82"><a href="#SourceIntegral.compute_element_vector-82"><span class="linenos">82</span></a><span class="sd">        ndarray</span>
</span><span id="SourceIntegral.compute_element_vector-83"><a href="#SourceIntegral.compute_element_vector-83"><span class="linenos">83</span></a><span class="sd">            Local element right-hand-side vector of shape (n_local_dofs,).</span>
</span><span id="SourceIntegral.compute_element_vector-84"><a href="#SourceIntegral.compute_element_vector-84"><span class="linenos">84</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SourceIntegral.compute_element_vector-85"><a href="#SourceIntegral.compute_element_vector-85"><span class="linenos">85</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SourceIntegral.compute_element_vector-86"><a href="#SourceIntegral.compute_element_vector-86"><span class="linenos">86</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">fe</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="SourceIntegral.compute_element_vector-87"><a href="#SourceIntegral.compute_element_vector-87"><span class="linenos">87</span></a>        <span class="n">shapes</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="SourceIntegral.compute_element_vector-88"><a href="#SourceIntegral.compute_element_vector-88"><span class="linenos">88</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="SourceIntegral.compute_element_vector-89"><a href="#SourceIntegral.compute_element_vector-89"><span class="linenos">89</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">*</span><span class="n">c</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">ip</span><span class="p">)))</span> <span class="k">for</span> <span class="n">ip</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span><span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span><span class="n">coeffs</span><span class="p">)]</span>
</span><span id="SourceIntegral.compute_element_vector-90"><a href="#SourceIntegral.compute_element_vector-90"><span class="linenos">90</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">shapes</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute the element load vector for a source term.</p>

<p>Weak formulation (element K):
    b_i = \int_K f(x) \; \phi_i(x) \; dx</p>

<p>where f(x) is the source coefficient (<code>self.coeff</code>) and
\phi_i are the test basis functions associated with <code>fe</code>.
The method evaluates the shape functions at quadrature points,
evaluates the coefficient at those points (using <code>trafo</code> to
map to physical coordinates), multiplies by the Jacobian
determinant and quadrature weights, and returns the assembled
local vector.</p>

<h2 id="parameters">Parameters</h2>

<p>fe : FiniteElement
    Finite element descriptor used for the test space.
trafo : object
    Transformation object providing mapping and Jacobian.
intrule : IntegrationRule, optional
    Quadrature rule; if None a rule is chosen based on the
    polynomial order.</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    Local element right-hand-side vector of shape (n_local_dofs,).</p>
</div>


                            </div>
                </section>
                <section id="SUPGSourceIntegral">
                            <input id="SUPGSourceIntegral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SUPGSourceIntegral</span><wbr>(<span class="base"><a href="#LinearFormIntegral">LinearFormIntegral</a></span>):

                <label class="view-source-button" for="SUPGSourceIntegral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SUPGSourceIntegral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SUPGSourceIntegral-92"><a href="#SUPGSourceIntegral-92"><span class="linenos"> 92</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SUPGSourceIntegral</span><span class="p">(</span><span class="n">LinearFormIntegral</span><span class="p">):</span>
</span><span id="SUPGSourceIntegral-93"><a href="#SUPGSourceIntegral-93"><span class="linenos"> 93</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="n">wind</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SUPGSourceIntegral-94"><a href="#SUPGSourceIntegral-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="SUPGSourceIntegral-95"><a href="#SUPGSourceIntegral-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wind</span> <span class="o">=</span> <span class="n">wind</span>
</span><span id="SUPGSourceIntegral-96"><a href="#SUPGSourceIntegral-96"><span class="linenos"> 96</span></a>
</span><span id="SUPGSourceIntegral-97"><a href="#SUPGSourceIntegral-97"><span class="linenos"> 97</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SUPGSourceIntegral-98"><a href="#SUPGSourceIntegral-98"><span class="linenos"> 98</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the SUPG-stabilized element load vector.</span>
</span><span id="SUPGSourceIntegral-99"><a href="#SUPGSourceIntegral-99"><span class="linenos"> 99</span></a>
</span><span id="SUPGSourceIntegral-100"><a href="#SUPGSourceIntegral-100"><span class="linenos">100</span></a><span class="sd">        This routine computes the streamline-upwind Petrov-Galerkin</span>
</span><span id="SUPGSourceIntegral-101"><a href="#SUPGSourceIntegral-101"><span class="linenos">101</span></a><span class="sd">        stabilization contribution to the right-hand side. The</span>
</span><span id="SUPGSourceIntegral-102"><a href="#SUPGSourceIntegral-102"><span class="linenos">102</span></a><span class="sd">        assembled vector corresponds to the stabilized integral</span>
</span><span id="SUPGSourceIntegral-103"><a href="#SUPGSourceIntegral-103"><span class="linenos">103</span></a><span class="sd">            b_i^{SUPG} = \int_K \gamma_T(x) \, f(x) \, (w(x)\cdot\nabla\phi_i(x)) \; dx</span>
</span><span id="SUPGSourceIntegral-104"><a href="#SUPGSourceIntegral-104"><span class="linenos">104</span></a>
</span><span id="SUPGSourceIntegral-105"><a href="#SUPGSourceIntegral-105"><span class="linenos">105</span></a><span class="sd">        where</span>
</span><span id="SUPGSourceIntegral-106"><a href="#SUPGSourceIntegral-106"><span class="linenos">106</span></a><span class="sd">          - f(x) is the source function (``self.coeff``),</span>
</span><span id="SUPGSourceIntegral-107"><a href="#SUPGSourceIntegral-107"><span class="linenos">107</span></a><span class="sd">          - w(x) is the convective velocity (``self.wind``), and</span>
</span><span id="SUPGSourceIntegral-108"><a href="#SUPGSourceIntegral-108"><span class="linenos">108</span></a><span class="sd">          - \gamma_T is a local stabilization parameter depending on</span>
</span><span id="SUPGSourceIntegral-109"><a href="#SUPGSourceIntegral-109"><span class="linenos">109</span></a><span class="sd">            the element metric and mesh size h.</span>
</span><span id="SUPGSourceIntegral-110"><a href="#SUPGSourceIntegral-110"><span class="linenos">110</span></a>
</span><span id="SUPGSourceIntegral-111"><a href="#SUPGSourceIntegral-111"><span class="linenos">111</span></a><span class="sd">        Implementation notes:</span>
</span><span id="SUPGSourceIntegral-112"><a href="#SUPGSourceIntegral-112"><span class="linenos">112</span></a><span class="sd">          - shape function derivatives are mapped to physical</span>
</span><span id="SUPGSourceIntegral-113"><a href="#SUPGSourceIntegral-113"><span class="linenos">113</span></a><span class="sd">            gradients using the inverse-transpose Jacobian.</span>
</span><span id="SUPGSourceIntegral-114"><a href="#SUPGSourceIntegral-114"><span class="linenos">114</span></a><span class="sd">          - a problem-dimension-dependent mass matrix M is used to</span>
</span><span id="SUPGSourceIntegral-115"><a href="#SUPGSourceIntegral-115"><span class="linenos">115</span></a><span class="sd">            form the tau/gamma_T estimate; the code currently</span>
</span><span id="SUPGSourceIntegral-116"><a href="#SUPGSourceIntegral-116"><span class="linenos">116</span></a><span class="sd">            supports 2D and a 4D hypercube variant.</span>
</span><span id="SUPGSourceIntegral-117"><a href="#SUPGSourceIntegral-117"><span class="linenos">117</span></a>
</span><span id="SUPGSourceIntegral-118"><a href="#SUPGSourceIntegral-118"><span class="linenos">118</span></a><span class="sd">        Parameters</span>
</span><span id="SUPGSourceIntegral-119"><a href="#SUPGSourceIntegral-119"><span class="linenos">119</span></a><span class="sd">        ----------</span>
</span><span id="SUPGSourceIntegral-120"><a href="#SUPGSourceIntegral-120"><span class="linenos">120</span></a><span class="sd">        fe : FiniteElement</span>
</span><span id="SUPGSourceIntegral-121"><a href="#SUPGSourceIntegral-121"><span class="linenos">121</span></a><span class="sd">            Finite element descriptor (must support derivative eval).</span>
</span><span id="SUPGSourceIntegral-122"><a href="#SUPGSourceIntegral-122"><span class="linenos">122</span></a><span class="sd">        trafo : object</span>
</span><span id="SUPGSourceIntegral-123"><a href="#SUPGSourceIntegral-123"><span class="linenos">123</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="SUPGSourceIntegral-124"><a href="#SUPGSourceIntegral-124"><span class="linenos">124</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="SUPGSourceIntegral-125"><a href="#SUPGSourceIntegral-125"><span class="linenos">125</span></a><span class="sd">            Quadrature rule to use; if None a rule is chosen.</span>
</span><span id="SUPGSourceIntegral-126"><a href="#SUPGSourceIntegral-126"><span class="linenos">126</span></a>
</span><span id="SUPGSourceIntegral-127"><a href="#SUPGSourceIntegral-127"><span class="linenos">127</span></a><span class="sd">        Returns</span>
</span><span id="SUPGSourceIntegral-128"><a href="#SUPGSourceIntegral-128"><span class="linenos">128</span></a><span class="sd">        -------</span>
</span><span id="SUPGSourceIntegral-129"><a href="#SUPGSourceIntegral-129"><span class="linenos">129</span></a><span class="sd">        ndarray</span>
</span><span id="SUPGSourceIntegral-130"><a href="#SUPGSourceIntegral-130"><span class="linenos">130</span></a><span class="sd">            Local stabilized element vector of shape (n_local_dofs,).</span>
</span><span id="SUPGSourceIntegral-131"><a href="#SUPGSourceIntegral-131"><span class="linenos">131</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SUPGSourceIntegral-132"><a href="#SUPGSourceIntegral-132"><span class="linenos">132</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SUPGSourceIntegral-133"><a href="#SUPGSourceIntegral-133"><span class="linenos">133</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">fe</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral-134"><a href="#SUPGSourceIntegral-134"><span class="linenos">134</span></a>        <span class="k">if</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SUPGSourceIntegral-135"><a href="#SUPGSourceIntegral-135"><span class="linenos">135</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)]])</span>
</span><span id="SUPGSourceIntegral-136"><a href="#SUPGSourceIntegral-136"><span class="linenos">136</span></a>        <span class="k">elif</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="SUPGSourceIntegral-137"><a href="#SUPGSourceIntegral-137"><span class="linenos">137</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">**-</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="SUPGSourceIntegral-138"><a href="#SUPGSourceIntegral-138"><span class="linenos">138</span></a>    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGSourceIntegral-139"><a href="#SUPGSourceIntegral-139"><span class="linenos">139</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGSourceIntegral-140"><a href="#SUPGSourceIntegral-140"><span class="linenos">140</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGSourceIntegral-141"><a href="#SUPGSourceIntegral-141"><span class="linenos">141</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
</span><span id="SUPGSourceIntegral-142"><a href="#SUPGSourceIntegral-142"><span class="linenos">142</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">special_meshsize</span>
</span><span id="SUPGSourceIntegral-143"><a href="#SUPGSourceIntegral-143"><span class="linenos">143</span></a>        <span class="n">shapes</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral-144"><a href="#SUPGSourceIntegral-144"><span class="linenos">144</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral-145"><a href="#SUPGSourceIntegral-145"><span class="linenos">145</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="SUPGSourceIntegral-146"><a href="#SUPGSourceIntegral-146"><span class="linenos">146</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="SUPGSourceIntegral-147"><a href="#SUPGSourceIntegral-147"><span class="linenos">147</span></a>        <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral-148"><a href="#SUPGSourceIntegral-148"><span class="linenos">148</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral-149"><a href="#SUPGSourceIntegral-149"><span class="linenos">149</span></a>        <span class="n">cinv</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SUPGSourceIntegral-150"><a href="#SUPGSourceIntegral-150"><span class="linenos">150</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,jk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral-151"><a href="#SUPGSourceIntegral-151"><span class="linenos">151</span></a>        <span class="n">expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,nkj-&gt;nik&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">invF</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral-152"><a href="#SUPGSourceIntegral-152"><span class="linenos">152</span></a>        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ni,nij,nj-&gt;n&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">wind</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral-153"><a href="#SUPGSourceIntegral-153"><span class="linenos">153</span></a>        <span class="n">gamma_T</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tau</span> <span class="o">+</span> <span class="p">(</span><span class="n">cinv</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral-154"><a href="#SUPGSourceIntegral-154"><span class="linenos">154</span></a>
</span><span id="SUPGSourceIntegral-155"><a href="#SUPGSourceIntegral-155"><span class="linenos">155</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)</span> 
</span><span id="SUPGSourceIntegral-156"><a href="#SUPGSourceIntegral-156"><span class="linenos">156</span></a>        <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral-157"><a href="#SUPGSourceIntegral-157"><span class="linenos">157</span></a>
</span><span id="SUPGSourceIntegral-158"><a href="#SUPGSourceIntegral-158"><span class="linenos">158</span></a>        <span class="n">scale</span> <span class="o">=</span> <span class="n">gamma_T</span> <span class="o">*</span> <span class="n">adetF</span> <span class="o">*</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="SUPGSourceIntegral-159"><a href="#SUPGSourceIntegral-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,n,nj-&gt;j&quot;</span><span class="p">,</span> <span class="n">scale</span> <span class="p">,</span> <span class="n">f</span> <span class="p">,</span> <span class="n">conv</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="SUPGSourceIntegral.__init__" class="classattr">
                                        <input id="SUPGSourceIntegral.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SUPGSourceIntegral</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">f</span><span class="o">=&lt;</span><span class="n"><a href="meshfct.html#ConstantFunction">methodsnm.meshfct.ConstantFunction</a></span> <span class="nb">object</span><span class="o">&gt;</span>, </span><span class="param"><span class="n">wind</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="SUPGSourceIntegral.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SUPGSourceIntegral.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SUPGSourceIntegral.__init__-93"><a href="#SUPGSourceIntegral.__init__-93"><span class="linenos">93</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="n">wind</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SUPGSourceIntegral.__init__-94"><a href="#SUPGSourceIntegral.__init__-94"><span class="linenos">94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="SUPGSourceIntegral.__init__-95"><a href="#SUPGSourceIntegral.__init__-95"><span class="linenos">95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wind</span> <span class="o">=</span> <span class="n">wind</span>
</span></pre></div>


    

                            </div>
                            <div id="SUPGSourceIntegral.coeff" class="classattr">
                                <div class="attr variable">
            <span class="name">coeff</span>

        
    </div>
    <a class="headerlink" href="#SUPGSourceIntegral.coeff"></a>
    
    

                            </div>
                            <div id="SUPGSourceIntegral.wind" class="classattr">
                                <div class="attr variable">
            <span class="name">wind</span>

        
    </div>
    <a class="headerlink" href="#SUPGSourceIntegral.wind"></a>
    
    

                            </div>
                            <div id="SUPGSourceIntegral.compute_element_vector" class="classattr">
                                        <input id="SUPGSourceIntegral.compute_element_vector-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_vector</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe</span>, </span><span class="param"><span class="n">trafo</span>, </span><span class="param"><span class="n">intrule</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SUPGSourceIntegral.compute_element_vector-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SUPGSourceIntegral.compute_element_vector"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SUPGSourceIntegral.compute_element_vector-97"><a href="#SUPGSourceIntegral.compute_element_vector-97"><span class="linenos"> 97</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-98"><a href="#SUPGSourceIntegral.compute_element_vector-98"><span class="linenos"> 98</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the SUPG-stabilized element load vector.</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-99"><a href="#SUPGSourceIntegral.compute_element_vector-99"><span class="linenos"> 99</span></a>
</span><span id="SUPGSourceIntegral.compute_element_vector-100"><a href="#SUPGSourceIntegral.compute_element_vector-100"><span class="linenos">100</span></a><span class="sd">        This routine computes the streamline-upwind Petrov-Galerkin</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-101"><a href="#SUPGSourceIntegral.compute_element_vector-101"><span class="linenos">101</span></a><span class="sd">        stabilization contribution to the right-hand side. The</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-102"><a href="#SUPGSourceIntegral.compute_element_vector-102"><span class="linenos">102</span></a><span class="sd">        assembled vector corresponds to the stabilized integral</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-103"><a href="#SUPGSourceIntegral.compute_element_vector-103"><span class="linenos">103</span></a><span class="sd">            b_i^{SUPG} = \int_K \gamma_T(x) \, f(x) \, (w(x)\cdot\nabla\phi_i(x)) \; dx</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-104"><a href="#SUPGSourceIntegral.compute_element_vector-104"><span class="linenos">104</span></a>
</span><span id="SUPGSourceIntegral.compute_element_vector-105"><a href="#SUPGSourceIntegral.compute_element_vector-105"><span class="linenos">105</span></a><span class="sd">        where</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-106"><a href="#SUPGSourceIntegral.compute_element_vector-106"><span class="linenos">106</span></a><span class="sd">          - f(x) is the source function (``self.coeff``),</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-107"><a href="#SUPGSourceIntegral.compute_element_vector-107"><span class="linenos">107</span></a><span class="sd">          - w(x) is the convective velocity (``self.wind``), and</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-108"><a href="#SUPGSourceIntegral.compute_element_vector-108"><span class="linenos">108</span></a><span class="sd">          - \gamma_T is a local stabilization parameter depending on</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-109"><a href="#SUPGSourceIntegral.compute_element_vector-109"><span class="linenos">109</span></a><span class="sd">            the element metric and mesh size h.</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-110"><a href="#SUPGSourceIntegral.compute_element_vector-110"><span class="linenos">110</span></a>
</span><span id="SUPGSourceIntegral.compute_element_vector-111"><a href="#SUPGSourceIntegral.compute_element_vector-111"><span class="linenos">111</span></a><span class="sd">        Implementation notes:</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-112"><a href="#SUPGSourceIntegral.compute_element_vector-112"><span class="linenos">112</span></a><span class="sd">          - shape function derivatives are mapped to physical</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-113"><a href="#SUPGSourceIntegral.compute_element_vector-113"><span class="linenos">113</span></a><span class="sd">            gradients using the inverse-transpose Jacobian.</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-114"><a href="#SUPGSourceIntegral.compute_element_vector-114"><span class="linenos">114</span></a><span class="sd">          - a problem-dimension-dependent mass matrix M is used to</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-115"><a href="#SUPGSourceIntegral.compute_element_vector-115"><span class="linenos">115</span></a><span class="sd">            form the tau/gamma_T estimate; the code currently</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-116"><a href="#SUPGSourceIntegral.compute_element_vector-116"><span class="linenos">116</span></a><span class="sd">            supports 2D and a 4D hypercube variant.</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-117"><a href="#SUPGSourceIntegral.compute_element_vector-117"><span class="linenos">117</span></a>
</span><span id="SUPGSourceIntegral.compute_element_vector-118"><a href="#SUPGSourceIntegral.compute_element_vector-118"><span class="linenos">118</span></a><span class="sd">        Parameters</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-119"><a href="#SUPGSourceIntegral.compute_element_vector-119"><span class="linenos">119</span></a><span class="sd">        ----------</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-120"><a href="#SUPGSourceIntegral.compute_element_vector-120"><span class="linenos">120</span></a><span class="sd">        fe : FiniteElement</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-121"><a href="#SUPGSourceIntegral.compute_element_vector-121"><span class="linenos">121</span></a><span class="sd">            Finite element descriptor (must support derivative eval).</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-122"><a href="#SUPGSourceIntegral.compute_element_vector-122"><span class="linenos">122</span></a><span class="sd">        trafo : object</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-123"><a href="#SUPGSourceIntegral.compute_element_vector-123"><span class="linenos">123</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-124"><a href="#SUPGSourceIntegral.compute_element_vector-124"><span class="linenos">124</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-125"><a href="#SUPGSourceIntegral.compute_element_vector-125"><span class="linenos">125</span></a><span class="sd">            Quadrature rule to use; if None a rule is chosen.</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-126"><a href="#SUPGSourceIntegral.compute_element_vector-126"><span class="linenos">126</span></a>
</span><span id="SUPGSourceIntegral.compute_element_vector-127"><a href="#SUPGSourceIntegral.compute_element_vector-127"><span class="linenos">127</span></a><span class="sd">        Returns</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-128"><a href="#SUPGSourceIntegral.compute_element_vector-128"><span class="linenos">128</span></a><span class="sd">        -------</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-129"><a href="#SUPGSourceIntegral.compute_element_vector-129"><span class="linenos">129</span></a><span class="sd">        ndarray</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-130"><a href="#SUPGSourceIntegral.compute_element_vector-130"><span class="linenos">130</span></a><span class="sd">            Local stabilized element vector of shape (n_local_dofs,).</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-131"><a href="#SUPGSourceIntegral.compute_element_vector-131"><span class="linenos">131</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-132"><a href="#SUPGSourceIntegral.compute_element_vector-132"><span class="linenos">132</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-133"><a href="#SUPGSourceIntegral.compute_element_vector-133"><span class="linenos">133</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">fe</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-134"><a href="#SUPGSourceIntegral.compute_element_vector-134"><span class="linenos">134</span></a>        <span class="k">if</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-135"><a href="#SUPGSourceIntegral.compute_element_vector-135"><span class="linenos">135</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)]])</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-136"><a href="#SUPGSourceIntegral.compute_element_vector-136"><span class="linenos">136</span></a>        <span class="k">elif</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-137"><a href="#SUPGSourceIntegral.compute_element_vector-137"><span class="linenos">137</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">**-</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-138"><a href="#SUPGSourceIntegral.compute_element_vector-138"><span class="linenos">138</span></a>    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-139"><a href="#SUPGSourceIntegral.compute_element_vector-139"><span class="linenos">139</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-140"><a href="#SUPGSourceIntegral.compute_element_vector-140"><span class="linenos">140</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-141"><a href="#SUPGSourceIntegral.compute_element_vector-141"><span class="linenos">141</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-142"><a href="#SUPGSourceIntegral.compute_element_vector-142"><span class="linenos">142</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">special_meshsize</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-143"><a href="#SUPGSourceIntegral.compute_element_vector-143"><span class="linenos">143</span></a>        <span class="n">shapes</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-144"><a href="#SUPGSourceIntegral.compute_element_vector-144"><span class="linenos">144</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-145"><a href="#SUPGSourceIntegral.compute_element_vector-145"><span class="linenos">145</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-146"><a href="#SUPGSourceIntegral.compute_element_vector-146"><span class="linenos">146</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-147"><a href="#SUPGSourceIntegral.compute_element_vector-147"><span class="linenos">147</span></a>        <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-148"><a href="#SUPGSourceIntegral.compute_element_vector-148"><span class="linenos">148</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-149"><a href="#SUPGSourceIntegral.compute_element_vector-149"><span class="linenos">149</span></a>        <span class="n">cinv</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-150"><a href="#SUPGSourceIntegral.compute_element_vector-150"><span class="linenos">150</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,jk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-151"><a href="#SUPGSourceIntegral.compute_element_vector-151"><span class="linenos">151</span></a>        <span class="n">expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,nkj-&gt;nik&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">invF</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-152"><a href="#SUPGSourceIntegral.compute_element_vector-152"><span class="linenos">152</span></a>        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ni,nij,nj-&gt;n&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">wind</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-153"><a href="#SUPGSourceIntegral.compute_element_vector-153"><span class="linenos">153</span></a>        <span class="n">gamma_T</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tau</span> <span class="o">+</span> <span class="p">(</span><span class="n">cinv</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-154"><a href="#SUPGSourceIntegral.compute_element_vector-154"><span class="linenos">154</span></a>
</span><span id="SUPGSourceIntegral.compute_element_vector-155"><a href="#SUPGSourceIntegral.compute_element_vector-155"><span class="linenos">155</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)</span> 
</span><span id="SUPGSourceIntegral.compute_element_vector-156"><a href="#SUPGSourceIntegral.compute_element_vector-156"><span class="linenos">156</span></a>        <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-157"><a href="#SUPGSourceIntegral.compute_element_vector-157"><span class="linenos">157</span></a>
</span><span id="SUPGSourceIntegral.compute_element_vector-158"><a href="#SUPGSourceIntegral.compute_element_vector-158"><span class="linenos">158</span></a>        <span class="n">scale</span> <span class="o">=</span> <span class="n">gamma_T</span> <span class="o">*</span> <span class="n">adetF</span> <span class="o">*</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="SUPGSourceIntegral.compute_element_vector-159"><a href="#SUPGSourceIntegral.compute_element_vector-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,n,nj-&gt;j&quot;</span><span class="p">,</span> <span class="n">scale</span> <span class="p">,</span> <span class="n">f</span> <span class="p">,</span> <span class="n">conv</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute the SUPG-stabilized element load vector.</p>

<pre><code>    This routine computes the streamline-upwind Petrov-Galerkin
    stabilization contribution to the right-hand side. The
    assembled vector corresponds to the stabilized integral
        b_i^{SUPG} = \int_K \gamma_T(x) \, f(x) \, (w(x)\cdot
</code></pre>

<p>abla\phi_i(x)) \; dx</p>

<pre><code>    where
      - f(x) is the source function (``self.coeff``),
      - w(x) is the convective velocity (``self.wind``), and
      - \gamma_T is a local stabilization parameter depending on
        the element metric and mesh size h.

    Implementation notes:
      - shape function derivatives are mapped to physical
        gradients using the inverse-transpose Jacobian.
      - a problem-dimension-dependent mass matrix M is used to
        form the tau/gamma_T estimate; the code currently
        supports 2D and a 4D hypercube variant.

    Parameters
    ----------
    fe : FiniteElement
        Finite element descriptor (must support derivative eval).
    trafo : object
        Transformation providing Jacobian and mesh information.
    intrule : IntegrationRule, optional
        Quadrature rule to use; if None a rule is chosen.

    Returns
    -------
    ndarray
        Local stabilized element vector of shape (n_local_dofs,).
</code></pre>
</div>


                            </div>
                </section>
                <section id="BilinearFormIntegral">
                            <input id="BilinearFormIntegral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BilinearFormIntegral</span><wbr>(<span class="base"><a href="#FormIntegral">FormIntegral</a></span>):

                <label class="view-source-button" for="BilinearFormIntegral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BilinearFormIntegral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BilinearFormIntegral-161"><a href="#BilinearFormIntegral-161"><span class="linenos">161</span></a><span class="k">class</span><span class="w"> </span><span class="nc">BilinearFormIntegral</span><span class="p">(</span><span class="n">FormIntegral</span><span class="p">):</span>
</span><span id="BilinearFormIntegral-162"><a href="#BilinearFormIntegral-162"><span class="linenos">162</span></a>
</span><span id="BilinearFormIntegral-163"><a href="#BilinearFormIntegral-163"><span class="linenos">163</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BilinearFormIntegral-164"><a href="#BilinearFormIntegral-164"><span class="linenos">164</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BilinearFormIntegral-165"><a href="#BilinearFormIntegral-165"><span class="linenos">165</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span><span id="BilinearFormIntegral-166"><a href="#BilinearFormIntegral-166"><span class="linenos">166</span></a>
</span><span id="BilinearFormIntegral-167"><a href="#BilinearFormIntegral-167"><span class="linenos">167</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">):</span>
</span><span id="BilinearFormIntegral-168"><a href="#BilinearFormIntegral-168"><span class="linenos">168</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="BilinearFormIntegral.compute_element_matrix" class="classattr">
                                        <input id="BilinearFormIntegral.compute_element_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe</span>, </span><span class="param"><span class="n">trafo</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BilinearFormIntegral.compute_element_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BilinearFormIntegral.compute_element_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BilinearFormIntegral.compute_element_matrix-167"><a href="#BilinearFormIntegral.compute_element_matrix-167"><span class="linenos">167</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">trafo</span><span class="p">):</span>
</span><span id="BilinearFormIntegral.compute_element_matrix-168"><a href="#BilinearFormIntegral.compute_element_matrix-168"><span class="linenos">168</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="MassIntegral">
                            <input id="MassIntegral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MassIntegral</span><wbr>(<span class="base"><a href="#BilinearFormIntegral">BilinearFormIntegral</a></span>):

                <label class="view-source-button" for="MassIntegral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MassIntegral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MassIntegral-170"><a href="#MassIntegral-170"><span class="linenos">170</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MassIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="MassIntegral-171"><a href="#MassIntegral-171"><span class="linenos">171</span></a>
</span><span id="MassIntegral-172"><a href="#MassIntegral-172"><span class="linenos">172</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="MassIntegral-173"><a href="#MassIntegral-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="MassIntegral-174"><a href="#MassIntegral-174"><span class="linenos">174</span></a>
</span><span id="MassIntegral-175"><a href="#MassIntegral-175"><span class="linenos">175</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="MassIntegral-176"><a href="#MassIntegral-176"><span class="linenos">176</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute local mass matrix for an element.</span>
</span><span id="MassIntegral-177"><a href="#MassIntegral-177"><span class="linenos">177</span></a>
</span><span id="MassIntegral-178"><a href="#MassIntegral-178"><span class="linenos">178</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="MassIntegral-179"><a href="#MassIntegral-179"><span class="linenos">179</span></a><span class="sd">            M_{ij} = \int_K c(x) \phi_i(x) \phi_j(x) \;dx</span>
</span><span id="MassIntegral-180"><a href="#MassIntegral-180"><span class="linenos">180</span></a>
</span><span id="MassIntegral-181"><a href="#MassIntegral-181"><span class="linenos">181</span></a><span class="sd">        where c is the (possibly spatially varying) coefficient,</span>
</span><span id="MassIntegral-182"><a href="#MassIntegral-182"><span class="linenos">182</span></a><span class="sd">        phi_i are trial basis functions and phi_j are test basis</span>
</span><span id="MassIntegral-183"><a href="#MassIntegral-183"><span class="linenos">183</span></a><span class="sd">        functions.</span>
</span><span id="MassIntegral-184"><a href="#MassIntegral-184"><span class="linenos">184</span></a>
</span><span id="MassIntegral-185"><a href="#MassIntegral-185"><span class="linenos">185</span></a><span class="sd">        Parameters</span>
</span><span id="MassIntegral-186"><a href="#MassIntegral-186"><span class="linenos">186</span></a><span class="sd">        ----------</span>
</span><span id="MassIntegral-187"><a href="#MassIntegral-187"><span class="linenos">187</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="MassIntegral-188"><a href="#MassIntegral-188"><span class="linenos">188</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="MassIntegral-189"><a href="#MassIntegral-189"><span class="linenos">189</span></a><span class="sd">        trafo : object</span>
</span><span id="MassIntegral-190"><a href="#MassIntegral-190"><span class="linenos">190</span></a><span class="sd">            Transformation object providing the Jacobian mapping</span>
</span><span id="MassIntegral-191"><a href="#MassIntegral-191"><span class="linenos">191</span></a><span class="sd">            reference -&gt; physical element and access to the mesh.</span>
</span><span id="MassIntegral-192"><a href="#MassIntegral-192"><span class="linenos">192</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="MassIntegral-193"><a href="#MassIntegral-193"><span class="linenos">193</span></a><span class="sd">            Quadrature rule to use. If None, a rule is selected by</span>
</span><span id="MassIntegral-194"><a href="#MassIntegral-194"><span class="linenos">194</span></a><span class="sd">            polynomial orders of the elements.</span>
</span><span id="MassIntegral-195"><a href="#MassIntegral-195"><span class="linenos">195</span></a>
</span><span id="MassIntegral-196"><a href="#MassIntegral-196"><span class="linenos">196</span></a><span class="sd">        Returns</span>
</span><span id="MassIntegral-197"><a href="#MassIntegral-197"><span class="linenos">197</span></a><span class="sd">        -------</span>
</span><span id="MassIntegral-198"><a href="#MassIntegral-198"><span class="linenos">198</span></a><span class="sd">        ndarray</span>
</span><span id="MassIntegral-199"><a href="#MassIntegral-199"><span class="linenos">199</span></a><span class="sd">            Local element mass matrix of shape (n_test, n_trial).</span>
</span><span id="MassIntegral-200"><a href="#MassIntegral-200"><span class="linenos">200</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MassIntegral-201"><a href="#MassIntegral-201"><span class="linenos">201</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MassIntegral-202"><a href="#MassIntegral-202"><span class="linenos">202</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="MassIntegral-203"><a href="#MassIntegral-203"><span class="linenos">203</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="MassIntegral-204"><a href="#MassIntegral-204"><span class="linenos">204</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="MassIntegral-205"><a href="#MassIntegral-205"><span class="linenos">205</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="MassIntegral-206"><a href="#MassIntegral-206"><span class="linenos">206</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="MassIntegral-207"><a href="#MassIntegral-207"><span class="linenos">207</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="MassIntegral-208"><a href="#MassIntegral-208"><span class="linenos">208</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="MassIntegral-209"><a href="#MassIntegral-209"><span class="linenos">209</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="MassIntegral-210"><a href="#MassIntegral-210"><span class="linenos">210</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ik,i,i,i-&gt;jk&quot;</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="MassIntegral-211"><a href="#MassIntegral-211"><span class="linenos">211</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="MassIntegral.__init__" class="classattr">
                                        <input id="MassIntegral.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MassIntegral</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">coeff</span><span class="o">=&lt;</span><span class="n"><a href="meshfct.html#ConstantFunction">methodsnm.meshfct.ConstantFunction</a></span> <span class="nb">object</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="MassIntegral.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MassIntegral.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MassIntegral.__init__-172"><a href="#MassIntegral.__init__-172"><span class="linenos">172</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="MassIntegral.__init__-173"><a href="#MassIntegral.__init__-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span></pre></div>


    

                            </div>
                            <div id="MassIntegral.coeff" class="classattr">
                                <div class="attr variable">
            <span class="name">coeff</span>

        
    </div>
    <a class="headerlink" href="#MassIntegral.coeff"></a>
    
    

                            </div>
                            <div id="MassIntegral.compute_element_matrix" class="classattr">
                                        <input id="MassIntegral.compute_element_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe_test</span>, </span><span class="param"><span class="n">fe_trial</span>, </span><span class="param"><span class="n">trafo</span>, </span><span class="param"><span class="n">intrule</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MassIntegral.compute_element_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MassIntegral.compute_element_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MassIntegral.compute_element_matrix-175"><a href="#MassIntegral.compute_element_matrix-175"><span class="linenos">175</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="MassIntegral.compute_element_matrix-176"><a href="#MassIntegral.compute_element_matrix-176"><span class="linenos">176</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute local mass matrix for an element.</span>
</span><span id="MassIntegral.compute_element_matrix-177"><a href="#MassIntegral.compute_element_matrix-177"><span class="linenos">177</span></a>
</span><span id="MassIntegral.compute_element_matrix-178"><a href="#MassIntegral.compute_element_matrix-178"><span class="linenos">178</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="MassIntegral.compute_element_matrix-179"><a href="#MassIntegral.compute_element_matrix-179"><span class="linenos">179</span></a><span class="sd">            M_{ij} = \int_K c(x) \phi_i(x) \phi_j(x) \;dx</span>
</span><span id="MassIntegral.compute_element_matrix-180"><a href="#MassIntegral.compute_element_matrix-180"><span class="linenos">180</span></a>
</span><span id="MassIntegral.compute_element_matrix-181"><a href="#MassIntegral.compute_element_matrix-181"><span class="linenos">181</span></a><span class="sd">        where c is the (possibly spatially varying) coefficient,</span>
</span><span id="MassIntegral.compute_element_matrix-182"><a href="#MassIntegral.compute_element_matrix-182"><span class="linenos">182</span></a><span class="sd">        phi_i are trial basis functions and phi_j are test basis</span>
</span><span id="MassIntegral.compute_element_matrix-183"><a href="#MassIntegral.compute_element_matrix-183"><span class="linenos">183</span></a><span class="sd">        functions.</span>
</span><span id="MassIntegral.compute_element_matrix-184"><a href="#MassIntegral.compute_element_matrix-184"><span class="linenos">184</span></a>
</span><span id="MassIntegral.compute_element_matrix-185"><a href="#MassIntegral.compute_element_matrix-185"><span class="linenos">185</span></a><span class="sd">        Parameters</span>
</span><span id="MassIntegral.compute_element_matrix-186"><a href="#MassIntegral.compute_element_matrix-186"><span class="linenos">186</span></a><span class="sd">        ----------</span>
</span><span id="MassIntegral.compute_element_matrix-187"><a href="#MassIntegral.compute_element_matrix-187"><span class="linenos">187</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="MassIntegral.compute_element_matrix-188"><a href="#MassIntegral.compute_element_matrix-188"><span class="linenos">188</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="MassIntegral.compute_element_matrix-189"><a href="#MassIntegral.compute_element_matrix-189"><span class="linenos">189</span></a><span class="sd">        trafo : object</span>
</span><span id="MassIntegral.compute_element_matrix-190"><a href="#MassIntegral.compute_element_matrix-190"><span class="linenos">190</span></a><span class="sd">            Transformation object providing the Jacobian mapping</span>
</span><span id="MassIntegral.compute_element_matrix-191"><a href="#MassIntegral.compute_element_matrix-191"><span class="linenos">191</span></a><span class="sd">            reference -&gt; physical element and access to the mesh.</span>
</span><span id="MassIntegral.compute_element_matrix-192"><a href="#MassIntegral.compute_element_matrix-192"><span class="linenos">192</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="MassIntegral.compute_element_matrix-193"><a href="#MassIntegral.compute_element_matrix-193"><span class="linenos">193</span></a><span class="sd">            Quadrature rule to use. If None, a rule is selected by</span>
</span><span id="MassIntegral.compute_element_matrix-194"><a href="#MassIntegral.compute_element_matrix-194"><span class="linenos">194</span></a><span class="sd">            polynomial orders of the elements.</span>
</span><span id="MassIntegral.compute_element_matrix-195"><a href="#MassIntegral.compute_element_matrix-195"><span class="linenos">195</span></a>
</span><span id="MassIntegral.compute_element_matrix-196"><a href="#MassIntegral.compute_element_matrix-196"><span class="linenos">196</span></a><span class="sd">        Returns</span>
</span><span id="MassIntegral.compute_element_matrix-197"><a href="#MassIntegral.compute_element_matrix-197"><span class="linenos">197</span></a><span class="sd">        -------</span>
</span><span id="MassIntegral.compute_element_matrix-198"><a href="#MassIntegral.compute_element_matrix-198"><span class="linenos">198</span></a><span class="sd">        ndarray</span>
</span><span id="MassIntegral.compute_element_matrix-199"><a href="#MassIntegral.compute_element_matrix-199"><span class="linenos">199</span></a><span class="sd">            Local element mass matrix of shape (n_test, n_trial).</span>
</span><span id="MassIntegral.compute_element_matrix-200"><a href="#MassIntegral.compute_element_matrix-200"><span class="linenos">200</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MassIntegral.compute_element_matrix-201"><a href="#MassIntegral.compute_element_matrix-201"><span class="linenos">201</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MassIntegral.compute_element_matrix-202"><a href="#MassIntegral.compute_element_matrix-202"><span class="linenos">202</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="MassIntegral.compute_element_matrix-203"><a href="#MassIntegral.compute_element_matrix-203"><span class="linenos">203</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="MassIntegral.compute_element_matrix-204"><a href="#MassIntegral.compute_element_matrix-204"><span class="linenos">204</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="MassIntegral.compute_element_matrix-205"><a href="#MassIntegral.compute_element_matrix-205"><span class="linenos">205</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="MassIntegral.compute_element_matrix-206"><a href="#MassIntegral.compute_element_matrix-206"><span class="linenos">206</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="MassIntegral.compute_element_matrix-207"><a href="#MassIntegral.compute_element_matrix-207"><span class="linenos">207</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="MassIntegral.compute_element_matrix-208"><a href="#MassIntegral.compute_element_matrix-208"><span class="linenos">208</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="MassIntegral.compute_element_matrix-209"><a href="#MassIntegral.compute_element_matrix-209"><span class="linenos">209</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="MassIntegral.compute_element_matrix-210"><a href="#MassIntegral.compute_element_matrix-210"><span class="linenos">210</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ik,i,i,i-&gt;jk&quot;</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="MassIntegral.compute_element_matrix-211"><a href="#MassIntegral.compute_element_matrix-211"><span class="linenos">211</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Compute local mass matrix for an element.</p>

<p>Weak formulation (element K):
    M_{ij} = \int_K c(x) \phi_i(x) \phi_j(x) \;dx</p>

<p>where c is the (possibly spatially varying) coefficient,
phi_i are trial basis functions and phi_j are test basis
functions.</p>

<h2 id="parameters">Parameters</h2>

<p>fe_test, fe_trial : FiniteElement
    Finite element descriptors for test and trial spaces.
trafo : object
    Transformation object providing the Jacobian mapping
    reference -> physical element and access to the mesh.
intrule : IntegrationRule, optional
    Quadrature rule to use. If None, a rule is selected by
    polynomial orders of the elements.</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    Local element mass matrix of shape (n_test, n_trial).</p>
</div>


                            </div>
                </section>
                <section id="LaplaceIntegral">
                            <input id="LaplaceIntegral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LaplaceIntegral</span><wbr>(<span class="base"><a href="#BilinearFormIntegral">BilinearFormIntegral</a></span>):

                <label class="view-source-button" for="LaplaceIntegral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LaplaceIntegral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LaplaceIntegral-213"><a href="#LaplaceIntegral-213"><span class="linenos">213</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LaplaceIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="LaplaceIntegral-214"><a href="#LaplaceIntegral-214"><span class="linenos">214</span></a>
</span><span id="LaplaceIntegral-215"><a href="#LaplaceIntegral-215"><span class="linenos">215</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="LaplaceIntegral-216"><a href="#LaplaceIntegral-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="LaplaceIntegral-217"><a href="#LaplaceIntegral-217"><span class="linenos">217</span></a>
</span><span id="LaplaceIntegral-218"><a href="#LaplaceIntegral-218"><span class="linenos">218</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="LaplaceIntegral-219"><a href="#LaplaceIntegral-219"><span class="linenos">219</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute local stiffness matrix for the Laplace operator.</span>
</span><span id="LaplaceIntegral-220"><a href="#LaplaceIntegral-220"><span class="linenos">220</span></a>
</span><span id="LaplaceIntegral-221"><a href="#LaplaceIntegral-221"><span class="linenos">221</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="LaplaceIntegral-222"><a href="#LaplaceIntegral-222"><span class="linenos">222</span></a><span class="sd">            A_{ij} = \int_K c(x) \nabla\phi_i(x) \cdot \nabla\phi_j(x) \;dx</span>
</span><span id="LaplaceIntegral-223"><a href="#LaplaceIntegral-223"><span class="linenos">223</span></a>
</span><span id="LaplaceIntegral-224"><a href="#LaplaceIntegral-224"><span class="linenos">224</span></a><span class="sd">        This implements mapping of reference gradients to physical</span>
</span><span id="LaplaceIntegral-225"><a href="#LaplaceIntegral-225"><span class="linenos">225</span></a><span class="sd">        gradients using the element Jacobian and performs quadrature</span>
</span><span id="LaplaceIntegral-226"><a href="#LaplaceIntegral-226"><span class="linenos">226</span></a><span class="sd">        over the element.</span>
</span><span id="LaplaceIntegral-227"><a href="#LaplaceIntegral-227"><span class="linenos">227</span></a>
</span><span id="LaplaceIntegral-228"><a href="#LaplaceIntegral-228"><span class="linenos">228</span></a><span class="sd">        Parameters</span>
</span><span id="LaplaceIntegral-229"><a href="#LaplaceIntegral-229"><span class="linenos">229</span></a><span class="sd">        ----------</span>
</span><span id="LaplaceIntegral-230"><a href="#LaplaceIntegral-230"><span class="linenos">230</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="LaplaceIntegral-231"><a href="#LaplaceIntegral-231"><span class="linenos">231</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="LaplaceIntegral-232"><a href="#LaplaceIntegral-232"><span class="linenos">232</span></a><span class="sd">        trafo : object</span>
</span><span id="LaplaceIntegral-233"><a href="#LaplaceIntegral-233"><span class="linenos">233</span></a><span class="sd">            Transformation object providing the Jacobian mapping and</span>
</span><span id="LaplaceIntegral-234"><a href="#LaplaceIntegral-234"><span class="linenos">234</span></a><span class="sd">            mesh metadata.</span>
</span><span id="LaplaceIntegral-235"><a href="#LaplaceIntegral-235"><span class="linenos">235</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="LaplaceIntegral-236"><a href="#LaplaceIntegral-236"><span class="linenos">236</span></a><span class="sd">            Quadrature rule to use. If None, a rule is selected by</span>
</span><span id="LaplaceIntegral-237"><a href="#LaplaceIntegral-237"><span class="linenos">237</span></a><span class="sd">            polynomial orders of the elements.</span>
</span><span id="LaplaceIntegral-238"><a href="#LaplaceIntegral-238"><span class="linenos">238</span></a>
</span><span id="LaplaceIntegral-239"><a href="#LaplaceIntegral-239"><span class="linenos">239</span></a><span class="sd">        Returns</span>
</span><span id="LaplaceIntegral-240"><a href="#LaplaceIntegral-240"><span class="linenos">240</span></a><span class="sd">        -------</span>
</span><span id="LaplaceIntegral-241"><a href="#LaplaceIntegral-241"><span class="linenos">241</span></a><span class="sd">        ndarray</span>
</span><span id="LaplaceIntegral-242"><a href="#LaplaceIntegral-242"><span class="linenos">242</span></a><span class="sd">            Local element stiffness matrix of shape (n_test, n_trial).</span>
</span><span id="LaplaceIntegral-243"><a href="#LaplaceIntegral-243"><span class="linenos">243</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LaplaceIntegral-244"><a href="#LaplaceIntegral-244"><span class="linenos">244</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LaplaceIntegral-245"><a href="#LaplaceIntegral-245"><span class="linenos">245</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="LaplaceIntegral-246"><a href="#LaplaceIntegral-246"><span class="linenos">246</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="LaplaceIntegral-247"><a href="#LaplaceIntegral-247"><span class="linenos">247</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="LaplaceIntegral-248"><a href="#LaplaceIntegral-248"><span class="linenos">248</span></a>        <span class="n">dshapes_ref_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LaplaceIntegral-249"><a href="#LaplaceIntegral-249"><span class="linenos">249</span></a>        <span class="n">dshapes_ref_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LaplaceIntegral-250"><a href="#LaplaceIntegral-250"><span class="linenos">250</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="LaplaceIntegral-251"><a href="#LaplaceIntegral-251"><span class="linenos">251</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="LaplaceIntegral-252"><a href="#LaplaceIntegral-252"><span class="linenos">252</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="LaplaceIntegral-253"><a href="#LaplaceIntegral-253"><span class="linenos">253</span></a>        <span class="n">Jinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="LaplaceIntegral-254"><a href="#LaplaceIntegral-254"><span class="linenos">254</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="LaplaceIntegral-255"><a href="#LaplaceIntegral-255"><span class="linenos">255</span></a>        <span class="n">grad_test</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_test</span><span class="p">)</span>   <span class="c1"># [n_qp, dim, n_test]</span>
</span><span id="LaplaceIntegral-256"><a href="#LaplaceIntegral-256"><span class="linenos">256</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_trial</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, n_trial]</span>
</span><span id="LaplaceIntegral-257"><a href="#LaplaceIntegral-257"><span class="linenos">257</span></a>
</span><span id="LaplaceIntegral-258"><a href="#LaplaceIntegral-258"><span class="linenos">258</span></a>        <span class="c1">#ret = einsum(&quot;ijk,imn,ijl,iml,i,i,i-&gt;kn&quot;, dshapes_ref_test, dshapes_ref_trial, invF, invF, adetF, coeffs, intrule.weights)</span>
</span><span id="LaplaceIntegral-259"><a href="#LaplaceIntegral-259"><span class="linenos">259</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ijl,i,i,i-&gt;kl&quot;</span><span class="p">,</span><span class="n">grad_test</span><span class="p">,</span> <span class="n">grad_trial</span><span class="p">,</span><span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="LaplaceIntegral-260"><a href="#LaplaceIntegral-260"><span class="linenos">260</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="LaplaceIntegral.__init__" class="classattr">
                                        <input id="LaplaceIntegral.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LaplaceIntegral</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">coeff</span><span class="o">=&lt;</span><span class="n"><a href="meshfct.html#ConstantFunction">methodsnm.meshfct.ConstantFunction</a></span> <span class="nb">object</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="LaplaceIntegral.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LaplaceIntegral.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LaplaceIntegral.__init__-215"><a href="#LaplaceIntegral.__init__-215"><span class="linenos">215</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="LaplaceIntegral.__init__-216"><a href="#LaplaceIntegral.__init__-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span></pre></div>


    

                            </div>
                            <div id="LaplaceIntegral.coeff" class="classattr">
                                <div class="attr variable">
            <span class="name">coeff</span>

        
    </div>
    <a class="headerlink" href="#LaplaceIntegral.coeff"></a>
    
    

                            </div>
                            <div id="LaplaceIntegral.compute_element_matrix" class="classattr">
                                        <input id="LaplaceIntegral.compute_element_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe_test</span>, </span><span class="param"><span class="n">fe_trial</span>, </span><span class="param"><span class="n">trafo</span>, </span><span class="param"><span class="n">intrule</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LaplaceIntegral.compute_element_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LaplaceIntegral.compute_element_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LaplaceIntegral.compute_element_matrix-218"><a href="#LaplaceIntegral.compute_element_matrix-218"><span class="linenos">218</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="LaplaceIntegral.compute_element_matrix-219"><a href="#LaplaceIntegral.compute_element_matrix-219"><span class="linenos">219</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute local stiffness matrix for the Laplace operator.</span>
</span><span id="LaplaceIntegral.compute_element_matrix-220"><a href="#LaplaceIntegral.compute_element_matrix-220"><span class="linenos">220</span></a>
</span><span id="LaplaceIntegral.compute_element_matrix-221"><a href="#LaplaceIntegral.compute_element_matrix-221"><span class="linenos">221</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="LaplaceIntegral.compute_element_matrix-222"><a href="#LaplaceIntegral.compute_element_matrix-222"><span class="linenos">222</span></a><span class="sd">            A_{ij} = \int_K c(x) \nabla\phi_i(x) \cdot \nabla\phi_j(x) \;dx</span>
</span><span id="LaplaceIntegral.compute_element_matrix-223"><a href="#LaplaceIntegral.compute_element_matrix-223"><span class="linenos">223</span></a>
</span><span id="LaplaceIntegral.compute_element_matrix-224"><a href="#LaplaceIntegral.compute_element_matrix-224"><span class="linenos">224</span></a><span class="sd">        This implements mapping of reference gradients to physical</span>
</span><span id="LaplaceIntegral.compute_element_matrix-225"><a href="#LaplaceIntegral.compute_element_matrix-225"><span class="linenos">225</span></a><span class="sd">        gradients using the element Jacobian and performs quadrature</span>
</span><span id="LaplaceIntegral.compute_element_matrix-226"><a href="#LaplaceIntegral.compute_element_matrix-226"><span class="linenos">226</span></a><span class="sd">        over the element.</span>
</span><span id="LaplaceIntegral.compute_element_matrix-227"><a href="#LaplaceIntegral.compute_element_matrix-227"><span class="linenos">227</span></a>
</span><span id="LaplaceIntegral.compute_element_matrix-228"><a href="#LaplaceIntegral.compute_element_matrix-228"><span class="linenos">228</span></a><span class="sd">        Parameters</span>
</span><span id="LaplaceIntegral.compute_element_matrix-229"><a href="#LaplaceIntegral.compute_element_matrix-229"><span class="linenos">229</span></a><span class="sd">        ----------</span>
</span><span id="LaplaceIntegral.compute_element_matrix-230"><a href="#LaplaceIntegral.compute_element_matrix-230"><span class="linenos">230</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="LaplaceIntegral.compute_element_matrix-231"><a href="#LaplaceIntegral.compute_element_matrix-231"><span class="linenos">231</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="LaplaceIntegral.compute_element_matrix-232"><a href="#LaplaceIntegral.compute_element_matrix-232"><span class="linenos">232</span></a><span class="sd">        trafo : object</span>
</span><span id="LaplaceIntegral.compute_element_matrix-233"><a href="#LaplaceIntegral.compute_element_matrix-233"><span class="linenos">233</span></a><span class="sd">            Transformation object providing the Jacobian mapping and</span>
</span><span id="LaplaceIntegral.compute_element_matrix-234"><a href="#LaplaceIntegral.compute_element_matrix-234"><span class="linenos">234</span></a><span class="sd">            mesh metadata.</span>
</span><span id="LaplaceIntegral.compute_element_matrix-235"><a href="#LaplaceIntegral.compute_element_matrix-235"><span class="linenos">235</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="LaplaceIntegral.compute_element_matrix-236"><a href="#LaplaceIntegral.compute_element_matrix-236"><span class="linenos">236</span></a><span class="sd">            Quadrature rule to use. If None, a rule is selected by</span>
</span><span id="LaplaceIntegral.compute_element_matrix-237"><a href="#LaplaceIntegral.compute_element_matrix-237"><span class="linenos">237</span></a><span class="sd">            polynomial orders of the elements.</span>
</span><span id="LaplaceIntegral.compute_element_matrix-238"><a href="#LaplaceIntegral.compute_element_matrix-238"><span class="linenos">238</span></a>
</span><span id="LaplaceIntegral.compute_element_matrix-239"><a href="#LaplaceIntegral.compute_element_matrix-239"><span class="linenos">239</span></a><span class="sd">        Returns</span>
</span><span id="LaplaceIntegral.compute_element_matrix-240"><a href="#LaplaceIntegral.compute_element_matrix-240"><span class="linenos">240</span></a><span class="sd">        -------</span>
</span><span id="LaplaceIntegral.compute_element_matrix-241"><a href="#LaplaceIntegral.compute_element_matrix-241"><span class="linenos">241</span></a><span class="sd">        ndarray</span>
</span><span id="LaplaceIntegral.compute_element_matrix-242"><a href="#LaplaceIntegral.compute_element_matrix-242"><span class="linenos">242</span></a><span class="sd">            Local element stiffness matrix of shape (n_test, n_trial).</span>
</span><span id="LaplaceIntegral.compute_element_matrix-243"><a href="#LaplaceIntegral.compute_element_matrix-243"><span class="linenos">243</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LaplaceIntegral.compute_element_matrix-244"><a href="#LaplaceIntegral.compute_element_matrix-244"><span class="linenos">244</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LaplaceIntegral.compute_element_matrix-245"><a href="#LaplaceIntegral.compute_element_matrix-245"><span class="linenos">245</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="LaplaceIntegral.compute_element_matrix-246"><a href="#LaplaceIntegral.compute_element_matrix-246"><span class="linenos">246</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="LaplaceIntegral.compute_element_matrix-247"><a href="#LaplaceIntegral.compute_element_matrix-247"><span class="linenos">247</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="LaplaceIntegral.compute_element_matrix-248"><a href="#LaplaceIntegral.compute_element_matrix-248"><span class="linenos">248</span></a>        <span class="n">dshapes_ref_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LaplaceIntegral.compute_element_matrix-249"><a href="#LaplaceIntegral.compute_element_matrix-249"><span class="linenos">249</span></a>        <span class="n">dshapes_ref_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LaplaceIntegral.compute_element_matrix-250"><a href="#LaplaceIntegral.compute_element_matrix-250"><span class="linenos">250</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="LaplaceIntegral.compute_element_matrix-251"><a href="#LaplaceIntegral.compute_element_matrix-251"><span class="linenos">251</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="LaplaceIntegral.compute_element_matrix-252"><a href="#LaplaceIntegral.compute_element_matrix-252"><span class="linenos">252</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="LaplaceIntegral.compute_element_matrix-253"><a href="#LaplaceIntegral.compute_element_matrix-253"><span class="linenos">253</span></a>        <span class="n">Jinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="LaplaceIntegral.compute_element_matrix-254"><a href="#LaplaceIntegral.compute_element_matrix-254"><span class="linenos">254</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="LaplaceIntegral.compute_element_matrix-255"><a href="#LaplaceIntegral.compute_element_matrix-255"><span class="linenos">255</span></a>        <span class="n">grad_test</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_test</span><span class="p">)</span>   <span class="c1"># [n_qp, dim, n_test]</span>
</span><span id="LaplaceIntegral.compute_element_matrix-256"><a href="#LaplaceIntegral.compute_element_matrix-256"><span class="linenos">256</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_trial</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, n_trial]</span>
</span><span id="LaplaceIntegral.compute_element_matrix-257"><a href="#LaplaceIntegral.compute_element_matrix-257"><span class="linenos">257</span></a>
</span><span id="LaplaceIntegral.compute_element_matrix-258"><a href="#LaplaceIntegral.compute_element_matrix-258"><span class="linenos">258</span></a>        <span class="c1">#ret = einsum(&quot;ijk,imn,ijl,iml,i,i,i-&gt;kn&quot;, dshapes_ref_test, dshapes_ref_trial, invF, invF, adetF, coeffs, intrule.weights)</span>
</span><span id="LaplaceIntegral.compute_element_matrix-259"><a href="#LaplaceIntegral.compute_element_matrix-259"><span class="linenos">259</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ijl,i,i,i-&gt;kl&quot;</span><span class="p">,</span><span class="n">grad_test</span><span class="p">,</span> <span class="n">grad_trial</span><span class="p">,</span><span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="LaplaceIntegral.compute_element_matrix-260"><a href="#LaplaceIntegral.compute_element_matrix-260"><span class="linenos">260</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Compute local stiffness matrix for the Laplace operator.</p>

<pre><code>    Weak formulation (element K):
        A_{ij} = \int_K c(x)
</code></pre>

<p>abla\phi_i(x) \cdot 
abla\phi_j(x) \;dx</p>

<pre><code>    This implements mapping of reference gradients to physical
    gradients using the element Jacobian and performs quadrature
    over the element.

    Parameters
    ----------
    fe_test, fe_trial : FiniteElement
        Finite element descriptors for test and trial spaces.
    trafo : object
        Transformation object providing the Jacobian mapping and
        mesh metadata.
    intrule : IntegrationRule, optional
        Quadrature rule to use. If None, a rule is selected by
        polynomial orders of the elements.

    Returns
    -------
    ndarray
        Local element stiffness matrix of shape (n_test, n_trial).
</code></pre>
</div>


                            </div>
                </section>
                <section id="LaplaceIntegral_without_time">
                            <input id="LaplaceIntegral_without_time-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LaplaceIntegral_without_time</span><wbr>(<span class="base"><a href="#BilinearFormIntegral">BilinearFormIntegral</a></span>):

                <label class="view-source-button" for="LaplaceIntegral_without_time-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LaplaceIntegral_without_time"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LaplaceIntegral_without_time-262"><a href="#LaplaceIntegral_without_time-262"><span class="linenos">262</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LaplaceIntegral_without_time</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="LaplaceIntegral_without_time-263"><a href="#LaplaceIntegral_without_time-263"><span class="linenos">263</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="LaplaceIntegral_without_time-264"><a href="#LaplaceIntegral_without_time-264"><span class="linenos">264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="LaplaceIntegral_without_time-265"><a href="#LaplaceIntegral_without_time-265"><span class="linenos">265</span></a>
</span><span id="LaplaceIntegral_without_time-266"><a href="#LaplaceIntegral_without_time-266"><span class="linenos">266</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="LaplaceIntegral_without_time-267"><a href="#LaplaceIntegral_without_time-267"><span class="linenos">267</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Laplace-like bilinear form ignoring the last dimension.</span>
</span><span id="LaplaceIntegral_without_time-268"><a href="#LaplaceIntegral_without_time-268"><span class="linenos">268</span></a>
</span><span id="LaplaceIntegral_without_time-269"><a href="#LaplaceIntegral_without_time-269"><span class="linenos">269</span></a><span class="sd">        This operator is similar to the standard Laplace integral but</span>
</span><span id="LaplaceIntegral_without_time-270"><a href="#LaplaceIntegral_without_time-270"><span class="linenos">270</span></a><span class="sd">        is constructed to omit the final coordinate (for example to</span>
</span><span id="LaplaceIntegral_without_time-271"><a href="#LaplaceIntegral_without_time-271"><span class="linenos">271</span></a><span class="sd">        exclude time when assembling spatial diffusion only). The weak</span>
</span><span id="LaplaceIntegral_without_time-272"><a href="#LaplaceIntegral_without_time-272"><span class="linenos">272</span></a><span class="sd">        form per element K is</span>
</span><span id="LaplaceIntegral_without_time-273"><a href="#LaplaceIntegral_without_time-273"><span class="linenos">273</span></a><span class="sd">            A_{ij} = \int_K c(x) \nabla_{x&#39;}\phi_i \cdot \nabla_{x&#39;}\phi_j \;dx</span>
</span><span id="LaplaceIntegral_without_time-274"><a href="#LaplaceIntegral_without_time-274"><span class="linenos">274</span></a>
</span><span id="LaplaceIntegral_without_time-275"><a href="#LaplaceIntegral_without_time-275"><span class="linenos">275</span></a><span class="sd">        where \nabla_{x&#39;} denotes gradient with respect to all but</span>
</span><span id="LaplaceIntegral_without_time-276"><a href="#LaplaceIntegral_without_time-276"><span class="linenos">276</span></a><span class="sd">        the last coordinate.</span>
</span><span id="LaplaceIntegral_without_time-277"><a href="#LaplaceIntegral_without_time-277"><span class="linenos">277</span></a>
</span><span id="LaplaceIntegral_without_time-278"><a href="#LaplaceIntegral_without_time-278"><span class="linenos">278</span></a><span class="sd">        Parameters</span>
</span><span id="LaplaceIntegral_without_time-279"><a href="#LaplaceIntegral_without_time-279"><span class="linenos">279</span></a><span class="sd">        ----------</span>
</span><span id="LaplaceIntegral_without_time-280"><a href="#LaplaceIntegral_without_time-280"><span class="linenos">280</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="LaplaceIntegral_without_time-281"><a href="#LaplaceIntegral_without_time-281"><span class="linenos">281</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="LaplaceIntegral_without_time-282"><a href="#LaplaceIntegral_without_time-282"><span class="linenos">282</span></a><span class="sd">        trafo : object</span>
</span><span id="LaplaceIntegral_without_time-283"><a href="#LaplaceIntegral_without_time-283"><span class="linenos">283</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="LaplaceIntegral_without_time-284"><a href="#LaplaceIntegral_without_time-284"><span class="linenos">284</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="LaplaceIntegral_without_time-285"><a href="#LaplaceIntegral_without_time-285"><span class="linenos">285</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="LaplaceIntegral_without_time-286"><a href="#LaplaceIntegral_without_time-286"><span class="linenos">286</span></a>
</span><span id="LaplaceIntegral_without_time-287"><a href="#LaplaceIntegral_without_time-287"><span class="linenos">287</span></a><span class="sd">        Returns</span>
</span><span id="LaplaceIntegral_without_time-288"><a href="#LaplaceIntegral_without_time-288"><span class="linenos">288</span></a><span class="sd">        -------</span>
</span><span id="LaplaceIntegral_without_time-289"><a href="#LaplaceIntegral_without_time-289"><span class="linenos">289</span></a><span class="sd">        ndarray</span>
</span><span id="LaplaceIntegral_without_time-290"><a href="#LaplaceIntegral_without_time-290"><span class="linenos">290</span></a><span class="sd">            Local element matrix corresponding to the reduced Laplace</span>
</span><span id="LaplaceIntegral_without_time-291"><a href="#LaplaceIntegral_without_time-291"><span class="linenos">291</span></a><span class="sd">            bilinear form.</span>
</span><span id="LaplaceIntegral_without_time-292"><a href="#LaplaceIntegral_without_time-292"><span class="linenos">292</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LaplaceIntegral_without_time-293"><a href="#LaplaceIntegral_without_time-293"><span class="linenos">293</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LaplaceIntegral_without_time-294"><a href="#LaplaceIntegral_without_time-294"><span class="linenos">294</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="LaplaceIntegral_without_time-295"><a href="#LaplaceIntegral_without_time-295"><span class="linenos">295</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="LaplaceIntegral_without_time-296"><a href="#LaplaceIntegral_without_time-296"><span class="linenos">296</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="LaplaceIntegral_without_time-297"><a href="#LaplaceIntegral_without_time-297"><span class="linenos">297</span></a>
</span><span id="LaplaceIntegral_without_time-298"><a href="#LaplaceIntegral_without_time-298"><span class="linenos">298</span></a>        <span class="n">dshapes_ref_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    <span class="c1"># [n_qp, dim, n_test]</span>
</span><span id="LaplaceIntegral_without_time-299"><a href="#LaplaceIntegral_without_time-299"><span class="linenos">299</span></a>        <span class="n">dshapes_ref_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, n_trial]</span>
</span><span id="LaplaceIntegral_without_time-300"><a href="#LaplaceIntegral_without_time-300"><span class="linenos">300</span></a>
</span><span id="LaplaceIntegral_without_time-301"><a href="#LaplaceIntegral_without_time-301"><span class="linenos">301</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="LaplaceIntegral_without_time-302"><a href="#LaplaceIntegral_without_time-302"><span class="linenos">302</span></a>        <span class="n">Jinv</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>        <span class="c1"># [n_qp, dim, dim]                              # [n_qp, dim-1, dim]</span>
</span><span id="LaplaceIntegral_without_time-303"><a href="#LaplaceIntegral_without_time-303"><span class="linenos">303</span></a>        
</span><span id="LaplaceIntegral_without_time-304"><a href="#LaplaceIntegral_without_time-304"><span class="linenos">304</span></a>        <span class="n">grad_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_test</span><span class="p">)</span>     <span class="c1"># [n_qp, dim, n_test]</span>
</span><span id="LaplaceIntegral_without_time-305"><a href="#LaplaceIntegral_without_time-305"><span class="linenos">305</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_trial</span><span class="p">)</span>   <span class="c1"># [n_qp, dim, n_trial]</span>
</span><span id="LaplaceIntegral_without_time-306"><a href="#LaplaceIntegral_without_time-306"><span class="linenos">306</span></a>
</span><span id="LaplaceIntegral_without_time-307"><a href="#LaplaceIntegral_without_time-307"><span class="linenos">307</span></a>        <span class="n">grad_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">grad_test</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># [n_qp, dim-1, n_test]</span>
</span><span id="LaplaceIntegral_without_time-308"><a href="#LaplaceIntegral_without_time-308"><span class="linenos">308</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">grad_trial</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># [n_qp, dim-1, n_trial]</span>
</span><span id="LaplaceIntegral_without_time-309"><a href="#LaplaceIntegral_without_time-309"><span class="linenos">309</span></a>
</span><span id="LaplaceIntegral_without_time-310"><a href="#LaplaceIntegral_without_time-310"><span class="linenos">310</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>    <span class="c1"># [n_qp]</span>
</span><span id="LaplaceIntegral_without_time-311"><a href="#LaplaceIntegral_without_time-311"><span class="linenos">311</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>                <span class="c1"># [n_qp]</span>
</span><span id="LaplaceIntegral_without_time-312"><a href="#LaplaceIntegral_without_time-312"><span class="linenos">312</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>                                         <span class="c1"># [n_qp]</span>
</span><span id="LaplaceIntegral_without_time-313"><a href="#LaplaceIntegral_without_time-313"><span class="linenos">313</span></a>
</span><span id="LaplaceIntegral_without_time-314"><a href="#LaplaceIntegral_without_time-314"><span class="linenos">314</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ijl,i,i,i-&gt;kl&quot;</span><span class="p">,</span> <span class="n">grad_test</span><span class="p">,</span> <span class="n">grad_trial</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="LaplaceIntegral_without_time-315"><a href="#LaplaceIntegral_without_time-315"><span class="linenos">315</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="LaplaceIntegral_without_time.__init__" class="classattr">
                                        <input id="LaplaceIntegral_without_time.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LaplaceIntegral_without_time</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">coeff</span><span class="o">=&lt;</span><span class="n"><a href="meshfct.html#ConstantFunction">methodsnm.meshfct.ConstantFunction</a></span> <span class="nb">object</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="LaplaceIntegral_without_time.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LaplaceIntegral_without_time.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LaplaceIntegral_without_time.__init__-263"><a href="#LaplaceIntegral_without_time.__init__-263"><span class="linenos">263</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="LaplaceIntegral_without_time.__init__-264"><a href="#LaplaceIntegral_without_time.__init__-264"><span class="linenos">264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span></pre></div>


    

                            </div>
                            <div id="LaplaceIntegral_without_time.coeff" class="classattr">
                                <div class="attr variable">
            <span class="name">coeff</span>

        
    </div>
    <a class="headerlink" href="#LaplaceIntegral_without_time.coeff"></a>
    
    

                            </div>
                            <div id="LaplaceIntegral_without_time.compute_element_matrix" class="classattr">
                                        <input id="LaplaceIntegral_without_time.compute_element_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe_test</span>, </span><span class="param"><span class="n">fe_trial</span>, </span><span class="param"><span class="n">trafo</span>, </span><span class="param"><span class="n">intrule</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LaplaceIntegral_without_time.compute_element_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LaplaceIntegral_without_time.compute_element_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LaplaceIntegral_without_time.compute_element_matrix-266"><a href="#LaplaceIntegral_without_time.compute_element_matrix-266"><span class="linenos">266</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-267"><a href="#LaplaceIntegral_without_time.compute_element_matrix-267"><span class="linenos">267</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Laplace-like bilinear form ignoring the last dimension.</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-268"><a href="#LaplaceIntegral_without_time.compute_element_matrix-268"><span class="linenos">268</span></a>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-269"><a href="#LaplaceIntegral_without_time.compute_element_matrix-269"><span class="linenos">269</span></a><span class="sd">        This operator is similar to the standard Laplace integral but</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-270"><a href="#LaplaceIntegral_without_time.compute_element_matrix-270"><span class="linenos">270</span></a><span class="sd">        is constructed to omit the final coordinate (for example to</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-271"><a href="#LaplaceIntegral_without_time.compute_element_matrix-271"><span class="linenos">271</span></a><span class="sd">        exclude time when assembling spatial diffusion only). The weak</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-272"><a href="#LaplaceIntegral_without_time.compute_element_matrix-272"><span class="linenos">272</span></a><span class="sd">        form per element K is</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-273"><a href="#LaplaceIntegral_without_time.compute_element_matrix-273"><span class="linenos">273</span></a><span class="sd">            A_{ij} = \int_K c(x) \nabla_{x&#39;}\phi_i \cdot \nabla_{x&#39;}\phi_j \;dx</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-274"><a href="#LaplaceIntegral_without_time.compute_element_matrix-274"><span class="linenos">274</span></a>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-275"><a href="#LaplaceIntegral_without_time.compute_element_matrix-275"><span class="linenos">275</span></a><span class="sd">        where \nabla_{x&#39;} denotes gradient with respect to all but</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-276"><a href="#LaplaceIntegral_without_time.compute_element_matrix-276"><span class="linenos">276</span></a><span class="sd">        the last coordinate.</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-277"><a href="#LaplaceIntegral_without_time.compute_element_matrix-277"><span class="linenos">277</span></a>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-278"><a href="#LaplaceIntegral_without_time.compute_element_matrix-278"><span class="linenos">278</span></a><span class="sd">        Parameters</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-279"><a href="#LaplaceIntegral_without_time.compute_element_matrix-279"><span class="linenos">279</span></a><span class="sd">        ----------</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-280"><a href="#LaplaceIntegral_without_time.compute_element_matrix-280"><span class="linenos">280</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-281"><a href="#LaplaceIntegral_without_time.compute_element_matrix-281"><span class="linenos">281</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-282"><a href="#LaplaceIntegral_without_time.compute_element_matrix-282"><span class="linenos">282</span></a><span class="sd">        trafo : object</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-283"><a href="#LaplaceIntegral_without_time.compute_element_matrix-283"><span class="linenos">283</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-284"><a href="#LaplaceIntegral_without_time.compute_element_matrix-284"><span class="linenos">284</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-285"><a href="#LaplaceIntegral_without_time.compute_element_matrix-285"><span class="linenos">285</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-286"><a href="#LaplaceIntegral_without_time.compute_element_matrix-286"><span class="linenos">286</span></a>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-287"><a href="#LaplaceIntegral_without_time.compute_element_matrix-287"><span class="linenos">287</span></a><span class="sd">        Returns</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-288"><a href="#LaplaceIntegral_without_time.compute_element_matrix-288"><span class="linenos">288</span></a><span class="sd">        -------</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-289"><a href="#LaplaceIntegral_without_time.compute_element_matrix-289"><span class="linenos">289</span></a><span class="sd">        ndarray</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-290"><a href="#LaplaceIntegral_without_time.compute_element_matrix-290"><span class="linenos">290</span></a><span class="sd">            Local element matrix corresponding to the reduced Laplace</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-291"><a href="#LaplaceIntegral_without_time.compute_element_matrix-291"><span class="linenos">291</span></a><span class="sd">            bilinear form.</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-292"><a href="#LaplaceIntegral_without_time.compute_element_matrix-292"><span class="linenos">292</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-293"><a href="#LaplaceIntegral_without_time.compute_element_matrix-293"><span class="linenos">293</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-294"><a href="#LaplaceIntegral_without_time.compute_element_matrix-294"><span class="linenos">294</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-295"><a href="#LaplaceIntegral_without_time.compute_element_matrix-295"><span class="linenos">295</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-296"><a href="#LaplaceIntegral_without_time.compute_element_matrix-296"><span class="linenos">296</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-297"><a href="#LaplaceIntegral_without_time.compute_element_matrix-297"><span class="linenos">297</span></a>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-298"><a href="#LaplaceIntegral_without_time.compute_element_matrix-298"><span class="linenos">298</span></a>        <span class="n">dshapes_ref_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    <span class="c1"># [n_qp, dim, n_test]</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-299"><a href="#LaplaceIntegral_without_time.compute_element_matrix-299"><span class="linenos">299</span></a>        <span class="n">dshapes_ref_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, n_trial]</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-300"><a href="#LaplaceIntegral_without_time.compute_element_matrix-300"><span class="linenos">300</span></a>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-301"><a href="#LaplaceIntegral_without_time.compute_element_matrix-301"><span class="linenos">301</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-302"><a href="#LaplaceIntegral_without_time.compute_element_matrix-302"><span class="linenos">302</span></a>        <span class="n">Jinv</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>        <span class="c1"># [n_qp, dim, dim]                              # [n_qp, dim-1, dim]</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-303"><a href="#LaplaceIntegral_without_time.compute_element_matrix-303"><span class="linenos">303</span></a>        
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-304"><a href="#LaplaceIntegral_without_time.compute_element_matrix-304"><span class="linenos">304</span></a>        <span class="n">grad_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_test</span><span class="p">)</span>     <span class="c1"># [n_qp, dim, n_test]</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-305"><a href="#LaplaceIntegral_without_time.compute_element_matrix-305"><span class="linenos">305</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">Jinv</span><span class="p">,</span> <span class="n">dshapes_ref_trial</span><span class="p">)</span>   <span class="c1"># [n_qp, dim, n_trial]</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-306"><a href="#LaplaceIntegral_without_time.compute_element_matrix-306"><span class="linenos">306</span></a>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-307"><a href="#LaplaceIntegral_without_time.compute_element_matrix-307"><span class="linenos">307</span></a>        <span class="n">grad_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">grad_test</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># [n_qp, dim-1, n_test]</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-308"><a href="#LaplaceIntegral_without_time.compute_element_matrix-308"><span class="linenos">308</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">grad_trial</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># [n_qp, dim-1, n_trial]</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-309"><a href="#LaplaceIntegral_without_time.compute_element_matrix-309"><span class="linenos">309</span></a>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-310"><a href="#LaplaceIntegral_without_time.compute_element_matrix-310"><span class="linenos">310</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>    <span class="c1"># [n_qp]</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-311"><a href="#LaplaceIntegral_without_time.compute_element_matrix-311"><span class="linenos">311</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>                <span class="c1"># [n_qp]</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-312"><a href="#LaplaceIntegral_without_time.compute_element_matrix-312"><span class="linenos">312</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>                                         <span class="c1"># [n_qp]</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-313"><a href="#LaplaceIntegral_without_time.compute_element_matrix-313"><span class="linenos">313</span></a>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-314"><a href="#LaplaceIntegral_without_time.compute_element_matrix-314"><span class="linenos">314</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ijl,i,i,i-&gt;kl&quot;</span><span class="p">,</span> <span class="n">grad_test</span><span class="p">,</span> <span class="n">grad_trial</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="LaplaceIntegral_without_time.compute_element_matrix-315"><a href="#LaplaceIntegral_without_time.compute_element_matrix-315"><span class="linenos">315</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Compute Laplace-like bilinear form ignoring the last dimension.</p>

<pre><code>    This operator is similar to the standard Laplace integral but
    is constructed to omit the final coordinate (for example to
    exclude time when assembling spatial diffusion only). The weak
    form per element K is
        A_{ij} = \int_K c(x)
</code></pre>

<p>abla_{x'}\phi_i \cdot 
abla_{x'}\phi_j \;dx</p>

<pre><code>    where
</code></pre>

<p>abla_{x'} denotes gradient with respect to all but
        the last coordinate.</p>

<pre><code>    Parameters
    ----------
    fe_test, fe_trial : FiniteElement
        Finite element descriptors for test and trial spaces.
    trafo : object
        Transformation providing Jacobian and mesh information.
    intrule : IntegrationRule, optional
        Quadrature rule to use.

    Returns
    -------
    ndarray
        Local element matrix corresponding to the reduced Laplace
        bilinear form.
</code></pre>
</div>


                            </div>
                </section>
                <section id="TimeIntegral">
                            <input id="TimeIntegral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TimeIntegral</span><wbr>(<span class="base"><a href="#BilinearFormIntegral">BilinearFormIntegral</a></span>):

                <label class="view-source-button" for="TimeIntegral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TimeIntegral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TimeIntegral-318"><a href="#TimeIntegral-318"><span class="linenos">318</span></a><span class="k">class</span><span class="w"> </span><span class="nc">TimeIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="TimeIntegral-319"><a href="#TimeIntegral-319"><span class="linenos">319</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span> <span class="o">=</span> <span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="TimeIntegral-320"><a href="#TimeIntegral-320"><span class="linenos">320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="TimeIntegral-321"><a href="#TimeIntegral-321"><span class="linenos">321</span></a>
</span><span id="TimeIntegral-322"><a href="#TimeIntegral-322"><span class="linenos">322</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="TimeIntegral-323"><a href="#TimeIntegral-323"><span class="linenos">323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute element matrix for time-derivative coupling.</span>
</span><span id="TimeIntegral-324"><a href="#TimeIntegral-324"><span class="linenos">324</span></a>
</span><span id="TimeIntegral-325"><a href="#TimeIntegral-325"><span class="linenos">325</span></a><span class="sd">        Implements the bilinear form corresponding to the weak</span>
</span><span id="TimeIntegral-326"><a href="#TimeIntegral-326"><span class="linenos">326</span></a><span class="sd">        representation of a time derivative term on the element K:</span>
</span><span id="TimeIntegral-327"><a href="#TimeIntegral-327"><span class="linenos">327</span></a><span class="sd">            T_{ij} = \int_K (\partial_t \phi_j) \; \phi_i \; c(x) \;dx</span>
</span><span id="TimeIntegral-328"><a href="#TimeIntegral-328"><span class="linenos">328</span></a>
</span><span id="TimeIntegral-329"><a href="#TimeIntegral-329"><span class="linenos">329</span></a><span class="sd">        In the code the trial element shape functions are evaluated</span>
</span><span id="TimeIntegral-330"><a href="#TimeIntegral-330"><span class="linenos">330</span></a><span class="sd">        with derivatives and the time-direction derivative is</span>
</span><span id="TimeIntegral-331"><a href="#TimeIntegral-331"><span class="linenos">331</span></a><span class="sd">        extracted (typically the last coordinate) then contracted with</span>
</span><span id="TimeIntegral-332"><a href="#TimeIntegral-332"><span class="linenos">332</span></a><span class="sd">        test shapes and quadrature weights.</span>
</span><span id="TimeIntegral-333"><a href="#TimeIntegral-333"><span class="linenos">333</span></a>
</span><span id="TimeIntegral-334"><a href="#TimeIntegral-334"><span class="linenos">334</span></a><span class="sd">        Parameters</span>
</span><span id="TimeIntegral-335"><a href="#TimeIntegral-335"><span class="linenos">335</span></a><span class="sd">        ----------</span>
</span><span id="TimeIntegral-336"><a href="#TimeIntegral-336"><span class="linenos">336</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="TimeIntegral-337"><a href="#TimeIntegral-337"><span class="linenos">337</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="TimeIntegral-338"><a href="#TimeIntegral-338"><span class="linenos">338</span></a><span class="sd">        trafo : object</span>
</span><span id="TimeIntegral-339"><a href="#TimeIntegral-339"><span class="linenos">339</span></a><span class="sd">            Transformation object providing Jacobian, mesh and mapping</span>
</span><span id="TimeIntegral-340"><a href="#TimeIntegral-340"><span class="linenos">340</span></a><span class="sd">            information.</span>
</span><span id="TimeIntegral-341"><a href="#TimeIntegral-341"><span class="linenos">341</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="TimeIntegral-342"><a href="#TimeIntegral-342"><span class="linenos">342</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="TimeIntegral-343"><a href="#TimeIntegral-343"><span class="linenos">343</span></a>
</span><span id="TimeIntegral-344"><a href="#TimeIntegral-344"><span class="linenos">344</span></a><span class="sd">        Returns</span>
</span><span id="TimeIntegral-345"><a href="#TimeIntegral-345"><span class="linenos">345</span></a><span class="sd">        -------</span>
</span><span id="TimeIntegral-346"><a href="#TimeIntegral-346"><span class="linenos">346</span></a><span class="sd">        ndarray</span>
</span><span id="TimeIntegral-347"><a href="#TimeIntegral-347"><span class="linenos">347</span></a><span class="sd">            Local element matrix representing the time-derivative</span>
</span><span id="TimeIntegral-348"><a href="#TimeIntegral-348"><span class="linenos">348</span></a><span class="sd">            coupling between trial and test spaces.</span>
</span><span id="TimeIntegral-349"><a href="#TimeIntegral-349"><span class="linenos">349</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TimeIntegral-350"><a href="#TimeIntegral-350"><span class="linenos">350</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TimeIntegral-351"><a href="#TimeIntegral-351"><span class="linenos">351</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="TimeIntegral-352"><a href="#TimeIntegral-352"><span class="linenos">352</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="TimeIntegral-353"><a href="#TimeIntegral-353"><span class="linenos">353</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="TimeIntegral-354"><a href="#TimeIntegral-354"><span class="linenos">354</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="TimeIntegral-355"><a href="#TimeIntegral-355"><span class="linenos">355</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="TimeIntegral-356"><a href="#TimeIntegral-356"><span class="linenos">356</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="TimeIntegral-357"><a href="#TimeIntegral-357"><span class="linenos">357</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="TimeIntegral-358"><a href="#TimeIntegral-358"><span class="linenos">358</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="TimeIntegral-359"><a href="#TimeIntegral-359"><span class="linenos">359</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="TimeIntegral-360"><a href="#TimeIntegral-360"><span class="linenos">360</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span> 
</span><span id="TimeIntegral-361"><a href="#TimeIntegral-361"><span class="linenos">361</span></a>        <span class="n">dt_trial</span> <span class="o">=</span> <span class="n">w</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>  
</span><span id="TimeIntegral-362"><a href="#TimeIntegral-362"><span class="linenos">362</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ik,i,i,i-&gt;kj&quot;</span><span class="p">,</span> <span class="n">dt_trial</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="TimeIntegral-363"><a href="#TimeIntegral-363"><span class="linenos">363</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="TimeIntegral.__init__" class="classattr">
                                        <input id="TimeIntegral.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TimeIntegral</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">coeff</span><span class="o">=&lt;</span><span class="n"><a href="meshfct.html#ConstantFunction">methodsnm.meshfct.ConstantFunction</a></span> <span class="nb">object</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="TimeIntegral.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TimeIntegral.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TimeIntegral.__init__-319"><a href="#TimeIntegral.__init__-319"><span class="linenos">319</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span> <span class="o">=</span> <span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="TimeIntegral.__init__-320"><a href="#TimeIntegral.__init__-320"><span class="linenos">320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span></pre></div>


    

                            </div>
                            <div id="TimeIntegral.coeff" class="classattr">
                                <div class="attr variable">
            <span class="name">coeff</span>

        
    </div>
    <a class="headerlink" href="#TimeIntegral.coeff"></a>
    
    

                            </div>
                            <div id="TimeIntegral.compute_element_matrix" class="classattr">
                                        <input id="TimeIntegral.compute_element_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe_test</span>, </span><span class="param"><span class="n">fe_trial</span>, </span><span class="param"><span class="n">trafo</span>, </span><span class="param"><span class="n">intrule</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TimeIntegral.compute_element_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TimeIntegral.compute_element_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TimeIntegral.compute_element_matrix-322"><a href="#TimeIntegral.compute_element_matrix-322"><span class="linenos">322</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="TimeIntegral.compute_element_matrix-323"><a href="#TimeIntegral.compute_element_matrix-323"><span class="linenos">323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute element matrix for time-derivative coupling.</span>
</span><span id="TimeIntegral.compute_element_matrix-324"><a href="#TimeIntegral.compute_element_matrix-324"><span class="linenos">324</span></a>
</span><span id="TimeIntegral.compute_element_matrix-325"><a href="#TimeIntegral.compute_element_matrix-325"><span class="linenos">325</span></a><span class="sd">        Implements the bilinear form corresponding to the weak</span>
</span><span id="TimeIntegral.compute_element_matrix-326"><a href="#TimeIntegral.compute_element_matrix-326"><span class="linenos">326</span></a><span class="sd">        representation of a time derivative term on the element K:</span>
</span><span id="TimeIntegral.compute_element_matrix-327"><a href="#TimeIntegral.compute_element_matrix-327"><span class="linenos">327</span></a><span class="sd">            T_{ij} = \int_K (\partial_t \phi_j) \; \phi_i \; c(x) \;dx</span>
</span><span id="TimeIntegral.compute_element_matrix-328"><a href="#TimeIntegral.compute_element_matrix-328"><span class="linenos">328</span></a>
</span><span id="TimeIntegral.compute_element_matrix-329"><a href="#TimeIntegral.compute_element_matrix-329"><span class="linenos">329</span></a><span class="sd">        In the code the trial element shape functions are evaluated</span>
</span><span id="TimeIntegral.compute_element_matrix-330"><a href="#TimeIntegral.compute_element_matrix-330"><span class="linenos">330</span></a><span class="sd">        with derivatives and the time-direction derivative is</span>
</span><span id="TimeIntegral.compute_element_matrix-331"><a href="#TimeIntegral.compute_element_matrix-331"><span class="linenos">331</span></a><span class="sd">        extracted (typically the last coordinate) then contracted with</span>
</span><span id="TimeIntegral.compute_element_matrix-332"><a href="#TimeIntegral.compute_element_matrix-332"><span class="linenos">332</span></a><span class="sd">        test shapes and quadrature weights.</span>
</span><span id="TimeIntegral.compute_element_matrix-333"><a href="#TimeIntegral.compute_element_matrix-333"><span class="linenos">333</span></a>
</span><span id="TimeIntegral.compute_element_matrix-334"><a href="#TimeIntegral.compute_element_matrix-334"><span class="linenos">334</span></a><span class="sd">        Parameters</span>
</span><span id="TimeIntegral.compute_element_matrix-335"><a href="#TimeIntegral.compute_element_matrix-335"><span class="linenos">335</span></a><span class="sd">        ----------</span>
</span><span id="TimeIntegral.compute_element_matrix-336"><a href="#TimeIntegral.compute_element_matrix-336"><span class="linenos">336</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="TimeIntegral.compute_element_matrix-337"><a href="#TimeIntegral.compute_element_matrix-337"><span class="linenos">337</span></a><span class="sd">            Finite element descriptors for test and trial spaces.</span>
</span><span id="TimeIntegral.compute_element_matrix-338"><a href="#TimeIntegral.compute_element_matrix-338"><span class="linenos">338</span></a><span class="sd">        trafo : object</span>
</span><span id="TimeIntegral.compute_element_matrix-339"><a href="#TimeIntegral.compute_element_matrix-339"><span class="linenos">339</span></a><span class="sd">            Transformation object providing Jacobian, mesh and mapping</span>
</span><span id="TimeIntegral.compute_element_matrix-340"><a href="#TimeIntegral.compute_element_matrix-340"><span class="linenos">340</span></a><span class="sd">            information.</span>
</span><span id="TimeIntegral.compute_element_matrix-341"><a href="#TimeIntegral.compute_element_matrix-341"><span class="linenos">341</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="TimeIntegral.compute_element_matrix-342"><a href="#TimeIntegral.compute_element_matrix-342"><span class="linenos">342</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="TimeIntegral.compute_element_matrix-343"><a href="#TimeIntegral.compute_element_matrix-343"><span class="linenos">343</span></a>
</span><span id="TimeIntegral.compute_element_matrix-344"><a href="#TimeIntegral.compute_element_matrix-344"><span class="linenos">344</span></a><span class="sd">        Returns</span>
</span><span id="TimeIntegral.compute_element_matrix-345"><a href="#TimeIntegral.compute_element_matrix-345"><span class="linenos">345</span></a><span class="sd">        -------</span>
</span><span id="TimeIntegral.compute_element_matrix-346"><a href="#TimeIntegral.compute_element_matrix-346"><span class="linenos">346</span></a><span class="sd">        ndarray</span>
</span><span id="TimeIntegral.compute_element_matrix-347"><a href="#TimeIntegral.compute_element_matrix-347"><span class="linenos">347</span></a><span class="sd">            Local element matrix representing the time-derivative</span>
</span><span id="TimeIntegral.compute_element_matrix-348"><a href="#TimeIntegral.compute_element_matrix-348"><span class="linenos">348</span></a><span class="sd">            coupling between trial and test spaces.</span>
</span><span id="TimeIntegral.compute_element_matrix-349"><a href="#TimeIntegral.compute_element_matrix-349"><span class="linenos">349</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TimeIntegral.compute_element_matrix-350"><a href="#TimeIntegral.compute_element_matrix-350"><span class="linenos">350</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TimeIntegral.compute_element_matrix-351"><a href="#TimeIntegral.compute_element_matrix-351"><span class="linenos">351</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="TimeIntegral.compute_element_matrix-352"><a href="#TimeIntegral.compute_element_matrix-352"><span class="linenos">352</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="TimeIntegral.compute_element_matrix-353"><a href="#TimeIntegral.compute_element_matrix-353"><span class="linenos">353</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="TimeIntegral.compute_element_matrix-354"><a href="#TimeIntegral.compute_element_matrix-354"><span class="linenos">354</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="TimeIntegral.compute_element_matrix-355"><a href="#TimeIntegral.compute_element_matrix-355"><span class="linenos">355</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="TimeIntegral.compute_element_matrix-356"><a href="#TimeIntegral.compute_element_matrix-356"><span class="linenos">356</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="TimeIntegral.compute_element_matrix-357"><a href="#TimeIntegral.compute_element_matrix-357"><span class="linenos">357</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="TimeIntegral.compute_element_matrix-358"><a href="#TimeIntegral.compute_element_matrix-358"><span class="linenos">358</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="TimeIntegral.compute_element_matrix-359"><a href="#TimeIntegral.compute_element_matrix-359"><span class="linenos">359</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="TimeIntegral.compute_element_matrix-360"><a href="#TimeIntegral.compute_element_matrix-360"><span class="linenos">360</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span> 
</span><span id="TimeIntegral.compute_element_matrix-361"><a href="#TimeIntegral.compute_element_matrix-361"><span class="linenos">361</span></a>        <span class="n">dt_trial</span> <span class="o">=</span> <span class="n">w</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>  
</span><span id="TimeIntegral.compute_element_matrix-362"><a href="#TimeIntegral.compute_element_matrix-362"><span class="linenos">362</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ik,i,i,i-&gt;kj&quot;</span><span class="p">,</span> <span class="n">dt_trial</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="TimeIntegral.compute_element_matrix-363"><a href="#TimeIntegral.compute_element_matrix-363"><span class="linenos">363</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Compute element matrix for time-derivative coupling.</p>

<p>Implements the bilinear form corresponding to the weak
representation of a time derivative term on the element K:
    T_{ij} = \int_K (\partial_t \phi_j) \; \phi_i \; c(x) \;dx</p>

<p>In the code the trial element shape functions are evaluated
with derivatives and the time-direction derivative is
extracted (typically the last coordinate) then contracted with
test shapes and quadrature weights.</p>

<h2 id="parameters">Parameters</h2>

<p>fe_test, fe_trial : FiniteElement
    Finite element descriptors for test and trial spaces.
trafo : object
    Transformation object providing Jacobian, mesh and mapping
    information.
intrule : IntegrationRule, optional
    Quadrature rule to use.</p>

<h2 id="returns">Returns</h2>

<p>ndarray
    Local element matrix representing the time-derivative
    coupling between trial and test spaces.</p>
</div>


                            </div>
                </section>
                <section id="ConvectionIntegral">
                            <input id="ConvectionIntegral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ConvectionIntegral</span><wbr>(<span class="base"><a href="#BilinearFormIntegral">BilinearFormIntegral</a></span>):

                <label class="view-source-button" for="ConvectionIntegral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConvectionIntegral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConvectionIntegral-365"><a href="#ConvectionIntegral-365"><span class="linenos">365</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ConvectionIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="ConvectionIntegral-366"><a href="#ConvectionIntegral-366"><span class="linenos">366</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">))):</span>
</span><span id="ConvectionIntegral-367"><a href="#ConvectionIntegral-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="ConvectionIntegral-368"><a href="#ConvectionIntegral-368"><span class="linenos">368</span></a>
</span><span id="ConvectionIntegral-369"><a href="#ConvectionIntegral-369"><span class="linenos">369</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ConvectionIntegral-370"><a href="#ConvectionIntegral-370"><span class="linenos">370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute element matrix for the convection term.</span>
</span><span id="ConvectionIntegral-371"><a href="#ConvectionIntegral-371"><span class="linenos">371</span></a>
</span><span id="ConvectionIntegral-372"><a href="#ConvectionIntegral-372"><span class="linenos">372</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="ConvectionIntegral-373"><a href="#ConvectionIntegral-373"><span class="linenos">373</span></a><span class="sd">            C_{ij} = \int_K (w(x) \cdot \nabla \phi_j(x)) \; \phi_i(x) \; |\det J| \; dx</span>
</span><span id="ConvectionIntegral-374"><a href="#ConvectionIntegral-374"><span class="linenos">374</span></a>
</span><span id="ConvectionIntegral-375"><a href="#ConvectionIntegral-375"><span class="linenos">375</span></a><span class="sd">        where w(x) is the convective velocity provided as `coeff`.</span>
</span><span id="ConvectionIntegral-376"><a href="#ConvectionIntegral-376"><span class="linenos">376</span></a><span class="sd">        The implementation maps reference gradients to physical</span>
</span><span id="ConvectionIntegral-377"><a href="#ConvectionIntegral-377"><span class="linenos">377</span></a><span class="sd">        gradients and forms the scalar convective derivative</span>
</span><span id="ConvectionIntegral-378"><a href="#ConvectionIntegral-378"><span class="linenos">378</span></a><span class="sd">        w \cdot \nabla phi_j which is then multiplied by the test</span>
</span><span id="ConvectionIntegral-379"><a href="#ConvectionIntegral-379"><span class="linenos">379</span></a><span class="sd">        function and integrated.</span>
</span><span id="ConvectionIntegral-380"><a href="#ConvectionIntegral-380"><span class="linenos">380</span></a>
</span><span id="ConvectionIntegral-381"><a href="#ConvectionIntegral-381"><span class="linenos">381</span></a><span class="sd">        Parameters</span>
</span><span id="ConvectionIntegral-382"><a href="#ConvectionIntegral-382"><span class="linenos">382</span></a><span class="sd">        ----------</span>
</span><span id="ConvectionIntegral-383"><a href="#ConvectionIntegral-383"><span class="linenos">383</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="ConvectionIntegral-384"><a href="#ConvectionIntegral-384"><span class="linenos">384</span></a><span class="sd">            Test and trial finite element descriptors.</span>
</span><span id="ConvectionIntegral-385"><a href="#ConvectionIntegral-385"><span class="linenos">385</span></a><span class="sd">        trafo : object</span>
</span><span id="ConvectionIntegral-386"><a href="#ConvectionIntegral-386"><span class="linenos">386</span></a><span class="sd">            Transformation providing Jacobians and mesh metadata.</span>
</span><span id="ConvectionIntegral-387"><a href="#ConvectionIntegral-387"><span class="linenos">387</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="ConvectionIntegral-388"><a href="#ConvectionIntegral-388"><span class="linenos">388</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="ConvectionIntegral-389"><a href="#ConvectionIntegral-389"><span class="linenos">389</span></a>
</span><span id="ConvectionIntegral-390"><a href="#ConvectionIntegral-390"><span class="linenos">390</span></a><span class="sd">        Returns</span>
</span><span id="ConvectionIntegral-391"><a href="#ConvectionIntegral-391"><span class="linenos">391</span></a><span class="sd">        -------</span>
</span><span id="ConvectionIntegral-392"><a href="#ConvectionIntegral-392"><span class="linenos">392</span></a><span class="sd">        ndarray</span>
</span><span id="ConvectionIntegral-393"><a href="#ConvectionIntegral-393"><span class="linenos">393</span></a><span class="sd">            Local convection matrix of shape (n_test, n_trial).</span>
</span><span id="ConvectionIntegral-394"><a href="#ConvectionIntegral-394"><span class="linenos">394</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConvectionIntegral-395"><a href="#ConvectionIntegral-395"><span class="linenos">395</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ConvectionIntegral-396"><a href="#ConvectionIntegral-396"><span class="linenos">396</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="ConvectionIntegral-397"><a href="#ConvectionIntegral-397"><span class="linenos">397</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="ConvectionIntegral-398"><a href="#ConvectionIntegral-398"><span class="linenos">398</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="ConvectionIntegral-399"><a href="#ConvectionIntegral-399"><span class="linenos">399</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="ConvectionIntegral-400"><a href="#ConvectionIntegral-400"><span class="linenos">400</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ConvectionIntegral-401"><a href="#ConvectionIntegral-401"><span class="linenos">401</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="ConvectionIntegral-402"><a href="#ConvectionIntegral-402"><span class="linenos">402</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="ConvectionIntegral-403"><a href="#ConvectionIntegral-403"><span class="linenos">403</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="ConvectionIntegral-404"><a href="#ConvectionIntegral-404"><span class="linenos">404</span></a>        <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="ConvectionIntegral-405"><a href="#ConvectionIntegral-405"><span class="linenos">405</span></a>
</span><span id="ConvectionIntegral-406"><a href="#ConvectionIntegral-406"><span class="linenos">406</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span> 
</span><span id="ConvectionIntegral-407"><a href="#ConvectionIntegral-407"><span class="linenos">407</span></a>        <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="ConvectionIntegral-408"><a href="#ConvectionIntegral-408"><span class="linenos">408</span></a>
</span><span id="ConvectionIntegral-409"><a href="#ConvectionIntegral-409"><span class="linenos">409</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ik,i,i-&gt;kj&quot;</span><span class="p">,</span> <span class="n">conv</span> <span class="p">,</span> <span class="n">shapes_test</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="ConvectionIntegral-410"><a href="#ConvectionIntegral-410"><span class="linenos">410</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="ConvectionIntegral.__init__" class="classattr">
                                        <input id="ConvectionIntegral.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ConvectionIntegral</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">coeff</span><span class="o">=&lt;</span><span class="n"><a href="meshfct.html#ConstantFunction">methodsnm.meshfct.ConstantFunction</a></span> <span class="nb">object</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="ConvectionIntegral.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConvectionIntegral.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConvectionIntegral.__init__-366"><a href="#ConvectionIntegral.__init__-366"><span class="linenos">366</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">))):</span>
</span><span id="ConvectionIntegral.__init__-367"><a href="#ConvectionIntegral.__init__-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span></pre></div>


    

                            </div>
                            <div id="ConvectionIntegral.coeff" class="classattr">
                                <div class="attr variable">
            <span class="name">coeff</span>

        
    </div>
    <a class="headerlink" href="#ConvectionIntegral.coeff"></a>
    
    

                            </div>
                            <div id="ConvectionIntegral.compute_element_matrix" class="classattr">
                                        <input id="ConvectionIntegral.compute_element_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe_test</span>, </span><span class="param"><span class="n">fe_trial</span>, </span><span class="param"><span class="n">trafo</span>, </span><span class="param"><span class="n">intrule</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ConvectionIntegral.compute_element_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConvectionIntegral.compute_element_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConvectionIntegral.compute_element_matrix-369"><a href="#ConvectionIntegral.compute_element_matrix-369"><span class="linenos">369</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ConvectionIntegral.compute_element_matrix-370"><a href="#ConvectionIntegral.compute_element_matrix-370"><span class="linenos">370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute element matrix for the convection term.</span>
</span><span id="ConvectionIntegral.compute_element_matrix-371"><a href="#ConvectionIntegral.compute_element_matrix-371"><span class="linenos">371</span></a>
</span><span id="ConvectionIntegral.compute_element_matrix-372"><a href="#ConvectionIntegral.compute_element_matrix-372"><span class="linenos">372</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="ConvectionIntegral.compute_element_matrix-373"><a href="#ConvectionIntegral.compute_element_matrix-373"><span class="linenos">373</span></a><span class="sd">            C_{ij} = \int_K (w(x) \cdot \nabla \phi_j(x)) \; \phi_i(x) \; |\det J| \; dx</span>
</span><span id="ConvectionIntegral.compute_element_matrix-374"><a href="#ConvectionIntegral.compute_element_matrix-374"><span class="linenos">374</span></a>
</span><span id="ConvectionIntegral.compute_element_matrix-375"><a href="#ConvectionIntegral.compute_element_matrix-375"><span class="linenos">375</span></a><span class="sd">        where w(x) is the convective velocity provided as `coeff`.</span>
</span><span id="ConvectionIntegral.compute_element_matrix-376"><a href="#ConvectionIntegral.compute_element_matrix-376"><span class="linenos">376</span></a><span class="sd">        The implementation maps reference gradients to physical</span>
</span><span id="ConvectionIntegral.compute_element_matrix-377"><a href="#ConvectionIntegral.compute_element_matrix-377"><span class="linenos">377</span></a><span class="sd">        gradients and forms the scalar convective derivative</span>
</span><span id="ConvectionIntegral.compute_element_matrix-378"><a href="#ConvectionIntegral.compute_element_matrix-378"><span class="linenos">378</span></a><span class="sd">        w \cdot \nabla phi_j which is then multiplied by the test</span>
</span><span id="ConvectionIntegral.compute_element_matrix-379"><a href="#ConvectionIntegral.compute_element_matrix-379"><span class="linenos">379</span></a><span class="sd">        function and integrated.</span>
</span><span id="ConvectionIntegral.compute_element_matrix-380"><a href="#ConvectionIntegral.compute_element_matrix-380"><span class="linenos">380</span></a>
</span><span id="ConvectionIntegral.compute_element_matrix-381"><a href="#ConvectionIntegral.compute_element_matrix-381"><span class="linenos">381</span></a><span class="sd">        Parameters</span>
</span><span id="ConvectionIntegral.compute_element_matrix-382"><a href="#ConvectionIntegral.compute_element_matrix-382"><span class="linenos">382</span></a><span class="sd">        ----------</span>
</span><span id="ConvectionIntegral.compute_element_matrix-383"><a href="#ConvectionIntegral.compute_element_matrix-383"><span class="linenos">383</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="ConvectionIntegral.compute_element_matrix-384"><a href="#ConvectionIntegral.compute_element_matrix-384"><span class="linenos">384</span></a><span class="sd">            Test and trial finite element descriptors.</span>
</span><span id="ConvectionIntegral.compute_element_matrix-385"><a href="#ConvectionIntegral.compute_element_matrix-385"><span class="linenos">385</span></a><span class="sd">        trafo : object</span>
</span><span id="ConvectionIntegral.compute_element_matrix-386"><a href="#ConvectionIntegral.compute_element_matrix-386"><span class="linenos">386</span></a><span class="sd">            Transformation providing Jacobians and mesh metadata.</span>
</span><span id="ConvectionIntegral.compute_element_matrix-387"><a href="#ConvectionIntegral.compute_element_matrix-387"><span class="linenos">387</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="ConvectionIntegral.compute_element_matrix-388"><a href="#ConvectionIntegral.compute_element_matrix-388"><span class="linenos">388</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="ConvectionIntegral.compute_element_matrix-389"><a href="#ConvectionIntegral.compute_element_matrix-389"><span class="linenos">389</span></a>
</span><span id="ConvectionIntegral.compute_element_matrix-390"><a href="#ConvectionIntegral.compute_element_matrix-390"><span class="linenos">390</span></a><span class="sd">        Returns</span>
</span><span id="ConvectionIntegral.compute_element_matrix-391"><a href="#ConvectionIntegral.compute_element_matrix-391"><span class="linenos">391</span></a><span class="sd">        -------</span>
</span><span id="ConvectionIntegral.compute_element_matrix-392"><a href="#ConvectionIntegral.compute_element_matrix-392"><span class="linenos">392</span></a><span class="sd">        ndarray</span>
</span><span id="ConvectionIntegral.compute_element_matrix-393"><a href="#ConvectionIntegral.compute_element_matrix-393"><span class="linenos">393</span></a><span class="sd">            Local convection matrix of shape (n_test, n_trial).</span>
</span><span id="ConvectionIntegral.compute_element_matrix-394"><a href="#ConvectionIntegral.compute_element_matrix-394"><span class="linenos">394</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ConvectionIntegral.compute_element_matrix-395"><a href="#ConvectionIntegral.compute_element_matrix-395"><span class="linenos">395</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ConvectionIntegral.compute_element_matrix-396"><a href="#ConvectionIntegral.compute_element_matrix-396"><span class="linenos">396</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="ConvectionIntegral.compute_element_matrix-397"><a href="#ConvectionIntegral.compute_element_matrix-397"><span class="linenos">397</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="ConvectionIntegral.compute_element_matrix-398"><a href="#ConvectionIntegral.compute_element_matrix-398"><span class="linenos">398</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="ConvectionIntegral.compute_element_matrix-399"><a href="#ConvectionIntegral.compute_element_matrix-399"><span class="linenos">399</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="ConvectionIntegral.compute_element_matrix-400"><a href="#ConvectionIntegral.compute_element_matrix-400"><span class="linenos">400</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ConvectionIntegral.compute_element_matrix-401"><a href="#ConvectionIntegral.compute_element_matrix-401"><span class="linenos">401</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="ConvectionIntegral.compute_element_matrix-402"><a href="#ConvectionIntegral.compute_element_matrix-402"><span class="linenos">402</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="ConvectionIntegral.compute_element_matrix-403"><a href="#ConvectionIntegral.compute_element_matrix-403"><span class="linenos">403</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="ConvectionIntegral.compute_element_matrix-404"><a href="#ConvectionIntegral.compute_element_matrix-404"><span class="linenos">404</span></a>        <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="ConvectionIntegral.compute_element_matrix-405"><a href="#ConvectionIntegral.compute_element_matrix-405"><span class="linenos">405</span></a>
</span><span id="ConvectionIntegral.compute_element_matrix-406"><a href="#ConvectionIntegral.compute_element_matrix-406"><span class="linenos">406</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span> 
</span><span id="ConvectionIntegral.compute_element_matrix-407"><a href="#ConvectionIntegral.compute_element_matrix-407"><span class="linenos">407</span></a>        <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="ConvectionIntegral.compute_element_matrix-408"><a href="#ConvectionIntegral.compute_element_matrix-408"><span class="linenos">408</span></a>
</span><span id="ConvectionIntegral.compute_element_matrix-409"><a href="#ConvectionIntegral.compute_element_matrix-409"><span class="linenos">409</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ik,i,i-&gt;kj&quot;</span><span class="p">,</span> <span class="n">conv</span> <span class="p">,</span> <span class="n">shapes_test</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="ConvectionIntegral.compute_element_matrix-410"><a href="#ConvectionIntegral.compute_element_matrix-410"><span class="linenos">410</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Compute element matrix for the convection term.</p>

<pre><code>    Weak formulation (element K):
        C_{ij} = \int_K (w(x) \cdot
</code></pre>

<p>abla \phi_j(x)) \; \phi_i(x) \; |\det J| \; dx</p>

<pre><code>    where w(x) is the convective velocity provided as `coeff`.
    The implementation maps reference gradients to physical
    gradients and forms the scalar convective derivative
    w \cdot
</code></pre>

<p>abla phi_j which is then multiplied by the test
        function and integrated.</p>

<pre><code>    Parameters
    ----------
    fe_test, fe_trial : FiniteElement
        Test and trial finite element descriptors.
    trafo : object
        Transformation providing Jacobians and mesh metadata.
    intrule : IntegrationRule, optional
        Quadrature rule to use.

    Returns
    -------
    ndarray
        Local convection matrix of shape (n_test, n_trial).
</code></pre>
</div>


                            </div>
                </section>
                <section id="SUPGIntegral">
                            <input id="SUPGIntegral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SUPGIntegral</span><wbr>(<span class="base"><a href="#BilinearFormIntegral">BilinearFormIntegral</a></span>):

                <label class="view-source-button" for="SUPGIntegral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SUPGIntegral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SUPGIntegral-412"><a href="#SUPGIntegral-412"><span class="linenos">412</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SUPGIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="SUPGIntegral-413"><a href="#SUPGIntegral-413"><span class="linenos">413</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">))):</span>
</span><span id="SUPGIntegral-414"><a href="#SUPGIntegral-414"><span class="linenos">414</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="SUPGIntegral-415"><a href="#SUPGIntegral-415"><span class="linenos">415</span></a>
</span><span id="SUPGIntegral-416"><a href="#SUPGIntegral-416"><span class="linenos">416</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SUPGIntegral-417"><a href="#SUPGIntegral-417"><span class="linenos">417</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the SUPG stabilization matrix.</span>
</span><span id="SUPGIntegral-418"><a href="#SUPGIntegral-418"><span class="linenos">418</span></a>
</span><span id="SUPGIntegral-419"><a href="#SUPGIntegral-419"><span class="linenos">419</span></a><span class="sd">        The SUPG (streamline upwind Petrov-Galerkin) stabilization</span>
</span><span id="SUPGIntegral-420"><a href="#SUPGIntegral-420"><span class="linenos">420</span></a><span class="sd">        implemented here computes, per element K, a stabilizing term</span>
</span><span id="SUPGIntegral-421"><a href="#SUPGIntegral-421"><span class="linenos">421</span></a><span class="sd">            S_{ij} = \int_K \gamma_T(x) \; (w\cdot\nabla\phi_i) \; (w\cdot\nabla\phi_j) \; dx</span>
</span><span id="SUPGIntegral-422"><a href="#SUPGIntegral-422"><span class="linenos">422</span></a>
</span><span id="SUPGIntegral-423"><a href="#SUPGIntegral-423"><span class="linenos">423</span></a><span class="sd">        where gamma_T is a stabilization parameter depending on the</span>
</span><span id="SUPGIntegral-424"><a href="#SUPGIntegral-424"><span class="linenos">424</span></a><span class="sd">        local mesh size and the velocity w. The method maps reference</span>
</span><span id="SUPGIntegral-425"><a href="#SUPGIntegral-425"><span class="linenos">425</span></a><span class="sd">        gradients to physical gradients, computes the directional</span>
</span><span id="SUPGIntegral-426"><a href="#SUPGIntegral-426"><span class="linenos">426</span></a><span class="sd">        derivatives along w and assembles the weighted inner product.</span>
</span><span id="SUPGIntegral-427"><a href="#SUPGIntegral-427"><span class="linenos">427</span></a>
</span><span id="SUPGIntegral-428"><a href="#SUPGIntegral-428"><span class="linenos">428</span></a><span class="sd">        Parameters</span>
</span><span id="SUPGIntegral-429"><a href="#SUPGIntegral-429"><span class="linenos">429</span></a><span class="sd">        ----------</span>
</span><span id="SUPGIntegral-430"><a href="#SUPGIntegral-430"><span class="linenos">430</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="SUPGIntegral-431"><a href="#SUPGIntegral-431"><span class="linenos">431</span></a><span class="sd">            Test and trial finite element descriptors (both with</span>
</span><span id="SUPGIntegral-432"><a href="#SUPGIntegral-432"><span class="linenos">432</span></a><span class="sd">            derivative evaluations required).</span>
</span><span id="SUPGIntegral-433"><a href="#SUPGIntegral-433"><span class="linenos">433</span></a><span class="sd">        trafo : object</span>
</span><span id="SUPGIntegral-434"><a href="#SUPGIntegral-434"><span class="linenos">434</span></a><span class="sd">            Transformation providing Jacobians and mesh metadata.</span>
</span><span id="SUPGIntegral-435"><a href="#SUPGIntegral-435"><span class="linenos">435</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="SUPGIntegral-436"><a href="#SUPGIntegral-436"><span class="linenos">436</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="SUPGIntegral-437"><a href="#SUPGIntegral-437"><span class="linenos">437</span></a>
</span><span id="SUPGIntegral-438"><a href="#SUPGIntegral-438"><span class="linenos">438</span></a><span class="sd">        Returns</span>
</span><span id="SUPGIntegral-439"><a href="#SUPGIntegral-439"><span class="linenos">439</span></a><span class="sd">        -------</span>
</span><span id="SUPGIntegral-440"><a href="#SUPGIntegral-440"><span class="linenos">440</span></a><span class="sd">        ndarray</span>
</span><span id="SUPGIntegral-441"><a href="#SUPGIntegral-441"><span class="linenos">441</span></a><span class="sd">            Local SUPG stabilization matrix of shape (n_test, n_trial).</span>
</span><span id="SUPGIntegral-442"><a href="#SUPGIntegral-442"><span class="linenos">442</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SUPGIntegral-443"><a href="#SUPGIntegral-443"><span class="linenos">443</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SUPGIntegral-444"><a href="#SUPGIntegral-444"><span class="linenos">444</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="SUPGIntegral-445"><a href="#SUPGIntegral-445"><span class="linenos">445</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="SUPGIntegral-446"><a href="#SUPGIntegral-446"><span class="linenos">446</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="SUPGIntegral-447"><a href="#SUPGIntegral-447"><span class="linenos">447</span></a>        <span class="k">if</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SUPGIntegral-448"><a href="#SUPGIntegral-448"><span class="linenos">448</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)]])</span>
</span><span id="SUPGIntegral-449"><a href="#SUPGIntegral-449"><span class="linenos">449</span></a>        <span class="k">elif</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="SUPGIntegral-450"><a href="#SUPGIntegral-450"><span class="linenos">450</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">**-</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="SUPGIntegral-451"><a href="#SUPGIntegral-451"><span class="linenos">451</span></a>    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGIntegral-452"><a href="#SUPGIntegral-452"><span class="linenos">452</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGIntegral-453"><a href="#SUPGIntegral-453"><span class="linenos">453</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGIntegral-454"><a href="#SUPGIntegral-454"><span class="linenos">454</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
</span><span id="SUPGIntegral-455"><a href="#SUPGIntegral-455"><span class="linenos">455</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">special_meshsize</span>
</span><span id="SUPGIntegral-456"><a href="#SUPGIntegral-456"><span class="linenos">456</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SUPGIntegral-457"><a href="#SUPGIntegral-457"><span class="linenos">457</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SUPGIntegral-458"><a href="#SUPGIntegral-458"><span class="linenos">458</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="SUPGIntegral-459"><a href="#SUPGIntegral-459"><span class="linenos">459</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="SUPGIntegral-460"><a href="#SUPGIntegral-460"><span class="linenos">460</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="SUPGIntegral-461"><a href="#SUPGIntegral-461"><span class="linenos">461</span></a>        <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="SUPGIntegral-462"><a href="#SUPGIntegral-462"><span class="linenos">462</span></a>        <span class="n">cinv</span> <span class="o">=</span><span class="mi">1</span>
</span><span id="SUPGIntegral-463"><a href="#SUPGIntegral-463"><span class="linenos">463</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,jk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
</span><span id="SUPGIntegral-464"><a href="#SUPGIntegral-464"><span class="linenos">464</span></a>        <span class="n">expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,nkj-&gt;nik&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">invF</span><span class="p">)</span>
</span><span id="SUPGIntegral-465"><a href="#SUPGIntegral-465"><span class="linenos">465</span></a>        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ni,nij,nj-&gt;n&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">wind</span><span class="p">)</span>
</span><span id="SUPGIntegral-466"><a href="#SUPGIntegral-466"><span class="linenos">466</span></a>        <span class="n">gamma_T</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tau</span> <span class="o">+</span> <span class="p">(</span><span class="n">cinv</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SUPGIntegral-467"><a href="#SUPGIntegral-467"><span class="linenos">467</span></a>
</span><span id="SUPGIntegral-468"><a href="#SUPGIntegral-468"><span class="linenos">468</span></a>        <span class="n">grad_u_phys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span>
</span><span id="SUPGIntegral-469"><a href="#SUPGIntegral-469"><span class="linenos">469</span></a>        <span class="n">grad_v_phys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">)</span>
</span><span id="SUPGIntegral-470"><a href="#SUPGIntegral-470"><span class="linenos">470</span></a>
</span><span id="SUPGIntegral-471"><a href="#SUPGIntegral-471"><span class="linenos">471</span></a>        <span class="n">wind_grad_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">grad_u_phys</span><span class="p">)</span>
</span><span id="SUPGIntegral-472"><a href="#SUPGIntegral-472"><span class="linenos">472</span></a>        <span class="n">wind_grad_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">grad_v_phys</span><span class="p">)</span>
</span><span id="SUPGIntegral-473"><a href="#SUPGIntegral-473"><span class="linenos">473</span></a>
</span><span id="SUPGIntegral-474"><a href="#SUPGIntegral-474"><span class="linenos">474</span></a>        <span class="n">scale</span> <span class="o">=</span> <span class="n">gamma_T</span> <span class="o">*</span> <span class="n">adetF</span> <span class="o">*</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>  <span class="c1"># (n,)</span>
</span><span id="SUPGIntegral-475"><a href="#SUPGIntegral-475"><span class="linenos">475</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,ni,nj-&gt;ij&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">wind_grad_u</span><span class="p">,</span> <span class="n">wind_grad_v</span><span class="p">)</span>
</span><span id="SUPGIntegral-476"><a href="#SUPGIntegral-476"><span class="linenos">476</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="SUPGIntegral.__init__" class="classattr">
                                        <input id="SUPGIntegral.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SUPGIntegral</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">coeff</span><span class="o">=&lt;</span><span class="n"><a href="meshfct.html#ConstantFunction">methodsnm.meshfct.ConstantFunction</a></span> <span class="nb">object</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="SUPGIntegral.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SUPGIntegral.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SUPGIntegral.__init__-413"><a href="#SUPGIntegral.__init__-413"><span class="linenos">413</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">))):</span>
</span><span id="SUPGIntegral.__init__-414"><a href="#SUPGIntegral.__init__-414"><span class="linenos">414</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span></pre></div>


    

                            </div>
                            <div id="SUPGIntegral.coeff" class="classattr">
                                <div class="attr variable">
            <span class="name">coeff</span>

        
    </div>
    <a class="headerlink" href="#SUPGIntegral.coeff"></a>
    
    

                            </div>
                            <div id="SUPGIntegral.compute_element_matrix" class="classattr">
                                        <input id="SUPGIntegral.compute_element_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe_test</span>, </span><span class="param"><span class="n">fe_trial</span>, </span><span class="param"><span class="n">trafo</span>, </span><span class="param"><span class="n">intrule</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SUPGIntegral.compute_element_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SUPGIntegral.compute_element_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SUPGIntegral.compute_element_matrix-416"><a href="#SUPGIntegral.compute_element_matrix-416"><span class="linenos">416</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SUPGIntegral.compute_element_matrix-417"><a href="#SUPGIntegral.compute_element_matrix-417"><span class="linenos">417</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the SUPG stabilization matrix.</span>
</span><span id="SUPGIntegral.compute_element_matrix-418"><a href="#SUPGIntegral.compute_element_matrix-418"><span class="linenos">418</span></a>
</span><span id="SUPGIntegral.compute_element_matrix-419"><a href="#SUPGIntegral.compute_element_matrix-419"><span class="linenos">419</span></a><span class="sd">        The SUPG (streamline upwind Petrov-Galerkin) stabilization</span>
</span><span id="SUPGIntegral.compute_element_matrix-420"><a href="#SUPGIntegral.compute_element_matrix-420"><span class="linenos">420</span></a><span class="sd">        implemented here computes, per element K, a stabilizing term</span>
</span><span id="SUPGIntegral.compute_element_matrix-421"><a href="#SUPGIntegral.compute_element_matrix-421"><span class="linenos">421</span></a><span class="sd">            S_{ij} = \int_K \gamma_T(x) \; (w\cdot\nabla\phi_i) \; (w\cdot\nabla\phi_j) \; dx</span>
</span><span id="SUPGIntegral.compute_element_matrix-422"><a href="#SUPGIntegral.compute_element_matrix-422"><span class="linenos">422</span></a>
</span><span id="SUPGIntegral.compute_element_matrix-423"><a href="#SUPGIntegral.compute_element_matrix-423"><span class="linenos">423</span></a><span class="sd">        where gamma_T is a stabilization parameter depending on the</span>
</span><span id="SUPGIntegral.compute_element_matrix-424"><a href="#SUPGIntegral.compute_element_matrix-424"><span class="linenos">424</span></a><span class="sd">        local mesh size and the velocity w. The method maps reference</span>
</span><span id="SUPGIntegral.compute_element_matrix-425"><a href="#SUPGIntegral.compute_element_matrix-425"><span class="linenos">425</span></a><span class="sd">        gradients to physical gradients, computes the directional</span>
</span><span id="SUPGIntegral.compute_element_matrix-426"><a href="#SUPGIntegral.compute_element_matrix-426"><span class="linenos">426</span></a><span class="sd">        derivatives along w and assembles the weighted inner product.</span>
</span><span id="SUPGIntegral.compute_element_matrix-427"><a href="#SUPGIntegral.compute_element_matrix-427"><span class="linenos">427</span></a>
</span><span id="SUPGIntegral.compute_element_matrix-428"><a href="#SUPGIntegral.compute_element_matrix-428"><span class="linenos">428</span></a><span class="sd">        Parameters</span>
</span><span id="SUPGIntegral.compute_element_matrix-429"><a href="#SUPGIntegral.compute_element_matrix-429"><span class="linenos">429</span></a><span class="sd">        ----------</span>
</span><span id="SUPGIntegral.compute_element_matrix-430"><a href="#SUPGIntegral.compute_element_matrix-430"><span class="linenos">430</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="SUPGIntegral.compute_element_matrix-431"><a href="#SUPGIntegral.compute_element_matrix-431"><span class="linenos">431</span></a><span class="sd">            Test and trial finite element descriptors (both with</span>
</span><span id="SUPGIntegral.compute_element_matrix-432"><a href="#SUPGIntegral.compute_element_matrix-432"><span class="linenos">432</span></a><span class="sd">            derivative evaluations required).</span>
</span><span id="SUPGIntegral.compute_element_matrix-433"><a href="#SUPGIntegral.compute_element_matrix-433"><span class="linenos">433</span></a><span class="sd">        trafo : object</span>
</span><span id="SUPGIntegral.compute_element_matrix-434"><a href="#SUPGIntegral.compute_element_matrix-434"><span class="linenos">434</span></a><span class="sd">            Transformation providing Jacobians and mesh metadata.</span>
</span><span id="SUPGIntegral.compute_element_matrix-435"><a href="#SUPGIntegral.compute_element_matrix-435"><span class="linenos">435</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="SUPGIntegral.compute_element_matrix-436"><a href="#SUPGIntegral.compute_element_matrix-436"><span class="linenos">436</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="SUPGIntegral.compute_element_matrix-437"><a href="#SUPGIntegral.compute_element_matrix-437"><span class="linenos">437</span></a>
</span><span id="SUPGIntegral.compute_element_matrix-438"><a href="#SUPGIntegral.compute_element_matrix-438"><span class="linenos">438</span></a><span class="sd">        Returns</span>
</span><span id="SUPGIntegral.compute_element_matrix-439"><a href="#SUPGIntegral.compute_element_matrix-439"><span class="linenos">439</span></a><span class="sd">        -------</span>
</span><span id="SUPGIntegral.compute_element_matrix-440"><a href="#SUPGIntegral.compute_element_matrix-440"><span class="linenos">440</span></a><span class="sd">        ndarray</span>
</span><span id="SUPGIntegral.compute_element_matrix-441"><a href="#SUPGIntegral.compute_element_matrix-441"><span class="linenos">441</span></a><span class="sd">            Local SUPG stabilization matrix of shape (n_test, n_trial).</span>
</span><span id="SUPGIntegral.compute_element_matrix-442"><a href="#SUPGIntegral.compute_element_matrix-442"><span class="linenos">442</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SUPGIntegral.compute_element_matrix-443"><a href="#SUPGIntegral.compute_element_matrix-443"><span class="linenos">443</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SUPGIntegral.compute_element_matrix-444"><a href="#SUPGIntegral.compute_element_matrix-444"><span class="linenos">444</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="SUPGIntegral.compute_element_matrix-445"><a href="#SUPGIntegral.compute_element_matrix-445"><span class="linenos">445</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-446"><a href="#SUPGIntegral.compute_element_matrix-446"><span class="linenos">446</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-447"><a href="#SUPGIntegral.compute_element_matrix-447"><span class="linenos">447</span></a>        <span class="k">if</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SUPGIntegral.compute_element_matrix-448"><a href="#SUPGIntegral.compute_element_matrix-448"><span class="linenos">448</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)]])</span>
</span><span id="SUPGIntegral.compute_element_matrix-449"><a href="#SUPGIntegral.compute_element_matrix-449"><span class="linenos">449</span></a>        <span class="k">elif</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="SUPGIntegral.compute_element_matrix-450"><a href="#SUPGIntegral.compute_element_matrix-450"><span class="linenos">450</span></a>            <span class="n">M</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">**-</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="SUPGIntegral.compute_element_matrix-451"><a href="#SUPGIntegral.compute_element_matrix-451"><span class="linenos">451</span></a>    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGIntegral.compute_element_matrix-452"><a href="#SUPGIntegral.compute_element_matrix-452"><span class="linenos">452</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGIntegral.compute_element_matrix-453"><a href="#SUPGIntegral.compute_element_matrix-453"><span class="linenos">453</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="SUPGIntegral.compute_element_matrix-454"><a href="#SUPGIntegral.compute_element_matrix-454"><span class="linenos">454</span></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
</span><span id="SUPGIntegral.compute_element_matrix-455"><a href="#SUPGIntegral.compute_element_matrix-455"><span class="linenos">455</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">special_meshsize</span>
</span><span id="SUPGIntegral.compute_element_matrix-456"><a href="#SUPGIntegral.compute_element_matrix-456"><span class="linenos">456</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-457"><a href="#SUPGIntegral.compute_element_matrix-457"><span class="linenos">457</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-458"><a href="#SUPGIntegral.compute_element_matrix-458"><span class="linenos">458</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-459"><a href="#SUPGIntegral.compute_element_matrix-459"><span class="linenos">459</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="SUPGIntegral.compute_element_matrix-460"><a href="#SUPGIntegral.compute_element_matrix-460"><span class="linenos">460</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="SUPGIntegral.compute_element_matrix-461"><a href="#SUPGIntegral.compute_element_matrix-461"><span class="linenos">461</span></a>        <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-462"><a href="#SUPGIntegral.compute_element_matrix-462"><span class="linenos">462</span></a>        <span class="n">cinv</span> <span class="o">=</span><span class="mi">1</span>
</span><span id="SUPGIntegral.compute_element_matrix-463"><a href="#SUPGIntegral.compute_element_matrix-463"><span class="linenos">463</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,jk-&gt;nik&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-464"><a href="#SUPGIntegral.compute_element_matrix-464"><span class="linenos">464</span></a>        <span class="n">expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,nkj-&gt;nik&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">invF</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-465"><a href="#SUPGIntegral.compute_element_matrix-465"><span class="linenos">465</span></a>        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ni,nij,nj-&gt;n&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">wind</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-466"><a href="#SUPGIntegral.compute_element_matrix-466"><span class="linenos">466</span></a>        <span class="n">gamma_T</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tau</span> <span class="o">+</span> <span class="p">(</span><span class="n">cinv</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-467"><a href="#SUPGIntegral.compute_element_matrix-467"><span class="linenos">467</span></a>
</span><span id="SUPGIntegral.compute_element_matrix-468"><a href="#SUPGIntegral.compute_element_matrix-468"><span class="linenos">468</span></a>        <span class="n">grad_u_phys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-469"><a href="#SUPGIntegral.compute_element_matrix-469"><span class="linenos">469</span></a>        <span class="n">grad_v_phys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-470"><a href="#SUPGIntegral.compute_element_matrix-470"><span class="linenos">470</span></a>
</span><span id="SUPGIntegral.compute_element_matrix-471"><a href="#SUPGIntegral.compute_element_matrix-471"><span class="linenos">471</span></a>        <span class="n">wind_grad_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">grad_u_phys</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-472"><a href="#SUPGIntegral.compute_element_matrix-472"><span class="linenos">472</span></a>        <span class="n">wind_grad_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nd,ndi-&gt;ni&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="n">grad_v_phys</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-473"><a href="#SUPGIntegral.compute_element_matrix-473"><span class="linenos">473</span></a>
</span><span id="SUPGIntegral.compute_element_matrix-474"><a href="#SUPGIntegral.compute_element_matrix-474"><span class="linenos">474</span></a>        <span class="n">scale</span> <span class="o">=</span> <span class="n">gamma_T</span> <span class="o">*</span> <span class="n">adetF</span> <span class="o">*</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>  <span class="c1"># (n,)</span>
</span><span id="SUPGIntegral.compute_element_matrix-475"><a href="#SUPGIntegral.compute_element_matrix-475"><span class="linenos">475</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;n,ni,nj-&gt;ij&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">wind_grad_u</span><span class="p">,</span> <span class="n">wind_grad_v</span><span class="p">)</span>
</span><span id="SUPGIntegral.compute_element_matrix-476"><a href="#SUPGIntegral.compute_element_matrix-476"><span class="linenos">476</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Compute the SUPG stabilization matrix.</p>

<pre><code>    The SUPG (streamline upwind Petrov-Galerkin) stabilization
    implemented here computes, per element K, a stabilizing term
        S_{ij} = \int_K \gamma_T(x) \; (w\cdot
</code></pre>

<p>abla\phi_i) \; (w\cdot
abla\phi_j) \; dx</p>

<pre><code>    where gamma_T is a stabilization parameter depending on the
    local mesh size and the velocity w. The method maps reference
    gradients to physical gradients, computes the directional
    derivatives along w and assembles the weighted inner product.

    Parameters
    ----------
    fe_test, fe_trial : FiniteElement
        Test and trial finite element descriptors (both with
        derivative evaluations required).
    trafo : object
        Transformation providing Jacobians and mesh metadata.
    intrule : IntegrationRule, optional
        Quadrature rule to use.

    Returns
    -------
    ndarray
        Local SUPG stabilization matrix of shape (n_test, n_trial).
</code></pre>
</div>


                            </div>
                </section>
                <section id="DivUQIntegrator">
                            <input id="DivUQIntegrator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DivUQIntegrator</span><wbr>(<span class="base"><a href="#BilinearFormIntegral">BilinearFormIntegral</a></span>):

                <label class="view-source-button" for="DivUQIntegrator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DivUQIntegrator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DivUQIntegrator-478"><a href="#DivUQIntegrator-478"><span class="linenos">478</span></a><span class="k">class</span><span class="w"> </span><span class="nc">DivUQIntegrator</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="DivUQIntegrator-479"><a href="#DivUQIntegrator-479"><span class="linenos">479</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="DivUQIntegrator-480"><a href="#DivUQIntegrator-480"><span class="linenos">480</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="DivUQIntegrator-481"><a href="#DivUQIntegrator-481"><span class="linenos">481</span></a>
</span><span id="DivUQIntegrator-482"><a href="#DivUQIntegrator-482"><span class="linenos">482</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DivUQIntegrator-483"><a href="#DivUQIntegrator-483"><span class="linenos">483</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble the coupling matrix for div(u) against a scalar test.</span>
</span><span id="DivUQIntegrator-484"><a href="#DivUQIntegrator-484"><span class="linenos">484</span></a>
</span><span id="DivUQIntegrator-485"><a href="#DivUQIntegrator-485"><span class="linenos">485</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="DivUQIntegrator-486"><a href="#DivUQIntegrator-486"><span class="linenos">486</span></a><span class="sd">            B_{ij} = \int_K q_i(x) \; (\nabla\cdot u_j(x)) \; dx</span>
</span><span id="DivUQIntegrator-487"><a href="#DivUQIntegrator-487"><span class="linenos">487</span></a>
</span><span id="DivUQIntegrator-488"><a href="#DivUQIntegrator-488"><span class="linenos">488</span></a><span class="sd">        Here q_i are scalar (pressure-like) test functions and u_j are</span>
</span><span id="DivUQIntegrator-489"><a href="#DivUQIntegrator-489"><span class="linenos">489</span></a><span class="sd">        vector-valued trial functions. The implementation computes</span>
</span><span id="DivUQIntegrator-490"><a href="#DivUQIntegrator-490"><span class="linenos">490</span></a><span class="sd">        physical gradients, forms the divergence of the vector trial</span>
</span><span id="DivUQIntegrator-491"><a href="#DivUQIntegrator-491"><span class="linenos">491</span></a><span class="sd">        basis and integrates against the scalar test basis.</span>
</span><span id="DivUQIntegrator-492"><a href="#DivUQIntegrator-492"><span class="linenos">492</span></a>
</span><span id="DivUQIntegrator-493"><a href="#DivUQIntegrator-493"><span class="linenos">493</span></a><span class="sd">        Parameters</span>
</span><span id="DivUQIntegrator-494"><a href="#DivUQIntegrator-494"><span class="linenos">494</span></a><span class="sd">        ----------</span>
</span><span id="DivUQIntegrator-495"><a href="#DivUQIntegrator-495"><span class="linenos">495</span></a><span class="sd">        fe_test : FiniteElement</span>
</span><span id="DivUQIntegrator-496"><a href="#DivUQIntegrator-496"><span class="linenos">496</span></a><span class="sd">            Scalar test element (q functions).</span>
</span><span id="DivUQIntegrator-497"><a href="#DivUQIntegrator-497"><span class="linenos">497</span></a><span class="sd">        fe_trial : FiniteElement</span>
</span><span id="DivUQIntegrator-498"><a href="#DivUQIntegrator-498"><span class="linenos">498</span></a><span class="sd">            Vector trial element (u functions) with derivatives.</span>
</span><span id="DivUQIntegrator-499"><a href="#DivUQIntegrator-499"><span class="linenos">499</span></a><span class="sd">        trafo : object</span>
</span><span id="DivUQIntegrator-500"><a href="#DivUQIntegrator-500"><span class="linenos">500</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="DivUQIntegrator-501"><a href="#DivUQIntegrator-501"><span class="linenos">501</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="DivUQIntegrator-502"><a href="#DivUQIntegrator-502"><span class="linenos">502</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="DivUQIntegrator-503"><a href="#DivUQIntegrator-503"><span class="linenos">503</span></a>
</span><span id="DivUQIntegrator-504"><a href="#DivUQIntegrator-504"><span class="linenos">504</span></a><span class="sd">        Returns</span>
</span><span id="DivUQIntegrator-505"><a href="#DivUQIntegrator-505"><span class="linenos">505</span></a><span class="sd">        -------</span>
</span><span id="DivUQIntegrator-506"><a href="#DivUQIntegrator-506"><span class="linenos">506</span></a><span class="sd">        ndarray</span>
</span><span id="DivUQIntegrator-507"><a href="#DivUQIntegrator-507"><span class="linenos">507</span></a><span class="sd">            Local coupling matrix between div(u) and q.</span>
</span><span id="DivUQIntegrator-508"><a href="#DivUQIntegrator-508"><span class="linenos">508</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DivUQIntegrator-509"><a href="#DivUQIntegrator-509"><span class="linenos">509</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DivUQIntegrator-510"><a href="#DivUQIntegrator-510"><span class="linenos">510</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="DivUQIntegrator-511"><a href="#DivUQIntegrator-511"><span class="linenos">511</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have same type&quot;</span><span class="p">)</span>
</span><span id="DivUQIntegrator-512"><a href="#DivUQIntegrator-512"><span class="linenos">512</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span><span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="DivUQIntegrator-513"><a href="#DivUQIntegrator-513"><span class="linenos">513</span></a>
</span><span id="DivUQIntegrator-514"><a href="#DivUQIntegrator-514"><span class="linenos">514</span></a>        <span class="n">shapes_q</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>  <span class="c1"># [n_qp, ndof_q]</span>
</span><span id="DivUQIntegrator-515"><a href="#DivUQIntegrator-515"><span class="linenos">515</span></a>        <span class="n">shapes_u_ref</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, ndof_u]</span>
</span><span id="DivUQIntegrator-516"><a href="#DivUQIntegrator-516"><span class="linenos">516</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>            <span class="c1"># [n_qp, dim, dim]</span>
</span><span id="DivUQIntegrator-517"><a href="#DivUQIntegrator-517"><span class="linenos">517</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="DivUQIntegrator-518"><a href="#DivUQIntegrator-518"><span class="linenos">518</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="DivUQIntegrator-519"><a href="#DivUQIntegrator-519"><span class="linenos">519</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="DivUQIntegrator-520"><a href="#DivUQIntegrator-520"><span class="linenos">520</span></a>        <span class="n">grad_u</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_u_ref</span><span class="p">)</span> 
</span><span id="DivUQIntegrator-521"><a href="#DivUQIntegrator-521"><span class="linenos">521</span></a>        <span class="n">div_u</span> <span class="o">=</span> <span class="n">grad_u</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="DivUQIntegrator-522"><a href="#DivUQIntegrator-522"><span class="linenos">522</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ik,il,i,i-&gt;kl&quot;</span><span class="p">,</span> <span class="n">shapes_q</span><span class="p">,</span> <span class="n">div_u</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="DivUQIntegrator-523"><a href="#DivUQIntegrator-523"><span class="linenos">523</span></a>
</span><span id="DivUQIntegrator-524"><a href="#DivUQIntegrator-524"><span class="linenos">524</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="DivUQIntegrator.__init__" class="classattr">
                                        <input id="DivUQIntegrator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DivUQIntegrator</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">coeff</span><span class="o">=&lt;</span><span class="n"><a href="meshfct.html#ConstantFunction">methodsnm.meshfct.ConstantFunction</a></span> <span class="nb">object</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="DivUQIntegrator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DivUQIntegrator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DivUQIntegrator.__init__-479"><a href="#DivUQIntegrator.__init__-479"><span class="linenos">479</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="DivUQIntegrator.__init__-480"><a href="#DivUQIntegrator.__init__-480"><span class="linenos">480</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span></pre></div>


    

                            </div>
                            <div id="DivUQIntegrator.coeff" class="classattr">
                                <div class="attr variable">
            <span class="name">coeff</span>

        
    </div>
    <a class="headerlink" href="#DivUQIntegrator.coeff"></a>
    
    

                            </div>
                            <div id="DivUQIntegrator.compute_element_matrix" class="classattr">
                                        <input id="DivUQIntegrator.compute_element_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe_test</span>, </span><span class="param"><span class="n">fe_trial</span>, </span><span class="param"><span class="n">trafo</span>, </span><span class="param"><span class="n">intrule</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DivUQIntegrator.compute_element_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DivUQIntegrator.compute_element_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DivUQIntegrator.compute_element_matrix-482"><a href="#DivUQIntegrator.compute_element_matrix-482"><span class="linenos">482</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DivUQIntegrator.compute_element_matrix-483"><a href="#DivUQIntegrator.compute_element_matrix-483"><span class="linenos">483</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble the coupling matrix for div(u) against a scalar test.</span>
</span><span id="DivUQIntegrator.compute_element_matrix-484"><a href="#DivUQIntegrator.compute_element_matrix-484"><span class="linenos">484</span></a>
</span><span id="DivUQIntegrator.compute_element_matrix-485"><a href="#DivUQIntegrator.compute_element_matrix-485"><span class="linenos">485</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="DivUQIntegrator.compute_element_matrix-486"><a href="#DivUQIntegrator.compute_element_matrix-486"><span class="linenos">486</span></a><span class="sd">            B_{ij} = \int_K q_i(x) \; (\nabla\cdot u_j(x)) \; dx</span>
</span><span id="DivUQIntegrator.compute_element_matrix-487"><a href="#DivUQIntegrator.compute_element_matrix-487"><span class="linenos">487</span></a>
</span><span id="DivUQIntegrator.compute_element_matrix-488"><a href="#DivUQIntegrator.compute_element_matrix-488"><span class="linenos">488</span></a><span class="sd">        Here q_i are scalar (pressure-like) test functions and u_j are</span>
</span><span id="DivUQIntegrator.compute_element_matrix-489"><a href="#DivUQIntegrator.compute_element_matrix-489"><span class="linenos">489</span></a><span class="sd">        vector-valued trial functions. The implementation computes</span>
</span><span id="DivUQIntegrator.compute_element_matrix-490"><a href="#DivUQIntegrator.compute_element_matrix-490"><span class="linenos">490</span></a><span class="sd">        physical gradients, forms the divergence of the vector trial</span>
</span><span id="DivUQIntegrator.compute_element_matrix-491"><a href="#DivUQIntegrator.compute_element_matrix-491"><span class="linenos">491</span></a><span class="sd">        basis and integrates against the scalar test basis.</span>
</span><span id="DivUQIntegrator.compute_element_matrix-492"><a href="#DivUQIntegrator.compute_element_matrix-492"><span class="linenos">492</span></a>
</span><span id="DivUQIntegrator.compute_element_matrix-493"><a href="#DivUQIntegrator.compute_element_matrix-493"><span class="linenos">493</span></a><span class="sd">        Parameters</span>
</span><span id="DivUQIntegrator.compute_element_matrix-494"><a href="#DivUQIntegrator.compute_element_matrix-494"><span class="linenos">494</span></a><span class="sd">        ----------</span>
</span><span id="DivUQIntegrator.compute_element_matrix-495"><a href="#DivUQIntegrator.compute_element_matrix-495"><span class="linenos">495</span></a><span class="sd">        fe_test : FiniteElement</span>
</span><span id="DivUQIntegrator.compute_element_matrix-496"><a href="#DivUQIntegrator.compute_element_matrix-496"><span class="linenos">496</span></a><span class="sd">            Scalar test element (q functions).</span>
</span><span id="DivUQIntegrator.compute_element_matrix-497"><a href="#DivUQIntegrator.compute_element_matrix-497"><span class="linenos">497</span></a><span class="sd">        fe_trial : FiniteElement</span>
</span><span id="DivUQIntegrator.compute_element_matrix-498"><a href="#DivUQIntegrator.compute_element_matrix-498"><span class="linenos">498</span></a><span class="sd">            Vector trial element (u functions) with derivatives.</span>
</span><span id="DivUQIntegrator.compute_element_matrix-499"><a href="#DivUQIntegrator.compute_element_matrix-499"><span class="linenos">499</span></a><span class="sd">        trafo : object</span>
</span><span id="DivUQIntegrator.compute_element_matrix-500"><a href="#DivUQIntegrator.compute_element_matrix-500"><span class="linenos">500</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="DivUQIntegrator.compute_element_matrix-501"><a href="#DivUQIntegrator.compute_element_matrix-501"><span class="linenos">501</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="DivUQIntegrator.compute_element_matrix-502"><a href="#DivUQIntegrator.compute_element_matrix-502"><span class="linenos">502</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="DivUQIntegrator.compute_element_matrix-503"><a href="#DivUQIntegrator.compute_element_matrix-503"><span class="linenos">503</span></a>
</span><span id="DivUQIntegrator.compute_element_matrix-504"><a href="#DivUQIntegrator.compute_element_matrix-504"><span class="linenos">504</span></a><span class="sd">        Returns</span>
</span><span id="DivUQIntegrator.compute_element_matrix-505"><a href="#DivUQIntegrator.compute_element_matrix-505"><span class="linenos">505</span></a><span class="sd">        -------</span>
</span><span id="DivUQIntegrator.compute_element_matrix-506"><a href="#DivUQIntegrator.compute_element_matrix-506"><span class="linenos">506</span></a><span class="sd">        ndarray</span>
</span><span id="DivUQIntegrator.compute_element_matrix-507"><a href="#DivUQIntegrator.compute_element_matrix-507"><span class="linenos">507</span></a><span class="sd">            Local coupling matrix between div(u) and q.</span>
</span><span id="DivUQIntegrator.compute_element_matrix-508"><a href="#DivUQIntegrator.compute_element_matrix-508"><span class="linenos">508</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DivUQIntegrator.compute_element_matrix-509"><a href="#DivUQIntegrator.compute_element_matrix-509"><span class="linenos">509</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DivUQIntegrator.compute_element_matrix-510"><a href="#DivUQIntegrator.compute_element_matrix-510"><span class="linenos">510</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="DivUQIntegrator.compute_element_matrix-511"><a href="#DivUQIntegrator.compute_element_matrix-511"><span class="linenos">511</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have same type&quot;</span><span class="p">)</span>
</span><span id="DivUQIntegrator.compute_element_matrix-512"><a href="#DivUQIntegrator.compute_element_matrix-512"><span class="linenos">512</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span><span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="DivUQIntegrator.compute_element_matrix-513"><a href="#DivUQIntegrator.compute_element_matrix-513"><span class="linenos">513</span></a>
</span><span id="DivUQIntegrator.compute_element_matrix-514"><a href="#DivUQIntegrator.compute_element_matrix-514"><span class="linenos">514</span></a>        <span class="n">shapes_q</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>  <span class="c1"># [n_qp, ndof_q]</span>
</span><span id="DivUQIntegrator.compute_element_matrix-515"><a href="#DivUQIntegrator.compute_element_matrix-515"><span class="linenos">515</span></a>        <span class="n">shapes_u_ref</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, ndof_u]</span>
</span><span id="DivUQIntegrator.compute_element_matrix-516"><a href="#DivUQIntegrator.compute_element_matrix-516"><span class="linenos">516</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>            <span class="c1"># [n_qp, dim, dim]</span>
</span><span id="DivUQIntegrator.compute_element_matrix-517"><a href="#DivUQIntegrator.compute_element_matrix-517"><span class="linenos">517</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="DivUQIntegrator.compute_element_matrix-518"><a href="#DivUQIntegrator.compute_element_matrix-518"><span class="linenos">518</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="DivUQIntegrator.compute_element_matrix-519"><a href="#DivUQIntegrator.compute_element_matrix-519"><span class="linenos">519</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="DivUQIntegrator.compute_element_matrix-520"><a href="#DivUQIntegrator.compute_element_matrix-520"><span class="linenos">520</span></a>        <span class="n">grad_u</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_u_ref</span><span class="p">)</span> 
</span><span id="DivUQIntegrator.compute_element_matrix-521"><a href="#DivUQIntegrator.compute_element_matrix-521"><span class="linenos">521</span></a>        <span class="n">div_u</span> <span class="o">=</span> <span class="n">grad_u</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="DivUQIntegrator.compute_element_matrix-522"><a href="#DivUQIntegrator.compute_element_matrix-522"><span class="linenos">522</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ik,il,i,i-&gt;kl&quot;</span><span class="p">,</span> <span class="n">shapes_q</span><span class="p">,</span> <span class="n">div_u</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="DivUQIntegrator.compute_element_matrix-523"><a href="#DivUQIntegrator.compute_element_matrix-523"><span class="linenos">523</span></a>
</span><span id="DivUQIntegrator.compute_element_matrix-524"><a href="#DivUQIntegrator.compute_element_matrix-524"><span class="linenos">524</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Assemble the coupling matrix for div(u) against a scalar test.</p>

<pre><code>    Weak formulation (element K):
        B_{ij} = \int_K q_i(x) \; (
</code></pre>

<p>abla\cdot u_j(x)) \; dx</p>

<pre><code>    Here q_i are scalar (pressure-like) test functions and u_j are
    vector-valued trial functions. The implementation computes
    physical gradients, forms the divergence of the vector trial
    basis and integrates against the scalar test basis.

    Parameters
    ----------
    fe_test : FiniteElement
        Scalar test element (q functions).
    fe_trial : FiniteElement
        Vector trial element (u functions) with derivatives.
    trafo : object
        Transformation providing Jacobian and mesh information.
    intrule : IntegrationRule, optional
        Quadrature rule to use.

    Returns
    -------
    ndarray
        Local coupling matrix between div(u) and q.
</code></pre>
</div>


                            </div>
                </section>
                <section id="DivVPIntegrator">
                            <input id="DivVPIntegrator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DivVPIntegrator</span><wbr>(<span class="base"><a href="#BilinearFormIntegral">BilinearFormIntegral</a></span>):

                <label class="view-source-button" for="DivVPIntegrator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DivVPIntegrator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DivVPIntegrator-526"><a href="#DivVPIntegrator-526"><span class="linenos">526</span></a><span class="k">class</span><span class="w"> </span><span class="nc">DivVPIntegrator</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="DivVPIntegrator-527"><a href="#DivVPIntegrator-527"><span class="linenos">527</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="DivVPIntegrator-528"><a href="#DivVPIntegrator-528"><span class="linenos">528</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span><span id="DivVPIntegrator-529"><a href="#DivVPIntegrator-529"><span class="linenos">529</span></a>
</span><span id="DivVPIntegrator-530"><a href="#DivVPIntegrator-530"><span class="linenos">530</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DivVPIntegrator-531"><a href="#DivVPIntegrator-531"><span class="linenos">531</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble coupling matrix for divergence of test velocity with pressure.</span>
</span><span id="DivVPIntegrator-532"><a href="#DivVPIntegrator-532"><span class="linenos">532</span></a>
</span><span id="DivVPIntegrator-533"><a href="#DivVPIntegrator-533"><span class="linenos">533</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="DivVPIntegrator-534"><a href="#DivVPIntegrator-534"><span class="linenos">534</span></a><span class="sd">            B_{ij} = \int_K (\nabla\cdot v_i(x)) \; p_j(x) \; dx</span>
</span><span id="DivVPIntegrator-535"><a href="#DivVPIntegrator-535"><span class="linenos">535</span></a>
</span><span id="DivVPIntegrator-536"><a href="#DivVPIntegrator-536"><span class="linenos">536</span></a><span class="sd">        This is the transpose-like counterpart to DivUQIntegrator and is</span>
</span><span id="DivVPIntegrator-537"><a href="#DivVPIntegrator-537"><span class="linenos">537</span></a><span class="sd">        used when assembling mixed formulations (e.g. velocity-pressure</span>
</span><span id="DivVPIntegrator-538"><a href="#DivVPIntegrator-538"><span class="linenos">538</span></a><span class="sd">        coupling in Stokes/NavierStokes). The code computes the</span>
</span><span id="DivVPIntegrator-539"><a href="#DivVPIntegrator-539"><span class="linenos">539</span></a><span class="sd">        divergence of (test) vector basis functions and integrates</span>
</span><span id="DivVPIntegrator-540"><a href="#DivVPIntegrator-540"><span class="linenos">540</span></a><span class="sd">        against scalar pressure trial basis functions.</span>
</span><span id="DivVPIntegrator-541"><a href="#DivVPIntegrator-541"><span class="linenos">541</span></a>
</span><span id="DivVPIntegrator-542"><a href="#DivVPIntegrator-542"><span class="linenos">542</span></a><span class="sd">        Parameters</span>
</span><span id="DivVPIntegrator-543"><a href="#DivVPIntegrator-543"><span class="linenos">543</span></a><span class="sd">        ----------</span>
</span><span id="DivVPIntegrator-544"><a href="#DivVPIntegrator-544"><span class="linenos">544</span></a><span class="sd">        fe_test : FiniteElement</span>
</span><span id="DivVPIntegrator-545"><a href="#DivVPIntegrator-545"><span class="linenos">545</span></a><span class="sd">            Vector-valued test element (v) with derivative evaluations.</span>
</span><span id="DivVPIntegrator-546"><a href="#DivVPIntegrator-546"><span class="linenos">546</span></a><span class="sd">        fe_trial : FiniteElement</span>
</span><span id="DivVPIntegrator-547"><a href="#DivVPIntegrator-547"><span class="linenos">547</span></a><span class="sd">            Scalar pressure trial element (p).</span>
</span><span id="DivVPIntegrator-548"><a href="#DivVPIntegrator-548"><span class="linenos">548</span></a><span class="sd">        trafo : object</span>
</span><span id="DivVPIntegrator-549"><a href="#DivVPIntegrator-549"><span class="linenos">549</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="DivVPIntegrator-550"><a href="#DivVPIntegrator-550"><span class="linenos">550</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="DivVPIntegrator-551"><a href="#DivVPIntegrator-551"><span class="linenos">551</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="DivVPIntegrator-552"><a href="#DivVPIntegrator-552"><span class="linenos">552</span></a>
</span><span id="DivVPIntegrator-553"><a href="#DivVPIntegrator-553"><span class="linenos">553</span></a><span class="sd">        Returns</span>
</span><span id="DivVPIntegrator-554"><a href="#DivVPIntegrator-554"><span class="linenos">554</span></a><span class="sd">        -------</span>
</span><span id="DivVPIntegrator-555"><a href="#DivVPIntegrator-555"><span class="linenos">555</span></a><span class="sd">        ndarray</span>
</span><span id="DivVPIntegrator-556"><a href="#DivVPIntegrator-556"><span class="linenos">556</span></a><span class="sd">            Local coupling matrix between div(v) and p.</span>
</span><span id="DivVPIntegrator-557"><a href="#DivVPIntegrator-557"><span class="linenos">557</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DivVPIntegrator-558"><a href="#DivVPIntegrator-558"><span class="linenos">558</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DivVPIntegrator-559"><a href="#DivVPIntegrator-559"><span class="linenos">559</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="DivVPIntegrator-560"><a href="#DivVPIntegrator-560"><span class="linenos">560</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have same type&quot;</span><span class="p">)</span>
</span><span id="DivVPIntegrator-561"><a href="#DivVPIntegrator-561"><span class="linenos">561</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span><span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="DivVPIntegrator-562"><a href="#DivVPIntegrator-562"><span class="linenos">562</span></a>
</span><span id="DivVPIntegrator-563"><a href="#DivVPIntegrator-563"><span class="linenos">563</span></a>        <span class="n">shapes_v</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span><span class="n">deriv</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [n_qp, ndof_v]</span>
</span><span id="DivVPIntegrator-564"><a href="#DivVPIntegrator-564"><span class="linenos">564</span></a>        <span class="n">shapes_p</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, ndof_q]</span>
</span><span id="DivVPIntegrator-565"><a href="#DivVPIntegrator-565"><span class="linenos">565</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>            <span class="c1"># [n_qp, dim, dim]</span>
</span><span id="DivVPIntegrator-566"><a href="#DivVPIntegrator-566"><span class="linenos">566</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="DivVPIntegrator-567"><a href="#DivVPIntegrator-567"><span class="linenos">567</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="DivVPIntegrator-568"><a href="#DivVPIntegrator-568"><span class="linenos">568</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="DivVPIntegrator-569"><a href="#DivVPIntegrator-569"><span class="linenos">569</span></a>        <span class="n">grad_v</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_v</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, ndof_q]</span>
</span><span id="DivVPIntegrator-570"><a href="#DivVPIntegrator-570"><span class="linenos">570</span></a>        <span class="n">div_v</span> <span class="o">=</span> <span class="n">grad_v</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [n_qp, ndof_q]</span>
</span><span id="DivVPIntegrator-571"><a href="#DivVPIntegrator-571"><span class="linenos">571</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;il,ik,i,i-&gt;lk&quot;</span><span class="p">,</span>   <span class="n">div_v</span> <span class="p">,</span> <span class="n">shapes_p</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="DivVPIntegrator-572"><a href="#DivVPIntegrator-572"><span class="linenos">572</span></a>
</span><span id="DivVPIntegrator-573"><a href="#DivVPIntegrator-573"><span class="linenos">573</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="DivVPIntegrator.__init__" class="classattr">
                                        <input id="DivVPIntegrator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DivVPIntegrator</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">coeff</span><span class="o">=&lt;</span><span class="n"><a href="meshfct.html#ConstantFunction">methodsnm.meshfct.ConstantFunction</a></span> <span class="nb">object</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="DivVPIntegrator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DivVPIntegrator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DivVPIntegrator.__init__-527"><a href="#DivVPIntegrator.__init__-527"><span class="linenos">527</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">ConstantFunction</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="DivVPIntegrator.__init__-528"><a href="#DivVPIntegrator.__init__-528"><span class="linenos">528</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
</span></pre></div>


    

                            </div>
                            <div id="DivVPIntegrator.coeff" class="classattr">
                                <div class="attr variable">
            <span class="name">coeff</span>

        
    </div>
    <a class="headerlink" href="#DivVPIntegrator.coeff"></a>
    
    

                            </div>
                            <div id="DivVPIntegrator.compute_element_matrix" class="classattr">
                                        <input id="DivVPIntegrator.compute_element_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe_test</span>, </span><span class="param"><span class="n">fe_trial</span>, </span><span class="param"><span class="n">trafo</span>, </span><span class="param"><span class="n">intrule</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DivVPIntegrator.compute_element_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DivVPIntegrator.compute_element_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DivVPIntegrator.compute_element_matrix-530"><a href="#DivVPIntegrator.compute_element_matrix-530"><span class="linenos">530</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DivVPIntegrator.compute_element_matrix-531"><a href="#DivVPIntegrator.compute_element_matrix-531"><span class="linenos">531</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble coupling matrix for divergence of test velocity with pressure.</span>
</span><span id="DivVPIntegrator.compute_element_matrix-532"><a href="#DivVPIntegrator.compute_element_matrix-532"><span class="linenos">532</span></a>
</span><span id="DivVPIntegrator.compute_element_matrix-533"><a href="#DivVPIntegrator.compute_element_matrix-533"><span class="linenos">533</span></a><span class="sd">        Weak formulation (element K):</span>
</span><span id="DivVPIntegrator.compute_element_matrix-534"><a href="#DivVPIntegrator.compute_element_matrix-534"><span class="linenos">534</span></a><span class="sd">            B_{ij} = \int_K (\nabla\cdot v_i(x)) \; p_j(x) \; dx</span>
</span><span id="DivVPIntegrator.compute_element_matrix-535"><a href="#DivVPIntegrator.compute_element_matrix-535"><span class="linenos">535</span></a>
</span><span id="DivVPIntegrator.compute_element_matrix-536"><a href="#DivVPIntegrator.compute_element_matrix-536"><span class="linenos">536</span></a><span class="sd">        This is the transpose-like counterpart to DivUQIntegrator and is</span>
</span><span id="DivVPIntegrator.compute_element_matrix-537"><a href="#DivVPIntegrator.compute_element_matrix-537"><span class="linenos">537</span></a><span class="sd">        used when assembling mixed formulations (e.g. velocity-pressure</span>
</span><span id="DivVPIntegrator.compute_element_matrix-538"><a href="#DivVPIntegrator.compute_element_matrix-538"><span class="linenos">538</span></a><span class="sd">        coupling in Stokes/NavierStokes). The code computes the</span>
</span><span id="DivVPIntegrator.compute_element_matrix-539"><a href="#DivVPIntegrator.compute_element_matrix-539"><span class="linenos">539</span></a><span class="sd">        divergence of (test) vector basis functions and integrates</span>
</span><span id="DivVPIntegrator.compute_element_matrix-540"><a href="#DivVPIntegrator.compute_element_matrix-540"><span class="linenos">540</span></a><span class="sd">        against scalar pressure trial basis functions.</span>
</span><span id="DivVPIntegrator.compute_element_matrix-541"><a href="#DivVPIntegrator.compute_element_matrix-541"><span class="linenos">541</span></a>
</span><span id="DivVPIntegrator.compute_element_matrix-542"><a href="#DivVPIntegrator.compute_element_matrix-542"><span class="linenos">542</span></a><span class="sd">        Parameters</span>
</span><span id="DivVPIntegrator.compute_element_matrix-543"><a href="#DivVPIntegrator.compute_element_matrix-543"><span class="linenos">543</span></a><span class="sd">        ----------</span>
</span><span id="DivVPIntegrator.compute_element_matrix-544"><a href="#DivVPIntegrator.compute_element_matrix-544"><span class="linenos">544</span></a><span class="sd">        fe_test : FiniteElement</span>
</span><span id="DivVPIntegrator.compute_element_matrix-545"><a href="#DivVPIntegrator.compute_element_matrix-545"><span class="linenos">545</span></a><span class="sd">            Vector-valued test element (v) with derivative evaluations.</span>
</span><span id="DivVPIntegrator.compute_element_matrix-546"><a href="#DivVPIntegrator.compute_element_matrix-546"><span class="linenos">546</span></a><span class="sd">        fe_trial : FiniteElement</span>
</span><span id="DivVPIntegrator.compute_element_matrix-547"><a href="#DivVPIntegrator.compute_element_matrix-547"><span class="linenos">547</span></a><span class="sd">            Scalar pressure trial element (p).</span>
</span><span id="DivVPIntegrator.compute_element_matrix-548"><a href="#DivVPIntegrator.compute_element_matrix-548"><span class="linenos">548</span></a><span class="sd">        trafo : object</span>
</span><span id="DivVPIntegrator.compute_element_matrix-549"><a href="#DivVPIntegrator.compute_element_matrix-549"><span class="linenos">549</span></a><span class="sd">            Transformation providing Jacobian and mesh information.</span>
</span><span id="DivVPIntegrator.compute_element_matrix-550"><a href="#DivVPIntegrator.compute_element_matrix-550"><span class="linenos">550</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="DivVPIntegrator.compute_element_matrix-551"><a href="#DivVPIntegrator.compute_element_matrix-551"><span class="linenos">551</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="DivVPIntegrator.compute_element_matrix-552"><a href="#DivVPIntegrator.compute_element_matrix-552"><span class="linenos">552</span></a>
</span><span id="DivVPIntegrator.compute_element_matrix-553"><a href="#DivVPIntegrator.compute_element_matrix-553"><span class="linenos">553</span></a><span class="sd">        Returns</span>
</span><span id="DivVPIntegrator.compute_element_matrix-554"><a href="#DivVPIntegrator.compute_element_matrix-554"><span class="linenos">554</span></a><span class="sd">        -------</span>
</span><span id="DivVPIntegrator.compute_element_matrix-555"><a href="#DivVPIntegrator.compute_element_matrix-555"><span class="linenos">555</span></a><span class="sd">        ndarray</span>
</span><span id="DivVPIntegrator.compute_element_matrix-556"><a href="#DivVPIntegrator.compute_element_matrix-556"><span class="linenos">556</span></a><span class="sd">            Local coupling matrix between div(v) and p.</span>
</span><span id="DivVPIntegrator.compute_element_matrix-557"><a href="#DivVPIntegrator.compute_element_matrix-557"><span class="linenos">557</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DivVPIntegrator.compute_element_matrix-558"><a href="#DivVPIntegrator.compute_element_matrix-558"><span class="linenos">558</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DivVPIntegrator.compute_element_matrix-559"><a href="#DivVPIntegrator.compute_element_matrix-559"><span class="linenos">559</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="DivVPIntegrator.compute_element_matrix-560"><a href="#DivVPIntegrator.compute_element_matrix-560"><span class="linenos">560</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have same type&quot;</span><span class="p">)</span>
</span><span id="DivVPIntegrator.compute_element_matrix-561"><a href="#DivVPIntegrator.compute_element_matrix-561"><span class="linenos">561</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span><span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span><span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span><span class="p">)</span>
</span><span id="DivVPIntegrator.compute_element_matrix-562"><a href="#DivVPIntegrator.compute_element_matrix-562"><span class="linenos">562</span></a>
</span><span id="DivVPIntegrator.compute_element_matrix-563"><a href="#DivVPIntegrator.compute_element_matrix-563"><span class="linenos">563</span></a>        <span class="n">shapes_v</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span><span class="n">deriv</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [n_qp, ndof_v]</span>
</span><span id="DivVPIntegrator.compute_element_matrix-564"><a href="#DivVPIntegrator.compute_element_matrix-564"><span class="linenos">564</span></a>        <span class="n">shapes_p</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, ndof_q]</span>
</span><span id="DivVPIntegrator.compute_element_matrix-565"><a href="#DivVPIntegrator.compute_element_matrix-565"><span class="linenos">565</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>            <span class="c1"># [n_qp, dim, dim]</span>
</span><span id="DivVPIntegrator.compute_element_matrix-566"><a href="#DivVPIntegrator.compute_element_matrix-566"><span class="linenos">566</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="DivVPIntegrator.compute_element_matrix-567"><a href="#DivVPIntegrator.compute_element_matrix-567"><span class="linenos">567</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="DivVPIntegrator.compute_element_matrix-568"><a href="#DivVPIntegrator.compute_element_matrix-568"><span class="linenos">568</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="DivVPIntegrator.compute_element_matrix-569"><a href="#DivVPIntegrator.compute_element_matrix-569"><span class="linenos">569</span></a>        <span class="n">grad_v</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_v</span><span class="p">)</span>  <span class="c1"># [n_qp, dim, ndof_q]</span>
</span><span id="DivVPIntegrator.compute_element_matrix-570"><a href="#DivVPIntegrator.compute_element_matrix-570"><span class="linenos">570</span></a>        <span class="n">div_v</span> <span class="o">=</span> <span class="n">grad_v</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [n_qp, ndof_q]</span>
</span><span id="DivVPIntegrator.compute_element_matrix-571"><a href="#DivVPIntegrator.compute_element_matrix-571"><span class="linenos">571</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;il,ik,i,i-&gt;lk&quot;</span><span class="p">,</span>   <span class="n">div_v</span> <span class="p">,</span> <span class="n">shapes_p</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="DivVPIntegrator.compute_element_matrix-572"><a href="#DivVPIntegrator.compute_element_matrix-572"><span class="linenos">572</span></a>
</span><span id="DivVPIntegrator.compute_element_matrix-573"><a href="#DivVPIntegrator.compute_element_matrix-573"><span class="linenos">573</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Assemble coupling matrix for divergence of test velocity with pressure.</p>

<pre><code>    Weak formulation (element K):
        B_{ij} = \int_K (
</code></pre>

<p>abla\cdot v_i(x)) \; p_j(x) \; dx</p>

<pre><code>    This is the transpose-like counterpart to DivUQIntegrator and is
    used when assembling mixed formulations (e.g. velocity-pressure
    coupling in Stokes/NavierStokes). The code computes the
    divergence of (test) vector basis functions and integrates
    against scalar pressure trial basis functions.

    Parameters
    ----------
    fe_test : FiniteElement
        Vector-valued test element (v) with derivative evaluations.
    fe_trial : FiniteElement
        Scalar pressure trial element (p).
    trafo : object
        Transformation providing Jacobian and mesh information.
    intrule : IntegrationRule, optional
        Quadrature rule to use.

    Returns
    -------
    ndarray
        Local coupling matrix between div(v) and p.
</code></pre>
</div>


                            </div>
                </section>
                <section id="PressureStabilizationIntegral">
                            <input id="PressureStabilizationIntegral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PressureStabilizationIntegral</span><wbr>(<span class="base"><a href="#BilinearFormIntegral">BilinearFormIntegral</a></span>):

                <label class="view-source-button" for="PressureStabilizationIntegral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PressureStabilizationIntegral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PressureStabilizationIntegral-575"><a href="#PressureStabilizationIntegral-575"><span class="linenos">575</span></a><span class="k">class</span><span class="w"> </span><span class="nc">PressureStabilizationIntegral</span><span class="p">(</span><span class="n">BilinearFormIntegral</span><span class="p">):</span>
</span><span id="PressureStabilizationIntegral-576"><a href="#PressureStabilizationIntegral-576"><span class="linenos">576</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PressureStabilizationIntegral-577"><a href="#PressureStabilizationIntegral-577"><span class="linenos">577</span></a><span class="sd">    Simple pressure-gradient stabilization:</span>
</span><span id="PressureStabilizationIntegral-578"><a href="#PressureStabilizationIntegral-578"><span class="linenos">578</span></a><span class="sd">        s(p, q) = delta * (p, q)</span>
</span><span id="PressureStabilizationIntegral-579"><a href="#PressureStabilizationIntegral-579"><span class="linenos">579</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PressureStabilizationIntegral-580"><a href="#PressureStabilizationIntegral-580"><span class="linenos">580</span></a>
</span><span id="PressureStabilizationIntegral-581"><a href="#PressureStabilizationIntegral-581"><span class="linenos">581</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
</span><span id="PressureStabilizationIntegral-582"><a href="#PressureStabilizationIntegral-582"><span class="linenos">582</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
</span><span id="PressureStabilizationIntegral-583"><a href="#PressureStabilizationIntegral-583"><span class="linenos">583</span></a>
</span><span id="PressureStabilizationIntegral-584"><a href="#PressureStabilizationIntegral-584"><span class="linenos">584</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PressureStabilizationIntegral-585"><a href="#PressureStabilizationIntegral-585"><span class="linenos">585</span></a>        <span class="c1"># EXACT same structure as LaplaceIntegral_without_time, but with coeff = delta</span>
</span><span id="PressureStabilizationIntegral-586"><a href="#PressureStabilizationIntegral-586"><span class="linenos">586</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PressureStabilizationIntegral-587"><a href="#PressureStabilizationIntegral-587"><span class="linenos">587</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="PressureStabilizationIntegral-588"><a href="#PressureStabilizationIntegral-588"><span class="linenos">588</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="PressureStabilizationIntegral-589"><a href="#PressureStabilizationIntegral-589"><span class="linenos">589</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span>
</span><span id="PressureStabilizationIntegral-590"><a href="#PressureStabilizationIntegral-590"><span class="linenos">590</span></a>                <span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
</span><span id="PressureStabilizationIntegral-591"><a href="#PressureStabilizationIntegral-591"><span class="linenos">591</span></a>                <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span>
</span><span id="PressureStabilizationIntegral-592"><a href="#PressureStabilizationIntegral-592"><span class="linenos">592</span></a>            <span class="p">)</span>
</span><span id="PressureStabilizationIntegral-593"><a href="#PressureStabilizationIntegral-593"><span class="linenos">593</span></a>
</span><span id="PressureStabilizationIntegral-594"><a href="#PressureStabilizationIntegral-594"><span class="linenos">594</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute pressure stabilization matrix.</span>
</span><span id="PressureStabilizationIntegral-595"><a href="#PressureStabilizationIntegral-595"><span class="linenos">595</span></a>
</span><span id="PressureStabilizationIntegral-596"><a href="#PressureStabilizationIntegral-596"><span class="linenos">596</span></a><span class="sd">        Implements s(p,q) = delta * \int_K \nabla p \cdot \nabla q \; dx</span>
</span><span id="PressureStabilizationIntegral-597"><a href="#PressureStabilizationIntegral-597"><span class="linenos">597</span></a><span class="sd">        but returns the scaled and (negatively) stabilized version used</span>
</span><span id="PressureStabilizationIntegral-598"><a href="#PressureStabilizationIntegral-598"><span class="linenos">598</span></a><span class="sd">        in the code (-h^2 * s(p,q)) where h is the local mesh size.</span>
</span><span id="PressureStabilizationIntegral-599"><a href="#PressureStabilizationIntegral-599"><span class="linenos">599</span></a>
</span><span id="PressureStabilizationIntegral-600"><a href="#PressureStabilizationIntegral-600"><span class="linenos">600</span></a><span class="sd">        Parameters</span>
</span><span id="PressureStabilizationIntegral-601"><a href="#PressureStabilizationIntegral-601"><span class="linenos">601</span></a><span class="sd">        ----------</span>
</span><span id="PressureStabilizationIntegral-602"><a href="#PressureStabilizationIntegral-602"><span class="linenos">602</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="PressureStabilizationIntegral-603"><a href="#PressureStabilizationIntegral-603"><span class="linenos">603</span></a><span class="sd">            Scalar finite element descriptors for pressure test and trial.</span>
</span><span id="PressureStabilizationIntegral-604"><a href="#PressureStabilizationIntegral-604"><span class="linenos">604</span></a><span class="sd">        trafo : object</span>
</span><span id="PressureStabilizationIntegral-605"><a href="#PressureStabilizationIntegral-605"><span class="linenos">605</span></a><span class="sd">            Transformation providing Jacobian and mesh metadata.</span>
</span><span id="PressureStabilizationIntegral-606"><a href="#PressureStabilizationIntegral-606"><span class="linenos">606</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="PressureStabilizationIntegral-607"><a href="#PressureStabilizationIntegral-607"><span class="linenos">607</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="PressureStabilizationIntegral-608"><a href="#PressureStabilizationIntegral-608"><span class="linenos">608</span></a>
</span><span id="PressureStabilizationIntegral-609"><a href="#PressureStabilizationIntegral-609"><span class="linenos">609</span></a><span class="sd">        Returns</span>
</span><span id="PressureStabilizationIntegral-610"><a href="#PressureStabilizationIntegral-610"><span class="linenos">610</span></a><span class="sd">        -------</span>
</span><span id="PressureStabilizationIntegral-611"><a href="#PressureStabilizationIntegral-611"><span class="linenos">611</span></a><span class="sd">        ndarray</span>
</span><span id="PressureStabilizationIntegral-612"><a href="#PressureStabilizationIntegral-612"><span class="linenos">612</span></a><span class="sd">            Local stabilization matrix for the pressure space.</span>
</span><span id="PressureStabilizationIntegral-613"><a href="#PressureStabilizationIntegral-613"><span class="linenos">613</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PressureStabilizationIntegral-614"><a href="#PressureStabilizationIntegral-614"><span class="linenos">614</span></a>
</span><span id="PressureStabilizationIntegral-615"><a href="#PressureStabilizationIntegral-615"><span class="linenos">615</span></a>        <span class="c1"># Values / gradients of basis</span>
</span><span id="PressureStabilizationIntegral-616"><a href="#PressureStabilizationIntegral-616"><span class="linenos">616</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># (n_qp, dim, ndof)</span>
</span><span id="PressureStabilizationIntegral-617"><a href="#PressureStabilizationIntegral-617"><span class="linenos">617</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PressureStabilizationIntegral-618"><a href="#PressureStabilizationIntegral-618"><span class="linenos">618</span></a>
</span><span id="PressureStabilizationIntegral-619"><a href="#PressureStabilizationIntegral-619"><span class="linenos">619</span></a>        <span class="c1"># Geometry</span>
</span><span id="PressureStabilizationIntegral-620"><a href="#PressureStabilizationIntegral-620"><span class="linenos">620</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="PressureStabilizationIntegral-621"><a href="#PressureStabilizationIntegral-621"><span class="linenos">621</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="PressureStabilizationIntegral-622"><a href="#PressureStabilizationIntegral-622"><span class="linenos">622</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="PressureStabilizationIntegral-623"><a href="#PressureStabilizationIntegral-623"><span class="linenos">623</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="PressureStabilizationIntegral-624"><a href="#PressureStabilizationIntegral-624"><span class="linenos">624</span></a>
</span><span id="PressureStabilizationIntegral-625"><a href="#PressureStabilizationIntegral-625"><span class="linenos">625</span></a>        <span class="c1"># map reference gradients to physical gradients</span>
</span><span id="PressureStabilizationIntegral-626"><a href="#PressureStabilizationIntegral-626"><span class="linenos">626</span></a>        <span class="n">grad_test</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">)</span>       <span class="c1"># (n_qp, dim, ndof_test)</span>
</span><span id="PressureStabilizationIntegral-627"><a href="#PressureStabilizationIntegral-627"><span class="linenos">627</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span>  
</span><span id="PressureStabilizationIntegral-628"><a href="#PressureStabilizationIntegral-628"><span class="linenos">628</span></a>
</span><span id="PressureStabilizationIntegral-629"><a href="#PressureStabilizationIntegral-629"><span class="linenos">629</span></a>        <span class="c1"># contraction:  grad_test  grad_trial * |detJ| * w</span>
</span><span id="PressureStabilizationIntegral-630"><a href="#PressureStabilizationIntegral-630"><span class="linenos">630</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ndk,ndl,n,n-&gt;kl&quot;</span><span class="p">,</span>
</span><span id="PressureStabilizationIntegral-631"><a href="#PressureStabilizationIntegral-631"><span class="linenos">631</span></a>                                   <span class="n">grad_test</span><span class="p">,</span> <span class="n">grad_trial</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="PressureStabilizationIntegral-632"><a href="#PressureStabilizationIntegral-632"><span class="linenos">632</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">special_meshsize</span>
</span><span id="PressureStabilizationIntegral-633"><a href="#PressureStabilizationIntegral-633"><span class="linenos">633</span></a>
</span><span id="PressureStabilizationIntegral-634"><a href="#PressureStabilizationIntegral-634"><span class="linenos">634</span></a>        <span class="k">return</span> <span class="o">-</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">ret</span>
</span></pre></div>


            <div class="docstring"><p>Simple pressure-gradient stabilization:
    s(p, q) = delta * (p, q)</p>
</div>


                            <div id="PressureStabilizationIntegral.__init__" class="classattr">
                                        <input id="PressureStabilizationIntegral.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">PressureStabilizationIntegral</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">delta</span><span class="o">=</span><span class="mf">1.0</span></span>)</span>

                <label class="view-source-button" for="PressureStabilizationIntegral.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PressureStabilizationIntegral.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PressureStabilizationIntegral.__init__-581"><a href="#PressureStabilizationIntegral.__init__-581"><span class="linenos">581</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
</span><span id="PressureStabilizationIntegral.__init__-582"><a href="#PressureStabilizationIntegral.__init__-582"><span class="linenos">582</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
</span></pre></div>


    

                            </div>
                            <div id="PressureStabilizationIntegral.delta" class="classattr">
                                <div class="attr variable">
            <span class="name">delta</span>

        
    </div>
    <a class="headerlink" href="#PressureStabilizationIntegral.delta"></a>
    
    

                            </div>
                            <div id="PressureStabilizationIntegral.compute_element_matrix" class="classattr">
                                        <input id="PressureStabilizationIntegral.compute_element_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_element_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fe_test</span>, </span><span class="param"><span class="n">fe_trial</span>, </span><span class="param"><span class="n">trafo</span>, </span><span class="param"><span class="n">intrule</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PressureStabilizationIntegral.compute_element_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PressureStabilizationIntegral.compute_element_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PressureStabilizationIntegral.compute_element_matrix-584"><a href="#PressureStabilizationIntegral.compute_element_matrix-584"><span class="linenos">584</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_element_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_test</span><span class="p">,</span> <span class="n">fe_trial</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="n">intrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-585"><a href="#PressureStabilizationIntegral.compute_element_matrix-585"><span class="linenos">585</span></a>        <span class="c1"># EXACT same structure as LaplaceIntegral_without_time, but with coeff = delta</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-586"><a href="#PressureStabilizationIntegral.compute_element_matrix-586"><span class="linenos">586</span></a>        <span class="k">if</span> <span class="n">intrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-587"><a href="#PressureStabilizationIntegral.compute_element_matrix-587"><span class="linenos">587</span></a>            <span class="k">if</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span> <span class="o">!=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">eltype</span><span class="p">:</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-588"><a href="#PressureStabilizationIntegral.compute_element_matrix-588"><span class="linenos">588</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Finite elements must have the same el. type&quot;</span><span class="p">)</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-589"><a href="#PressureStabilizationIntegral.compute_element_matrix-589"><span class="linenos">589</span></a>            <span class="n">intrule</span> <span class="o">=</span> <span class="n">select_integration_rule</span><span class="p">(</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-590"><a href="#PressureStabilizationIntegral.compute_element_matrix-590"><span class="linenos">590</span></a>                <span class="n">fe_test</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-591"><a href="#PressureStabilizationIntegral.compute_element_matrix-591"><span class="linenos">591</span></a>                <span class="n">fe_test</span><span class="o">.</span><span class="n">eltype</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-592"><a href="#PressureStabilizationIntegral.compute_element_matrix-592"><span class="linenos">592</span></a>            <span class="p">)</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-593"><a href="#PressureStabilizationIntegral.compute_element_matrix-593"><span class="linenos">593</span></a>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-594"><a href="#PressureStabilizationIntegral.compute_element_matrix-594"><span class="linenos">594</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute pressure stabilization matrix.</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-595"><a href="#PressureStabilizationIntegral.compute_element_matrix-595"><span class="linenos">595</span></a>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-596"><a href="#PressureStabilizationIntegral.compute_element_matrix-596"><span class="linenos">596</span></a><span class="sd">        Implements s(p,q) = delta * \int_K \nabla p \cdot \nabla q \; dx</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-597"><a href="#PressureStabilizationIntegral.compute_element_matrix-597"><span class="linenos">597</span></a><span class="sd">        but returns the scaled and (negatively) stabilized version used</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-598"><a href="#PressureStabilizationIntegral.compute_element_matrix-598"><span class="linenos">598</span></a><span class="sd">        in the code (-h^2 * s(p,q)) where h is the local mesh size.</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-599"><a href="#PressureStabilizationIntegral.compute_element_matrix-599"><span class="linenos">599</span></a>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-600"><a href="#PressureStabilizationIntegral.compute_element_matrix-600"><span class="linenos">600</span></a><span class="sd">        Parameters</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-601"><a href="#PressureStabilizationIntegral.compute_element_matrix-601"><span class="linenos">601</span></a><span class="sd">        ----------</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-602"><a href="#PressureStabilizationIntegral.compute_element_matrix-602"><span class="linenos">602</span></a><span class="sd">        fe_test, fe_trial : FiniteElement</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-603"><a href="#PressureStabilizationIntegral.compute_element_matrix-603"><span class="linenos">603</span></a><span class="sd">            Scalar finite element descriptors for pressure test and trial.</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-604"><a href="#PressureStabilizationIntegral.compute_element_matrix-604"><span class="linenos">604</span></a><span class="sd">        trafo : object</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-605"><a href="#PressureStabilizationIntegral.compute_element_matrix-605"><span class="linenos">605</span></a><span class="sd">            Transformation providing Jacobian and mesh metadata.</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-606"><a href="#PressureStabilizationIntegral.compute_element_matrix-606"><span class="linenos">606</span></a><span class="sd">        intrule : IntegrationRule, optional</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-607"><a href="#PressureStabilizationIntegral.compute_element_matrix-607"><span class="linenos">607</span></a><span class="sd">            Quadrature rule to use.</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-608"><a href="#PressureStabilizationIntegral.compute_element_matrix-608"><span class="linenos">608</span></a>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-609"><a href="#PressureStabilizationIntegral.compute_element_matrix-609"><span class="linenos">609</span></a><span class="sd">        Returns</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-610"><a href="#PressureStabilizationIntegral.compute_element_matrix-610"><span class="linenos">610</span></a><span class="sd">        -------</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-611"><a href="#PressureStabilizationIntegral.compute_element_matrix-611"><span class="linenos">611</span></a><span class="sd">        ndarray</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-612"><a href="#PressureStabilizationIntegral.compute_element_matrix-612"><span class="linenos">612</span></a><span class="sd">            Local stabilization matrix for the pressure space.</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-613"><a href="#PressureStabilizationIntegral.compute_element_matrix-613"><span class="linenos">613</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-614"><a href="#PressureStabilizationIntegral.compute_element_matrix-614"><span class="linenos">614</span></a>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-615"><a href="#PressureStabilizationIntegral.compute_element_matrix-615"><span class="linenos">615</span></a>        <span class="c1"># Values / gradients of basis</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-616"><a href="#PressureStabilizationIntegral.compute_element_matrix-616"><span class="linenos">616</span></a>        <span class="n">shapes_test</span> <span class="o">=</span> <span class="n">fe_test</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># (n_qp, dim, ndof)</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-617"><a href="#PressureStabilizationIntegral.compute_element_matrix-617"><span class="linenos">617</span></a>        <span class="n">shapes_trial</span> <span class="o">=</span> <span class="n">fe_trial</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-618"><a href="#PressureStabilizationIntegral.compute_element_matrix-618"><span class="linenos">618</span></a>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-619"><a href="#PressureStabilizationIntegral.compute_element_matrix-619"><span class="linenos">619</span></a>        <span class="c1"># Geometry</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-620"><a href="#PressureStabilizationIntegral.compute_element_matrix-620"><span class="linenos">620</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">intrule</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-621"><a href="#PressureStabilizationIntegral.compute_element_matrix-621"><span class="linenos">621</span></a>        <span class="n">invF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-622"><a href="#PressureStabilizationIntegral.compute_element_matrix-622"><span class="linenos">622</span></a>        <span class="n">adetF</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-623"><a href="#PressureStabilizationIntegral.compute_element_matrix-623"><span class="linenos">623</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">intrule</span><span class="o">.</span><span class="n">weights</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-624"><a href="#PressureStabilizationIntegral.compute_element_matrix-624"><span class="linenos">624</span></a>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-625"><a href="#PressureStabilizationIntegral.compute_element_matrix-625"><span class="linenos">625</span></a>        <span class="c1"># map reference gradients to physical gradients</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-626"><a href="#PressureStabilizationIntegral.compute_element_matrix-626"><span class="linenos">626</span></a>        <span class="n">grad_test</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_test</span><span class="p">)</span>       <span class="c1"># (n_qp, dim, ndof_test)</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-627"><a href="#PressureStabilizationIntegral.compute_element_matrix-627"><span class="linenos">627</span></a>        <span class="n">grad_trial</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,njb-&gt;nib&quot;</span><span class="p">,</span> <span class="n">invF</span><span class="p">,</span> <span class="n">shapes_trial</span><span class="p">)</span>  
</span><span id="PressureStabilizationIntegral.compute_element_matrix-628"><a href="#PressureStabilizationIntegral.compute_element_matrix-628"><span class="linenos">628</span></a>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-629"><a href="#PressureStabilizationIntegral.compute_element_matrix-629"><span class="linenos">629</span></a>        <span class="c1"># contraction:  grad_test  grad_trial * |detJ| * w</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-630"><a href="#PressureStabilizationIntegral.compute_element_matrix-630"><span class="linenos">630</span></a>        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ndk,ndl,n,n-&gt;kl&quot;</span><span class="p">,</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-631"><a href="#PressureStabilizationIntegral.compute_element_matrix-631"><span class="linenos">631</span></a>                                   <span class="n">grad_test</span><span class="p">,</span> <span class="n">grad_trial</span><span class="p">,</span> <span class="n">adetF</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-632"><a href="#PressureStabilizationIntegral.compute_element_matrix-632"><span class="linenos">632</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">trafo</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">special_meshsize</span>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-633"><a href="#PressureStabilizationIntegral.compute_element_matrix-633"><span class="linenos">633</span></a>
</span><span id="PressureStabilizationIntegral.compute_element_matrix-634"><a href="#PressureStabilizationIntegral.compute_element_matrix-634"><span class="linenos">634</span></a>        <span class="k">return</span> <span class="o">-</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">ret</span>
</span></pre></div>


    

                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>